<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4í•™ë…„ ê³¼í•™: ìƒíƒœê³„ì™€ ë¨¹ì´ê·¸ë¬¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        /* Jua í°íŠ¸ë¥¼ ê¸°ë³¸ í°íŠ¸ë¡œ ì„¤ì • */
        body {
            font-family: 'Jua', sans-serif;
            overscroll-behavior: none; /* ìŠ¤í¬ë¡¤ ë°”ìš´ìŠ¤ íš¨ê³¼ ì œê±° */
        }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        /* ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œ */
        .dragging {
            opacity: 0.6;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* ê²Œì„ ì˜ì—­ì˜ ìƒë¬¼ ì•„ì´í…œ */
        .creature {
            touch-action: none; /* ëª¨ë°”ì¼ í„°ì¹˜ ë“œë˜ê·¸ ì§€ì› */
            position: absolute;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            background-color: white;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            border: 2px solid transparent;
        }

        /* ìƒë¬¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œ í…Œë‘ë¦¬ */
        .creature.selected {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
            transform: scale(1.05);
        }

        /* *** ì¶”ê°€ëœ ìŠ¤íƒ€ì¼: ë“œë˜ê·¸ ë“œë¡­ ëŒ€ìƒ ê°•ì¡° *** */
        .creature.creature-target {
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); /* red-500 glow */
            border-color: #ef4444; /* red-500 border */
        }

        /* ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2rem 3rem;
            border-radius: 1.5rem;
            font-size: 8rem; /* í…ìŠ¤íŠ¸ í¬ê¸° í‚¤ì›€ */
            font-weight: bold;
            color: white;
            z-index: 200;
            opacity: 0;
            transition: all 0.3s ease-out;
            pointer-events: none; /* ë©”ì‹œì§€ ë°•ìŠ¤ê°€ í´ë¦­ ë°©í•´í•˜ì§€ ì•Šë„ë¡ */
        }

        #message-box.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* *** ìˆ˜ì •ëœ ë¶€ë¶„: ê²Œì„ ì•ˆë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ *** */
        #game-prompt {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            font-size: 1.5rem; /* í…ìŠ¤íŠ¸ í¬ê¸° í‚¤ì›€ */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            
            /* ìë™ ìˆ¨ê¹€ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
            opacity: 0;
            transition: opacity 0.5s ease-out;
            pointer-events: none; /* ìˆ¨ê²¨ì¡Œì„ ë•Œ í´ë¦­ ë°©í•´ ë°©ì§€ */
        }
        
        /* í”„ë¡¬í”„íŠ¸ ë³´ì´ê¸° í´ë˜ìŠ¤ */
        #game-prompt.show {
            opacity: 1;
            pointer-events: auto;
        }
        /* *** ìˆ˜ì • ë *** */


        /* í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
        .arrow-line {
            stroke: #1f2937; /* gray-800 */
            stroke-width: 3; /* ì„  êµµê¸° */
            opacity: 0.8;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-amber-50 h-screen w-screen overflow-hidden text-gray-800">

    <div id="app-container" class="h-full w-full">

        <div id="content-view" class="h-full w-full flex flex-col items-center justify-center p-4 md:p-12 transition-all duration-500">
            
            <header class="w-full max-w-5xl flex justify-between items-center mb-6 px-4">
                <h1 class="text-4xl md:text-5xl font-bold text-cyan-700">ìƒíƒœê³„ì™€ ë¨¹ì´ê·¸ë¬¼ ğŸŒ¿</h1>
                
                <div class="flex items-center space-x-2">
                    <span class="text-lg hidden md:inline">ê¸€ì”¨ í¬ê¸°:</span>
                    <button id="font-decrease" class="bg-white hover:bg-gray-100 shadow-md border border-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full text-2xl transition-transform transform hover:scale-110">-</button>
                    <button id="font-increase" class="bg-white hover:bg-gray-100 shadow-md border border-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full text-2xl transition-transform transform hover:scale-110">+</button>
                </div>
            </header>

            <main id="content-main" class="w-full max-w-5xl h-full bg-white bg-opacity-80 backdrop-blur-sm shadow-2xl rounded-2xl p-6 md:p-10 overflow-y-auto text-xl md:text-2xl leading-relaxed md:leading-loose transition-all duration-300">
                
                <h2 class="text-3xl md:text-4xl font-bold text-green-700 mb-4">ğŸŒ± ë¨¹ì´ì‚¬ìŠ¬ì´ë€ ë¬´ì—‡ì¼ê¹Œìš”?</h2>
                <p class="mb-8 pl-4 border-l-4 border-green-700">
                    ìƒíƒœê³„ì˜ ìƒë¬¼ë“¤ì€ ë¨¹ê³  ë¨¹íˆëŠ” ë¨¹ì´ ê´€ê³„ë¥¼ ë§ºìŠµë‹ˆë‹¤.
                    ì˜ˆë¥¼ ë“¤ì–´, ì°¸ìƒˆëŠ” ë²¼ë¥¼ ë¨¹ê³ , í™©ì¡°ë¡±ì´ëŠ” ì°¸ìƒˆë¥¼ ë¨¹ìŠµë‹ˆë‹¤.
                    ì´ì™€ ê°™ì´ <strong class="text-green-800">ìƒë¬¼ë“¤ì˜ ë¨¹ì´ ê´€ê³„ê°€ ì‚¬ìŠ¬ì²˜ëŸ¼ ì—°ê²°ë˜ì–´ ìˆëŠ” ê²ƒ</strong>ì„ <strong class="text-green-800">ë¨¹ì´ì‚¬ìŠ¬</strong>ì´ë¼ê³  í•©ë‹ˆë‹¤.
                </p>

                <h2 class="text-3xl md:text-4xl font-bold text-blue-700 mb-4">ğŸ•¸ï¸ ë¨¹ì´ê·¸ë¬¼ì´ë€ ë¬´ì—‡ì¼ê¹Œìš”?</h2>
                <p class="mb-8 pl-4 border-l-4 border-blue-700">
                    ì‹¤ì œ ìƒíƒœê³„ì—ì„œ ìƒë¬¼ì€ í•œ ê°€ì§€ ìƒë¬¼ë§Œ ë¨¹ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì—¬ëŸ¬ ìƒë¬¼ì„ ë¨¹ìŠµë‹ˆë‹¤.
                    ê·¸ë˜ì„œ <strong class="text-blue-800">ì—¬ëŸ¬ ê°œì˜ ë¨¹ì´ì‚¬ìŠ¬ì´ ì„œë¡œ ì–½í˜€ ê·¸ë¬¼ì²˜ëŸ¼ ë³µì¡í•˜ê²Œ ì—°ê²°</strong>ë©ë‹ˆë‹¤.
                    ì´ì™€ ê°™ì´ ë³µì¡í•œ ë¨¹ì´ ê´€ê³„ë¥¼ <strong class="text-blue-800">ë¨¹ì´ê·¸ë¬¼</strong>ì´ë¼ê³  í•©ë‹ˆë‹¤.
                </p>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <h3 class="text-2xl md:text-3xl font-bold text-center text-gray-700 mb-4">ìš°ë¦¬ ì£¼ë³€ì˜ ë¨¹ì´ê·¸ë¬¼ ì˜ˆì‹œ</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center text-lg md:text-xl">
                        <div class="bg-white p-3 rounded-lg shadow"><strong>ìƒì‚°ì (ì‹ë¬¼)</strong><br>ë²¼, ê°•ë‚­ì½©, ìœ ì±„</div>
                        <div class="bg-white p-3 rounded-lg shadow"><strong>1ì°¨ ì†Œë¹„ì (ì´ˆì‹)</strong><br>ë©”ëšœê¸°, ë°°ì¶”í°ë‚˜ë¹„, ì¥, ì°¸ìƒˆ</div>
                        <div class="bg-white p-3 rounded-lg shadow"><strong>2ì°¨ ì†Œë¹„ì (ìœ¡ì‹/ì¡ì‹)</strong><br>ê°œêµ¬ë¦¬, ì°¸ìƒˆ, ì¥</div> <div class="col-span-2 md:col-span-3 bg-white p-3 rounded-lg shadow"><strong>ìµœì¢… ì†Œë¹„ì (ìœ¡ì‹)</strong><br>í™©ì¡°ë¡±ì´ (ê°œêµ¬ë¦¬, ì°¸ìƒˆ, ì¥, ë©”ëšœê¸°, ë°°ì¶”í°ë‚˜ë¹„ ë“±ì„ ë¨¹ìŒ)</div> </div>
                </div>

            </main>

            <footer class="w-full max-w-5xl mt-6 px-4">
                <button id="start-game-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg text-2xl md:text-3xl transition-transform transform hover:scale-105 duration-300">
                    ğŸ® ë¨¹ì´ê·¸ë¬¼ ê²Œì„ ì‹œì‘í•˜ê¸°
                </button>
            </footer>

        </div>

        <div id="game-view" class="h-full w-full flex-col p-4 md:p-8 transition-all duration-500 hidden">
            
            <header class="w-full flex justify-between items-center mb-4">
                <button id="back-to-content-btn" class="bg-white hover:bg-gray-100 shadow-lg border border-gray-200 text-gray-700 font-bold py-3 px-6 rounded-full text-xl md:text-2xl transition-transform transform hover:scale-105">
                    &lt; í•™ìŠµìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">ë¨¹ì´ê·¸ë¬¼ ê²Œì„</h1>
                <div class="flex space-x-2">
                    <button id="show-all-arrows-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full text-lg md:text-xl shadow-md transition-transform transform hover:scale-105">ëª¨ë“  í™”ì‚´í‘œ ë³´ê¸°</button>
                    <button id="clear-arrows-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full text-lg md:text-xl shadow-md transition-transform transform hover:scale-105">í™”ì‚´í‘œ ì§€ìš°ê¸°</button>
                    <button id="reset-game-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-lg md:text-xl shadow-md transition-transform transform hover:scale-105">ì²˜ìŒ ìœ„ì¹˜ë¡œ</button>
                </div>
            </header>
 
            <main id="game-area" class="w-full flex-1 relative bg-white bg-opacity-50 backdrop-blur-sm rounded-lg shadow-inner overflow-hidden">
                
                <div id="game-prompt" class="absolute top-4 left-1/2 -translate-x-1/2 z-10 text-center">
                    </div>

                <svg id="arrow-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto" fill="#1f2937">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                    </defs>
                </svg>

                </main>
        </div>

    </div>

    <div id="message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM ìš”ì†Œ ì„ íƒ ---
            const contentView = document.getElementById('content-view');
            const gameView = document.getElementById('game-view');
            const startGameBtn = document.getElementById('start-game-btn');
            const backToContentBtn = document.getElementById('back-to-content-btn');
            
            const fontDecreaseBtn = document.getElementById('font-decrease');
            const fontIncreaseBtn = document.getElementById('font-increase');
            const contentMain = document.getElementById('content-main');
            
            const gameArea = document.getElementById('game-area');
            const arrowCanvas = document.getElementById('arrow-canvas');
            const showAllArrowsBtn = document.getElementById('show-all-arrows-btn');
            const clearArrowsBtn = document.getElementById('clear-arrows-btn');
            const resetGameBtn = document.getElementById('reset-game-btn'); // ë¦¬ì…‹ ë²„íŠ¼ ì¶”ê°€
            const messageBox = document.getElementById('message-box');
            const gamePrompt = document.getElementById('game-prompt');
 
            // --- ìƒíƒœ ë³€ìˆ˜ ---
            let currentFontSize = 1; // 0: small, 1: medium, 2: large
            const fontSizes = ['text-lg md:text-xl', 'text-xl md:text-2xl', 'text-2xl md:text-3xl', 'text-3xl md:text-4xl']; // í°íŠ¸ í¬ê¸° ë‹¨ê³„ ì¶”ê°€
            const fontLeadings = ['leading-relaxed md:leading-loose', 'leading-relaxed md:leading-loose', 'leading-relaxed md:leading-loose', 'leading-relaxed md:leading-loose']; // í°íŠ¸ í¬ê¸° ë‹¨ê³„ ì¶”ê°€
            
            let selectedCreatureId = null;
            let gameStep = 0; // 0: none selected, 1: find food, 2: find predator
            let drawnArrows = []; // { from: 'id', to: 'id' }
            let foundFood = new Set();
            let foundPredators = new Set();
            
            /* *** ì¶”ê°€ëœ ë¶€ë¶„: ê²Œì„ í”„ë¡¬í”„íŠ¸ íƒ€ì´ë¨¸ ë³€ìˆ˜ *** */
            let gamePromptTimer = null; 

            // --- ë“œë˜ê·¸ ìƒíƒœ ë³€ìˆ˜ ---
            let draggedElement = null;
            let isDragging = false;
            let offsetX, offsetY;
            let startX, startY;
            let currentTargetElement = null; // *** ì¶”ê°€: ë“œë¡­ ëŒ€ìƒ ê°•ì¡°ìš© ***

            // --- ìƒë¬¼ ë°ì´í„° ---
            // (ì›ë³¸ ìœ„ì¹˜ ë°ì´í„°ëŠ” ì ˆëŒ€ ìˆ˜ì •ë˜ì§€ ì•ŠìŒ)
            
            /* ************************************************
            *** ìˆ˜ì •ëœ ë¶€ë¶„: ìƒë¬¼ ë°ì´í„° (ë¨¹ì´ê·¸ë¬¼ ë¡œì§) ***
            ************************************************
            */
            const creatures = {
                // ìƒì‚°ì (Producers)
                'rice': { name: 'ë²¼', emoji: 'ğŸŒ¾', eats: [], eatenBy: ['grasshopper', 'mouse', 'sparrow'], pos: { x: 30, y: 80 } }, // 'butterfly' ì œê±°
                'bean': { name: 'ê°•ë‚­ì½©', emoji: 'ğŸŒ±', eats: [], eatenBy: ['grasshopper', 'mouse', 'sparrow'], pos: { x: 50, y: 80 } }, // 'butterfly' ì œê±°
                'rape': { name: 'ìœ ì±„', emoji: 'ğŸŒ¼', eats: [], eatenBy: ['mouse', 'butterfly', 'sparrow', 'grasshopper'], pos: { x: 70, y: 80 } },
                
                // 1ì°¨ ì†Œë¹„ì (Primary Consumers)
                'grasshopper': { name: 'ë©”ëšœê¸°', emoji: 'ğŸ¦—', eats: ['rice', 'bean', 'rape'], eatenBy: ['frog', 'sparrow', 'kestrel', 'mouse'], pos: { x: 20, y: 50 } }, // 'mouse' ì¶”ê°€
                'butterfly': { name: 'ë°°ì¶”í°ë‚˜ë¹„', emoji: 'ğŸ¦‹', eats: ['rape'], eatenBy: ['frog', 'sparrow', 'mouse', 'kestrel'], pos: { x: 80, y: 50 } }, // 'rape'ë§Œ ë¨¹ìŒ
                'mouse': { name: 'ì¥', emoji: 'ğŸ', eats: ['rice', 'bean', 'rape', 'grasshopper', 'butterfly'], eatenBy: ['kestrel'], pos: { x: 65, y: 35 } }, // 'grasshopper', 'butterfly' ì¶”ê°€
                
                // 2ì°¨ ì†Œë¹„ì (Secondary Consumers)
                'sparrow': { name: 'ì°¸ìƒˆ', emoji: 'ğŸ¦', eats: ['rice', 'bean', 'grasshopper', 'rape', 'butterfly'], eatenBy: ['kestrel'], pos: { x: 35, y: 30 } },
                'frog': { name: 'ê°œêµ¬ë¦¬', emoji: 'ğŸ¸', eats: ['grasshopper', 'butterfly'], eatenBy: ['kestrel'], pos: { x: 50, y: 55 } },

                // 3ì°¨ ì†Œë¹„ì (Tertiary Consumer)
                'kestrel': { name: 'í™©ì¡°ë¡±ì´', emoji: 'ğŸ¦…', eats: ['frog', 'sparrow', 'mouse', 'grasshopper', 'butterfly'], eatenBy: [], pos: { x: 50, y: 10 } } // 'butterfly' ì¶”ê°€
            };
            /* ************************************************
            *** ìˆ˜ì • ë ***
            ************************************************
            */


            // --- 1. ë·° ì „í™˜ ë¡œì§ ---
            startGameBtn.addEventListener('click', () => {
                contentView.classList.add('hidden');
                gameView.classList.remove('hidden');
                gameView.classList.add('flex');
                initializeGame();
            });

            backToContentBtn.addEventListener('click', () => {
                gameView.classList.add('hidden');
                gameView.classList.remove('flex');
                contentView.classList.remove('hidden');
                resetGame();
            });

            // --- 2. í°íŠ¸ í¬ê¸° ì¡°ì ˆ ë¡œì§ ---
            function updateFontSize() {
                fontSizes.forEach(clsString => {
                    contentMain.classList.remove(...clsString.split(' '));
                });
                fontLeadings.forEach(clsString => {
                    contentMain.classList.remove(...clsString.split(' '));
                });
                contentMain.classList.add(...fontSizes[currentFontSize].split(' '));
                contentMain.classList.add(...fontLeadings[currentFontSize].split(' '));
            }

            fontIncreaseBtn.addEventListener('click', () => {
                if (currentFontSize < fontSizes.length - 1) {
                    currentFontSize++;
                    updateFontSize();
                }
            });

            fontDecreaseBtn.addEventListener('click', () => {
                if (currentFontSize > 0) {
                    currentFontSize--;
                    updateFontSize();
                }
            });
            updateFontSize(); // ì´ˆê¸° ì„¤ì •

            // --- 3. ê²Œì„ ë¡œì§ ---

            // ê²Œì„ í—¤ë” ë²„íŠ¼ ì´ë²¤íŠ¸ (í•œ ë²ˆë§Œ ì„¤ì •)
            showAllArrowsBtn.addEventListener('click', showAllArrows);
            clearArrowsBtn.addEventListener('click', () => clearArrows(true));
            resetGameBtn.addEventListener('click', resetCreaturePositions);

            // ê²Œì„ ì´ˆê¸°í™” (ìƒë¬¼ ì•„ì´í…œ ìƒì„±)
            function initializeGame() {
                // ê¸°ì¡´ ìƒë¬¼ ì•„ì´í…œ(.creature)ë§Œ ì‚­ì œ
                gameArea.querySelectorAll('.creature').forEach(el => el.remove());
                // ê¸°ì¡´ í™”ì‚´í‘œ(<line>)ë§Œ ì‚­ì œ
                arrowCanvas.querySelectorAll('.arrow-line').forEach(line => line.remove());
                drawnArrows = []; // í™”ì‚´í‘œ ë°ì´í„° ë¦¬ì…‹
                resetGameStep(); // í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹
                
                Object.keys(creatures).forEach(id => {
                    const data = creatures[id];
                    const el = document.createElement('div');
                    el.className = 'creature';
                    el.dataset.id = id;
                    el.style.left = `${data.pos.x}%`;
                    el.style.top = `${data.pos.y}%`;
                    el.innerHTML = `
                        <span class="text-3xl md:text-4xl">${data.emoji}</span>
                        <span class="text-lg md:text-xl font-medium">${data.name}</span>
                    `;
                    
                    el.addEventListener('click', onCreatureClick);
                    
                    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (PC + Mobile)
                    el.addEventListener('mousedown', onDragStart);
                    el.addEventListener('touchstart', onDragStart, { passive: false });
                    
                    gameArea.appendChild(el);
                });

                // ë“œë¡­ ì˜ì—­ ì„¤ì • (document ì „ì²´)
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchend', onDragEnd);
            }
            
            // ìƒë¬¼ í´ë¦­ ì´ë²¤íŠ¸
            function onCreatureClick(e) {
                const clickedEl = e.currentTarget;
                const id = clickedEl.dataset.id;

                // ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì¼ ë•Œ (ì„ íƒëœ ìƒë¬¼ì´ ìˆì„ ë•Œ)
                if (gameStep > 0) {
                    // 1ë‹¨ê³„(ë¨¹ì´ ì°¾ê¸°)ì—ì„œ, ë§Œì•½ ì„ íƒëœ ìƒë¬¼ 'ìì‹ 'ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
                    if (gameStep === 1 && id === selectedCreatureId) {
                        resetGameStep();
                    }
                    // 2ë‹¨ê³„(í¬ì‹ì ì°¾ê¸°)ì—ì„œëŠ”, ìì‹ ì„ í´ë¦­í•˜ëŠ” ê²ƒì´ ë“œë˜ê·¸ì˜ ì‹œì‘ì´ë¯€ë¡œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ.
                    // 1ë‹¨ê³„ë“  2ë‹¨ê³„ë“ , ë‹¤ë¥¸ ìƒë¬¼ì„ í´ë¦­í•˜ë©´ (ë“œë˜ê·¸ ì‹œì‘ì„ ìœ„í•´) ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ì„ íƒ ë³€ê²½ ë°©ì§€)
                    return;
                }

                // ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ (gameStep === 0)
                resetGameStep(); // ì´ì „ ìƒíƒœ ì´ˆê¸°í™”
                selectedCreatureId = id;
                gameStep = 1; // 1ë‹¨ê³„: ë¨¹ì´ ì°¾ê¸°
                foundFood.clear();
                foundPredators.clear();

                clickedEl.classList.add('selected');
                
                const creatureData = creatures[selectedCreatureId];
                if (creatureData.eats.length > 0) {
                    setGamePrompt(`[1ë‹¨ê³„] ${creatureData.name}ì€(ëŠ”) ë¬´ì—‡ì„ ë¨¹ì„ê¹Œìš”? <br> ë¨¹ì´ë¥¼ ${creatureData.name}ì—ê²Œ ë“œë˜ê·¸í•˜ì„¸ìš”.`);
                } else {
                    // ë¨¹ì„ ê²ƒì´ ì—†ëŠ” ìƒì‚°ìì¸ ê²½ìš°, ë°”ë¡œ 2ë‹¨ê³„ë¡œ
                    gameStep = 2;
                    checkPredatorStep();
                }
            }

            // ê²Œì„ ë‹¨ê³„ ì´ˆê¸°í™”
            function resetGameStep() {
                selectedCreatureId = null;
                gameStep = 0;
                foundFood.clear();
                foundPredators.clear();
                setGamePrompt('ê´€ê³„ë¥¼ ì•Œì•„ë³´ê³  ì‹¶ì€ ìƒë¬¼ì„ í´ë¦­í•˜ì„¸ìš”!');
                document.querySelectorAll('.creature.selected').forEach(el => el.classList.remove('selected'));
            }

            /* *** ìˆ˜ì •ëœ ë¶€ë¶„: ê²Œì„ í”„ë¡¬í”„íŠ¸ ì„¤ì • í•¨ìˆ˜ *** */
            function setGamePrompt(html) {
                // 1. ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì·¨ì†Œ (ìƒˆ ë©”ì‹œì§€ê°€ ë®ì–´ì“°ë¯€ë¡œ)
                if (gamePromptTimer) {
                    clearTimeout(gamePromptTimer);
                }

                // 2. ë‚´ìš© ì„¤ì • ë° 'show' í´ë˜ìŠ¤ ì¶”ê°€ (ë³´ì´ê²Œ)
                gamePrompt.innerHTML = html;
                gamePrompt.classList.add('show');

                // 3. 3ì´ˆ(3000ms) í›„ì— 'show' í´ë˜ìŠ¤ ì œê±° (ìˆ¨ê¸°ê¸°)
                gamePromptTimer = setTimeout(() => {
                    gamePrompt.classList.remove('show');
                }, 3000);
            }
            /* *** ìˆ˜ì • ë *** */


            // --- 4. ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ (Mouse & Touch) ---
            
            function onDragStart(e) {
                if (e.target.closest('.creature')) {
                    draggedElement = e.target.closest('.creature');
                    draggedElement.classList.add('dragging');
                    draggedElement.style.cursor = 'grabbing';
                    isDragging = true;
                    
                    const rect = draggedElement.getBoundingClientRect();
                    const gameRect = gameArea.getBoundingClientRect();

                    let clientX, clientY;
                    if (e.type === 'touchstart') {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                        e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
                    
                    offsetX = clientX - rect.left;
                    offsetY = clientY - rect.top;
                    
                    startX = (clientX - gameRect.left) / gameRect.width * 100;
                    startY = (clientY - gameRect.top) / gameRect.height * 100;
                }
            }
            
            function onDragMove(e) {
                if (!isDragging || !draggedElement) return;

                let clientX, clientY;
                if (e.type === 'touchmove') {
                    e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                const gameRect = gameArea.getBoundingClientRect();
                let newX = (clientX - gameRect.left - offsetX) / gameRect.width * 100;
                let newY = (clientY - gameRect.top - offsetY) / gameRect.height * 100;

                // gameArea ê²½ê³„ ì²´í¬
                newX = Math.max(0, Math.min(newX, 100 - (draggedElement.offsetWidth / gameRect.width * 100)));
                newY = Math.max(0, Math.min(newY, 100 - (draggedElement.offsetHeight / gameRect.height * 100)));

                draggedElement.style.left = `${newX}%`;
                draggedElement.style.top = `${newY}%`;
                
                // *** ì¶”ê°€: ë“œë¡­ ëŒ€ìƒ ê°•ì¡° ë¡œì§ ***
                // ë“œë˜ê·¸ ìš”ì†Œë¥¼ ì ì‹œ ìˆ¨ê¹€
                draggedElement.style.display = 'none';
                const elementUnder = document.elementFromPoint(clientX, clientY);
                draggedElement.style.display = 'flex'; // ë‹¤ì‹œ í‘œì‹œ

                const targetElement = elementUnder ? elementUnder.closest('.creature') : null;

                // ê¸°ì¡´ ëŒ€ìƒì—ì„œ ê°•ì¡° ì œê±°
                if (currentTargetElement && currentTargetElement !== targetElement) {
                    currentTargetElement.classList.remove('creature-target');
                    currentTargetElement = null;
                }

                // ìƒˆ ëŒ€ìƒì— ê°•ì¡° ì¶”ê°€
                if (targetElement && targetElement !== draggedElement) {
                    targetElement.classList.add('creature-target');
                    currentTargetElement = targetElement;
                }
                // *** ì¶”ê°€ ë ***

                updateArrowsForDraggedElement(draggedElement.dataset.id);
            }
            
            function onDragEnd(e) {
                if (!isDragging || !draggedElement) return;

                // *** ì¶”ê°€: ë“œë¡­ ëŒ€ìƒ ê°•ì¡° ì œê±° ***
                if (currentTargetElement) {
                    currentTargetElement.classList.remove('creature-target');
                    currentTargetElement = null;
                }
                // *** ì¶”ê°€ ë ***

                isDragging = false;
                draggedElement.classList.remove('dragging');
                draggedElement.style.cursor = 'grab';

                const gameRect = gameArea.getBoundingClientRect();
                let clientX, clientY;
                
                if (e.type === 'touchend') {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                draggedElement.style.display = 'none';
                const elementUnder = document.elementFromPoint(clientX, clientY);
                draggedElement.style.display = 'flex'; 

                const targetElement = elementUnder ? elementUnder.closest('.creature') : null;
                const draggedId = draggedElement.dataset.id;
                
                const endX = (clientX - gameRect.left) / gameRect.width * 100;
                const endY = (clientY - gameRect.top) / gameRect.height * 100;
                const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
 
                let didDropOnTarget = false;
                if (targetElement && targetElement !== draggedElement && distance >= 2) {
                    const targetId = targetElement.dataset.id;
                    if (checkGameLogic(draggedId, targetId)) {
                        didDropOnTarget = true;
                    }
                }
                
                if (didDropOnTarget) {
                    // O, X ë¡œì§ì´ ì‹¤í–‰ë˜ì—ˆìœ¼ë©´ (ì •ë‹µ/ì˜¤ë‹µ) ì›ë˜ ìë¦¬ë¡œ ìŠ¤ëƒ…ë°±
                    snapBack(draggedElement, true);
                } else if (distance >= 2) { 
                    // ë“œë¡­ íƒ€ê²Ÿì´ ì—†ì—ˆê³ , ê·¸ëƒ¥ 'ì´ë™'í•œ ê±°ë¼ë©´
                    // *** ìˆ˜ì •: ì›ë³¸ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ ***
                    // const creatureData = creatures[draggedId];
                    // creatureData.pos.x = parseFloat(draggedElement.style.left);
                    // creatureData.pos.y = parseFloat(draggedElement.style.top);
                    
                    // ì´ ê²½ìš°ì—ë„ í™”ì‚´í‘œ ë‹¤ì‹œ ê·¸ë ¤ì•¼ í•¨
                    drawAllArrows();
                } else {
                    // í´ë¦­ì´ì—ˆìŒ (distance < 2).
                    // ìœ„ì¹˜ë¥¼ ì›ë˜ëŒ€ë¡œ ëŒë ¤ë†“ìŒ (í´ë¦­ ì‹œ ë¯¸ì„¸í•œ ì›€ì§ì„ ë³´ì •)
                    snapBack(draggedElement, false);
                }
                
                draggedElement = null;
            }

            // ê²Œì„ ë¡œì§ ì²´í¬ (ë“œë¡­ ì‹œ)
            function checkGameLogic(draggedId, targetId) {
                if (!selectedCreatureId || gameStep === 0) return false; 

                const selectedData = creatures[selectedCreatureId];

                // 1ë‹¨ê³„: ë¨¹ì´ ì°¾ê¸° (ë¨¹ì´ë¥¼ -> ì„ íƒëœ ìƒë¬¼ì—ê²Œ ë“œë¡­)
                if (gameStep === 1 && targetId === selectedCreatureId) {
                    if (selectedData.eats.includes(draggedId)) {
                        if (!foundFood.has(draggedId)) {
                            showFeedback(true); // 'O'
                            foundFood.add(draggedId);
                            addArrow(draggedId, targetId);
                        }
                    } else {
                        showFeedback(false); // 'X'
                    }

                    // ëª¨ë“  ë¨¹ì´ë¥¼ ì°¾ì•˜ëŠ”ì§€ í™•ì¸
                    if (foundFood.size === selectedData.eats.length) {
                        gameStep = 2;
                        setTimeout(checkPredatorStep, 1000); // 1ì´ˆ í›„ ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´
                    }
                    return true; 
                }
                // 2ë‹¨ê³„: í¬ì‹ì ì°¾ê¸° (ì„ íƒëœ ìƒë¬¼ì„ -> í¬ì‹ìì—ê²Œ ë“œë¡­)
                else if (gameStep === 2 && draggedId === selectedCreatureId) {
                    if (selectedData.eatenBy.includes(targetId)) {
                        if (!foundPredators.has(targetId)) {
                            showFeedback(true); // 'O'
                            foundPredators.add(targetId);
                            addArrow(draggedId, targetId);
                        }
                    } else {
                        showFeedback(false); // 'X'
                    }

                    // ëª¨ë“  í¬ì‹ìë¥¼ ì°¾ì•˜ëŠ”ì§€ í™•ì¸
                    if (foundPredators.size === selectedData.eatenBy.length) {
                        // *** ìˆ˜ì •: íŒì—… í›„ ì¦‰ì‹œ ë¦¬ì…‹ë˜ë„ë¡ ***
                        setTimeout(() => {
                            setGamePrompt('ğŸ‰ ì„±ê³µ! ëª¨ë“  ê´€ê³„ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ìƒë¬¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                            resetGameStep(); // gameStep=0, selectedCreatureId=null ë“±ìœ¼ë¡œ ì´ˆê¸°í™”
                        }, 1000); // 1ì´ˆ(O/X íŒì—…) í›„ì— ì‹¤í–‰
                    }
                    return true; 
                }

                return false; 
            }
            
            // 2ë‹¨ê³„ (í¬ì‹ì ì°¾ê¸°) ì‹œì‘ í•¨ìˆ˜
            function checkPredatorStep() {
                const selectedData = creatures[selectedCreatureId];
                if (selectedData.eatenBy.length > 0) {
                     setGamePrompt(`[2ë‹¨ê³„] ${selectedData.name}ì„(ë¥¼) ë¨¹ëŠ” ë™ë¬¼ì€ ë¬´ì—‡ì¼ê¹Œìš”? <br> ${selectedData.name}ì„(ë¥¼) í¬ì‹ìì—ê²Œ ë“œë˜ê·¸í•˜ì„¸ìš”.`);
                } else {
                    // í¬ì‹ìê°€ ì—†ëŠ” ê²½ìš° (ìµœì¢… ì†Œë¹„ì)
                    setGamePrompt('ğŸ‰ ì„±ê³µ! ì´ ìƒë¬¼ì€ ë‹¤ë¥¸ ë™ë¬¼ì—ê²Œ ë¨¹íˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ìƒë¬¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                    setTimeout(resetGameStep, 2000);
                }
            }

            // O/X í”¼ë“œë°± í‘œì‹œ
            function showFeedback(isCorrect) {
                if (isCorrect) {
                    messageBox.innerHTML = 'O';
                    messageBox.classList.add('bg-green-500');
                    messageBox.classList.remove('bg-red-500');
                } else {
                    messageBox.innerHTML = 'X';
                    messageBox.classList.add('bg-red-500');
                    messageBox.classList.remove('bg-green-500');
                }

                messageBox.classList.add('show');

                // 1ì´ˆ í›„ì— ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 1000);
            }

            // --- 5. í™”ì‚´í‘œ ê·¸ë¦¬ê¸° ë¡œì§ ---
            
            // í™”ì‚´í‘œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            function addArrow(fromId, toId) {
                const exists = drawnArrows.some(arrow => arrow.from === fromId && arrow.to === toId);
                if (!exists) {
                    drawnArrows.push({ from: fromId, to: toId });
                }
            }

            // ëª¨ë“  í™”ì‚´í‘œ ê·¸ë¦¬ê¸°
            function drawAllArrows() {
                const lines = arrowCanvas.querySelectorAll('.arrow-line');
                lines.forEach(line => line.remove());

                drawnArrows.forEach(arrow => {
                    createSvgLine(arrow.from, arrow.to);
                });
            }
            
            // ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œì— ì—°ê²°ëœ í™”ì‚´í‘œë§Œ ì—…ë°ì´íŠ¸
            function updateArrowsForDraggedElement(draggedId) {
                const lines = arrowCanvas.querySelectorAll(`[data-from="${draggedId}"], [data-to="${draggedId}"]`);
                lines.forEach(line => line.remove());
                
                drawnArrows.forEach(arrow => {
                    if (arrow.from === draggedId || arrow.to === draggedId) {
                        createSvgLine(arrow.from, arrow.to);
                    }
                });
            }
 
            // SVG ì„ (í™”ì‚´í‘œ) ìƒì„±
            function createSvgLine(fromId, toId) {
                const fromEl = document.querySelector(`.creature[data-id="${fromId}"]`);
                const toEl = document.querySelector(`.creature[data-id="${toId}"]`);

                if (!fromEl || !toEl) return;

                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();
                const canvasRect = arrowCanvas.getBoundingClientRect();

                // ê° ìš”ì†Œì˜ ì¤‘ì‹¬ì  ê³„ì‚°
                const from = {
                    x: fromRect.left - canvasRect.left + fromRect.width / 2,
                    y: fromRect.top - canvasRect.top + fromRect.height / 2
                };
                const to = {
                    x: toRect.left - canvasRect.left + toRect.width / 2,
                    y: toRect.top - canvasRect.top + toRect.height / 2
                };
                
                const angle = Math.atan2(to.y - from.y, to.x - from.x);
                
                const toPadding = toRect.width > toRect.height ? toRect.width / 2 : toRect.height / 2;
                const adjustedTo = {
                    x: to.x - Math.cos(angle) * (toPadding + 10), // 10ì€ í™”ì‚´ì´‰ ê¸¸ì´
                    y: to.y - Math.sin(angle) * (toPadding + 10)
                };

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', from.x);
                line.setAttribute('y1', from.y);
                line.setAttribute('x2', adjustedTo.x);
                line.setAttribute('y2', adjustedTo.y);
                line.setAttribute('class', 'arrow-line');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                line.setAttribute('data-from', fromId);
                line.setAttribute('data-to', toId);
                
                arrowCanvas.appendChild(line);
            }
            
            function snapBack(element, redraw = false) { 
                const id = element.dataset.id;
                // *** ìˆ˜ì •: ì›ë³¸ ë°ì´í„°(creatures)ì—ì„œ ìœ„ì¹˜ë¥¼ ì½ì–´ì˜´ ***
                const originalPos = creatures[id].pos;
                
                element.style.transition = 'left 0.3s ease-out, top 0.3s ease-out';
                element.style.left = `${originalPos.x}%`;
                element.style.top = `${originalPos.y}%`;
                
                setTimeout(() => {
                    element.style.transition = 'all 0.2s ease-in-out';
                    if (redraw) {
                        drawAllArrows();
                    }
                }, 300);
            }

            // ëª¨ë“  ìƒë¬¼ ìœ„ì¹˜ ë¦¬ì…‹
            function resetCreaturePositions() {
                clearArrows(true); // í™”ì‚´í‘œ ì§€ìš°ê³  í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹
                document.querySelectorAll('.creature').forEach(el => {
                    const id = el.dataset.id;
                    // *** ìˆ˜ì •: ì›ë³¸ ë°ì´í„°(creatures)ì—ì„œ ìœ„ì¹˜ë¥¼ ì½ì–´ì˜´ ***
                    const pos = creatures[id].pos; 
                    el.style.transition = 'left 0.5s ease, top 0.5s ease'; 
                    el.style.left = `${pos.x}%`; 
                    el.style.top = `${pos.y}%`;
                    
                    // *** ì‚­ì œ: ì›ë³¸ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë˜ ì½”ë“œ ì‚­ì œ ***
                    // creatures[id].pos.x = pos.x;
                    // creatures[id].pos.y = pos.y;

                    setTimeout(() => {
                        el.style.transition = 'all 0.2s ease-in-out'; 
                    }, 500);
                });
            }

            // ëª¨ë“  í™”ì‚´í‘œ ë³´ê¸°
            function showAllArrows() {
                clearArrows(false); 
                const allCorrectArrows = [];
                Object.keys(creatures).forEach(id => {
                    const data = creatures[id];
                    data.eatenBy.forEach(predatorId => {
                        allCorrectArrows.push({ from: id, to: predatorId });
                    });
                });
                drawnArrows = allCorrectArrows;
                drawAllArrows();
                resetGameStep();
                setGamePrompt('ìƒíƒœê³„ì˜ ëª¨ë“  ë¨¹ì´ ê´€ê³„ì…ë‹ˆë‹¤.');
            }

            // í™”ì‚´í‘œ ì§€ìš°ê¸°
            function clearArrows(resetPrompt) {
                drawnArrows = [];
                drawAllArrows();
                if (resetPrompt) {
                    resetGameStep();
                }
            }
            
            // ê²Œì„ ë¦¬ì…‹ (í•™ìŠµ ë·°ë¡œ ëŒì•„ê°ˆ ë•Œ)
            function resetGame() {
                clearArrows(true);
                gameArea.querySelectorAll('.creature').forEach(el => el.remove());
            }

        });
    </script>
</body>
</html>