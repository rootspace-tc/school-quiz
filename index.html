<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ì‹¤ì‹œê°„ ë¬¸ì œ ê´€ë¦¬í˜• í€´ì¦ˆ í”Œë«í¼ V20.0 (ìµœì¢…)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Jua', sans-serif; background-color: #f7f3e9; font-size: 18px; }
        .container { max-width: 1100px; margin: 2rem auto; padding: 30px; background: #fff; border-radius: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 2.5rem !important; } 
        h2 { font-size: 2rem !important; }
        .text-xl { font-size: 1.5rem !important; }
        .text-2xl { font-size: 1.875rem !important; }
        #student-question-text { font-size: 3rem !important; line-height: 1.4; } 
        .result-bar { height: 35px; margin-bottom: 8px; color: white; display: flex; align-items: center; padding: 0 10px; border-radius: 4px; transition: width 0.5s ease-out; }
        .correct-answer-highlight { background-color: #d1f7d1; font-weight: bold; border-left: 5px solid #4CAF50; padding: 5px; margin: 3px 0; border-radius: 4px; }
        .question-item { cursor: pointer; border-left: 5px solid transparent; transition: all 0.2s; }
        .question-item:hover { background-color: #f3f4f6; border-left-color: #3b82f6; }
        .question-item.selected { background-color: #bfdbfe; border-left-color: #1d4ed8; font-weight: bold; }
        .kick-btn { background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; }
        .kick-btn:hover { background-color: #dc2626; }
        #navigation-buttons button:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .submission-closed { background-color: #fca5a5; color: #7f1d1d; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="font-bold text-center mb-10 text-indigo-700">ğŸš€ ì‹¤ì‹œê°„ ë¬¸ì œ ê´€ë¦¬í˜• í€´ì¦ˆ í”Œë«í¼ V20.0</h1>
    
    <div id="mode-selection" class="flex justify-center space-x-6 mb-8">
        <button id="teacher-mode-btn" class="mode-button bg-red-500 text-white p-4 rounded-lg shadow-md text-xl">
            ğŸ‘©â€ğŸ« êµì‚¬ ëª¨ë“œ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
        </button>
        <button id="student-mode-btn" class="mode-button bg-blue-500 text-white p-4 rounded-lg shadow-md text-xl">
            ğŸ§‘â€ğŸ“ í•™ìƒ ëª¨ë“œ
        </button>
    </div>

    <hr class="mb-8 border-gray-300">

    <div id="teacher-panel" class="hidden">
        <h2 class="font-bold mb-5 text-red-600">êµì‚¬ ì œì–´íŒ</h2>
        
        <div id="question-control-area" class="p-8 border border-red-300 rounded-lg bg-red-50 mb-8">
            <div class="p-4 border border-blue-300 rounded-lg bg-blue-50 mb-5">
                <label for="student-password-input" class="block font-semibold mb-3">ğŸ”’ í•™ìƒ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ë¯¸ì…ë ¥ì‹œ ë¹„í™œì„±í™”):</label>
                <input type="text" id="student-password-input" class="w-full border rounded p-3 text-lg" placeholder="ì˜ˆ: ìš°ë¦¬ë°˜í™”ì´íŒ…">
            </div>

            <div id="question-management-area" class="border-b pb-4 mb-4">
                <h3 class="text-2xl font-bold mb-4">ë¬¸ì œ ìƒì„± ë° ëª©ë¡ ê´€ë¦¬</h3>
                
                <div id="question-creation-form" class="border-b pb-4 mb-4">
                    <label for="question-text" class="block font-semibold mb-3">ğŸ“ ì§ˆë¬¸ ë‚´ìš©:</label>
                    <textarea id="question-text" rows="2" class="w-full border rounded p-3 mb-3 text-lg"></textarea>
                    
                    <label class="block font-semibold mb-3">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²¨ë¶€:</label>
                    <div id="image-upload-area" class="border-2 border-dashed border-gray-400 p-3 mb-3 rounded-lg bg-white">
                        <input type="file" id="image-file-input" accept="image/*" class="mb-2 block w-full text-lg">
                        <p class="text-gray-600 text-base">ë˜ëŠ”, ì´ë¯¸ì§€ íŒŒì¼ì„ **ì´ ì˜ì—­ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)** í•˜ì„¸ìš”.</p>
                        <div id="image-preview" class="mt-2 text-center hidden">
                            <p class="mb-2">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°:</p>
                            <img src="" id="current-image-preview" class="max-w-full h-auto mx-auto border border-gray-300 rounded max-h-48">
                            <button id="remove-image-btn" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white p-2 rounded text-base">
                                âŒ ì´ë¯¸ì§€ ì œê±°
                            </button>
                        </div>
                    </div>

                    <label for="question-type" class="block font-semibold mb-3">â“ ì§ˆë¬¸ ìœ í˜•:</label>
                    <select id="question-type" class="w-full border rounded p-3 mb-3 bg-white text-lg">
                        <option value="MCQ">ê°ê´€ì‹ (ë‹¤ì§€ì„ ë‹¤)</option>
                        <option value="OX">OX í€´ì¦ˆ</option>
                        <option value="ShortAnswer">ì£¼ê´€ì‹ (ë‹¨ë‹µí˜•)</option>
                    </select>
                    
                    <div id="mcq-options-container">
                        <label for="mcq-options" class="block font-semibold mb-3">ğŸ”¢ ê°ê´€ì‹ ë³´ê¸° (ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„):</label>
                        <input type="text" id="mcq-options" class="w-full border rounded p-3 text-lg" value="1. ë„¤, 2. ì•„ë‹ˆì˜¤, 3. ì•„ë§ˆë„, 4. ê¸€ì„ìš”">
                    </div>

                    <label for="correct-answer-input" class="block font-semibold mb-3 mt-3">ğŸ”‘ ì •ë‹µ ì…ë ¥ (ì„ íƒ ì‚¬í•­):</label>
                    <input type="text" id="correct-answer-input" class="w-full border rounded p-3 text-lg" placeholder="ì˜ˆ: 3ë²ˆ ë˜ëŠ” ì •ë‹µ í…ìŠ¤íŠ¸">

                    <button id="save-question-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg font-semibold w-full mt-4 text-xl">
                        ğŸ“ ë¬¸ì œ ëª©ë¡ì— ì €ì¥
                    </button>
                </div>
                
                <h4 class="text-xl font-bold mb-3 mt-4">ğŸ“‹ ê´€ë¦¬ ì¤‘ì¸ ë¬¸ì œ ëª©ë¡ (Ctrl/Cmdë¡œ ë‹¤ì¤‘ ì„ íƒ)</h4>
                <div id="managed-question-list" class="space-y-2 border p-3 rounded bg-white max-h-60 overflow-y-auto">
                    <p class="text-gray-500">ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                
                <div class="flex space-x-3 mt-4">
                    <button id="load-set-btn" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-lg font-semibold flex-1 text-xl" disabled>
                        ğŸ“¢ ì„ íƒí•œ ë¬¸ì œ ì„¸íŠ¸ ì¶œì œ
                    </button>
                    <button id="delete-managed-btn" class="bg-gray-400 hover:bg-gray-500 text-white p-4 rounded-lg font-semibold w-1/4 text-xl" disabled>
                        ğŸ—‘ ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
        
        <div class="p-8 border border-gray-300 rounded-lg">
            <h3 class="text-2xl font-bold mb-4">ì‹¤ì‹œê°„ ì œì–´</h3>
            <div class="flex space-x-3 mt-3 mb-6">
                <button id="close-submission-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    â›” ë‹µë³€ ë§ˆê°
                </button>
                <button id="hide-question-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ğŸ™ˆ ë¬¸ì œ ìˆ¨ê¸°ê¸°
                </button>
                <button id="clear-results-btn" class="bg-gray-400 hover:bg-gray-500 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ğŸ—‘ í˜„ì¬ ì‘ë‹µ ì´ˆê¸°í™”
                </button>
            </div>


            <h3 class="text-xl font-bold mb-5 flex justify-between">
                <span>ğŸ“Š ì‹¤ì‹œê°„ ì‘ë‹µ í˜„í™© (<span id="total-responses">0</span>ëª… ì°¸ì—¬)</span>
                <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-base">
                    â¬‡ï¸ ì „ì²´ ê¸°ë¡ EXCEL ë‹¤ìš´ë¡œë“œ
                </button>
            </h3>
            
            <div id="submission-status-teacher" class="text-center p-3 rounded mb-4 text-xl submission-closed hidden">
                â›” í˜„ì¬ ë‹µë³€ ìˆ˜ì •ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>

            <div id="results-display" class="space-y-4">
                <p class="text-gray-500 text-lg">ë¬¸ì œê°€ ì¶œì œë˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            
            <div id="correct-respondents-list" class="mt-8 border-t pt-5 hidden">
                 <h4 class="text-xl font-bold mb-4 text-green-600">âœ… ì •ë‹µì ëª…ë‹¨</h4>
                 <div id="correct-list-content" class="text-lg">ì •ë‹µì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì •ë‹µìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>

            <div id="respondents-full-list" class="mt-8 border-t pt-5">
                 <h4 class="text-xl font-bold mb-4 text-gray-700">ğŸ§‘â€ğŸ“ ì „ì²´ ë‹µë³€ì ëª©ë¡ (ë‹µë³€ í¬í•¨)</h4>
                 <div id="full-list-content" class="text-lg space-y-2">ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
             
            <div id="active-users-list" class="mt-8 border-t pt-5">
                <h4 class="text-xl font-bold mb-4 text-gray-700">ğŸŸ¢ í˜„ì¬ ì ‘ì† ë° ë‹µë³€ì ëª©ë¡ (<span id="active-count">0</span>ëª…)</h4>
                <div id="active-users-content" class="text-lg space-y-2 flex flex-wrap gap-2">
                    <p class="text-gray-500">í•™ìƒë“¤ì˜ ì ‘ì† ë° ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
        
        <div class="p-8 border border-blue-300 rounded-lg bg-blue-50 mt-8">
            <h3 class="text-2xl font-bold mb-4 text-blue-700">ğŸ“‚ ëˆ„ì ëœ ê³¼ê±° í€´ì¦ˆ ê¸°ë¡ ë³´ê¸°</h3>
            <div id="history-list" class="text-lg space-y-4">ê¸°ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <button id="clear-history-btn" class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-semibold w-full mt-4 text-xl">
                ğŸ’£ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”
            </button>
        </div>
        
        <div id="history-detail-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <h3 id="modal-question-title" class="text-2xl font-bold mb-4"></h3>
                <div id="modal-results-display" class="space-y-4 border p-4 rounded mb-4"></div>
                <button id="modal-close-btn" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded w-full">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="student-panel" class="hidden">
        <h2 class="font-bold mb-5 text-blue-600">í•™ìƒ ì‘ë‹µì°½</h2>
        
        <div id="student-login-area" class="p-8 border border-blue-300 rounded-lg bg-blue-50 mb-8">
            <label for="student-name" class="block font-semibold mb-3 text-lg">ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ ì…ë ¥:</label>
            <input type="text" id="student-name" class="w-full border rounded p-3 mb-5 text-xl" placeholder="ì˜ˆ: 1ë²ˆ ê¹€ì² ìˆ˜">
            <label for="student-access-password" class="block font-semibold mb-3 text-lg">ğŸ”’ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ (êµì‚¬ ì„¤ì •):</label>
            <input type="text" id="student-access-password" class="w-full border rounded p-3 mb-5 text-xl" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">

            <button id="student-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-semibold w-full text-xl">
                âœ… ì°¸ì—¬ ì‹œì‘
            </button>
        </div>

        <div id="student-quiz-area" class="hidden">
            <div class="p-8 border border-gray-300 rounded-lg bg-white mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700 flex justify-between">
                    <span>í˜„ì¬ ë¬¸ì œ: <span id="problem-number-display">ëŒ€ê¸° ì¤‘</span></span>
                    <span id="set-size-display"></span>
                </h3>
                <div id="student-question-image-container" class="mb-6 hidden">
                    <img src="" id="student-question-image" class="max-w-full h-auto mx-auto border border-gray-200 rounded max-h-80">
                </div>
                <p id="student-question-text" class="font-extrabold text-gray-800 mb-6 text-center">
                    [ì„ ìƒë‹˜ì´ ë¬¸ì œ ì„¸íŠ¸ë¥¼ ì¶œì œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.]
                </p>
                
                <div id="submission-status-student" class="text-center p-3 rounded mb-4 text-xl submission-closed hidden">
                    â›” ë‹µë³€ ìˆ˜ì •ì´ ë§ˆê°ë˜ì–´ ì œì¶œ/ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>

                <div id="student-answer-buttons" class="grid grid-cols-2 gap-4 mb-4">
                </div>
                
                <button id="submit-answer-btn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-semibold w-full text-xl">
                    ğŸš€ ë‹µë³€ ì €ì¥
                </button>
                <p id="submission-status-msg" class="text-center mt-3 text-green-700 font-semibold text-2xl hidden">
                    âœ… ë‹µë³€ ì œì¶œì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! (ìˆ˜ì • ê°€ëŠ¥)
                </p>
                
                <div id="navigation-buttons" class="flex justify-between mt-6">
                    <button id="prev-problem-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 p-3 rounded-lg font-semibold w-2/5 text-xl" disabled>
                        â† ì´ì „ ë¬¸ì œ
                    </button>
                    <button id="next-problem-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 p-3 rounded-lg font-semibold w-2/5 text-xl" disabled>
                        ë‹¤ìŒ ë¬¸ì œ â†’
                    </button>
                </div>
            </div>
        </div>
        
        <div id="student-submitted-area" class="hidden text-center p-12 border border-green-300 rounded-lg bg-green-50">
            <h3 class="text-3xl font-bold mb-4 text-green-700">âœ… ë‹µë³€ ì œì¶œ ì™„ë£Œ</h3>
            <p class="text-xl text-gray-700 mb-6">
                ë¬¸ì œ í’€ì´ë¥¼ ì‹œì‘í•˜ë ¤ë©´ 'ë‹µë³€ ìˆ˜ì •í•˜ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”.<br>
                (ë§ˆì§€ë§‰ ë¬¸ì œê¹Œì§€ í‘¸ì‹  í›„ì—ëŠ” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.)
            </p>
            <button id="modify-answer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-lg font-semibold text-xl">
                âœï¸ ë‹µë³€ ìˆ˜ì •í•˜ê¸° / ë¬¸ì œ í’€ê¸°
            </button>
            <p class="text-sm mt-4 text-gray-500">
                **[ì„¤ëª…]** ë‹µë³€ ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¬¸ì œ í’€ì´ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.<br>
            </p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"; 
    import { getDatabase, ref, set, onValue, remove, push, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ----------------------------------------------------
    // 1. Firebase ì„¤ì •
    // ----------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAN1iAC82xKL_haJUs9291YBKNv7g7WSvU",
        authDomain: "foranswering-afec8.firebaseapp.com",
        databaseURL: "https://foranswering-afec8-default-rtdb.firebaseio.com",
        projectId: "foranswering-afec8",
        storageBucket: "foranswering-afec8.firebasestorage.app",
        messagingSenderId: "291098085525",
        appId: "1:291098085525:web:883a852c6320859294339c",
        measurementId: "G-5LP4KEWLXR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); 

    // ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ì •ì˜
    const STATUS_PATH = 'quiz/status'; 
    const QUESTION_SET_PATH = 'quiz/currentQuestionSet'; 
    const RESPONSES_PATH = 'quiz/responses'; 
    const HISTORY_PATH = 'quiz/history'; 
    const PRESENCE_PATH = 'quiz/presence'; 
    const CONFIG_PATH = 'quiz/config'; 
    const MANAGED_QUESTIONS_PATH = 'quiz/managedQuestions'; 

    // ----------------------------------------------------
    // 2. ë³€ìˆ˜ ë° UI ìš”ì†Œ ì •ì˜
    // ----------------------------------------------------
    const TEACHER_PASSWORD = "2948"; 
    let currentStudentId = null; 
    let currentImageBase64 = null; 
    let selectedManagedQuestionKey = null; 
    let currentQuizSet = []; 
    let currentProblemIndex = 0; 
    let currentStudentAnswers = {}; 

    // UI ìš”ì†Œ
    const teacherPanel = document.getElementById('teacher-panel');
    const studentPanel = document.getElementById('student-panel');
    const modeSelection = document.getElementById('mode-selection');
    const questionTextarea = document.getElementById('question-text');
    const questionTypeSelect = document.getElementById('question-type');
    const mcqOptionsInput = document.getElementById('mcq-options');
    const correctAnswerInput = document.getElementById('correct-answer-input'); 
    const totalResponsesEl = document.getElementById('total-responses');
    const resultsDisplay = document.getElementById('results-display');
    const correctRespondentsList = document.getElementById('correct-respondents-list'); 
    const correctListContent = document.getElementById('correct-list-content');
    const fullListContent = document.getElementById('full-list-content'); 
    const historyList = document.getElementById('history-list'); 
    const activeUsersContent = document.getElementById('active-users-content'); 
    const activeCount = document.getElementById('active-count'); 
    const studentNameInput = document.getElementById('student-name');
    const studentAccessPassword = document.getElementById('student-access-password');
    const studentPasswordInput = document.getElementById('student-password-input');
    const studentQuizArea = document.getElementById('student-quiz-area');
    const studentSubmittedArea = document.getElementById('student-submitted-area');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const saveQuestionBtn = document.getElementById('save-question-btn'); 
    const managedQuestionList = document.getElementById('managed-question-list'); 
    const loadSetBtn = document.getElementById('load-set-btn'); 
    const deleteManagedBtn = document.getElementById('delete-managed-btn'); 
    const removeImageBtn = document.getElementById('remove-image-btn');
    const hideQuestionBtn = document.getElementById('hide-question-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const problemNumberDisplay = document.getElementById('problem-number-display');
    const setSizeDisplay = document.getElementById('set-size-display');
    const prevProblemBtn = document.getElementById('prev-problem-btn');
    const nextProblemBtn = document.getElementById('next-problem-btn');


    // ----------------------------------------------------
    // 3. ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë¶™ì—¬ë„£ê¸° ë¡œì§
    // ----------------------------------------------------
    function setImage(base64Data) {
        document.getElementById('current-image-preview').src = base64Data;
        document.getElementById('image-preview').classList.remove('hidden');
        currentImageBase64 = base64Data;
    }
    document.getElementById('image-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => setImage(event.target.result);
            reader.readAsDataURL(file);
        }
    });
    document.getElementById('image-upload-area').addEventListener('paste', (e) => {
        e.preventDefault();
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => setImage(event.target.result);
                reader.readAsDataURL(blob);
                break;
            }
        }
    });
    removeImageBtn.addEventListener('click', () => {
        currentImageBase64 = null;
        document.getElementById('image-file-input').value = '';
        document.getElementById('image-preview').classList.add('hidden');
    });


    // ----------------------------------------------------
    // 4. ëª¨ë“œ ì „í™˜ ë° ì´ˆê¸°í™” ë¡œì§ (ì•ˆì •í™”)
    // ----------------------------------------------------
    
    document.getElementById('question-type').addEventListener('change', (e) => {
        if (e.target.value === 'MCQ') {
            document.getElementById('mcq-options-container').classList.remove('hidden');
        } else {
            document.getElementById('mcq-options-container').classList.add('hidden');
        }
    });
    
    function listenForActiveUsers() {
        onValue(ref(db, PRESENCE_PATH), (snapshot) => {
            renderActiveUsers(snapshot.val());
        });
    }

    // ğŸ’¡ [ìˆ˜ì •] êµì‚¬ ëª¨ë“œ ì§„ì… (ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì•ˆì •í™”)
    document.getElementById('teacher-mode-btn').addEventListener('click', async () => {
        const password = prompt("êµì‚¬ ëª¨ë“œì— ì ‘ì†í•˜ì‹œë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        if (password === TEACHER_PASSWORD) {
            const configSnapshot = await get(ref(db, CONFIG_PATH));
            const config = configSnapshot.val();
            if (config && config.studentPassword) {
                studentPasswordInput.value = config.studentPassword;
            } else {
                studentPasswordInput.value = '';
            }

            teacherPanel.classList.remove('hidden');
            studentPanel.classList.add('hidden');
            modeSelection.classList.add('hidden');
            onValue(ref(db, HISTORY_PATH), (snapshot) => renderHistoryList(snapshot.val()));
            listenForResponses();
            listenForActiveUsers(); // ğŸ’¡ ì ‘ì†ì ë¦¬ìŠ¤ë„ˆ í™œì„±í™”
            onValue(ref(db, MANAGED_QUESTIONS_PATH), (snapshot) => renderManagedQuestions(snapshot.val())); 
            document.getElementById('question-control-area').classList.remove('hidden');
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    });

    document.getElementById('student-mode-btn').addEventListener('click', () => {
        teacherPanel.classList.add('hidden');
        studentPanel.classList.remove('hidden');
        modeSelection.classList.add('hidden');
    });

    // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] í•™ìƒ ë¡œê·¸ì¸ ë¡œì§ (ë¬¸ì œ ì„¸íŠ¸ ë¡œë”© ì‹œì‘)
    document.getElementById('student-login-btn').addEventListener('click', async () => {
        const name = studentNameInput.value.trim();
        const accessPassword = studentAccessPassword.value.trim();
        
        if (!name) {
            alert('ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const configSnapshot = await get(ref(db, CONFIG_PATH));
        const requiredPassword = (configSnapshot.val() && configSnapshot.val().studentPassword) ? configSnapshot.val().studentPassword.trim() : '';

        if (requiredPassword && requiredPassword !== accessPassword) {
            alert('ğŸ”’ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        currentStudentId = name.replace(/[.#$/[\]]/g, "_"); 
        document.getElementById('student-login-area').classList.add('hidden');
        studentQuizArea.classList.add('hidden');
        studentSubmittedArea.classList.remove('hidden'); 
        
        localStorage.setItem('quiz_student_name', name); 
        
        // Presence ë“±ë¡: ì ‘ì†í•œ í•™ìƒ ì´ë¦„ê³¼ ì‹œê°„ì„ ê¸°ë¡ (ì ‘ì†ì ëª©ë¡ì— ì‚¬ìš©)
        set(ref(db, `${PRESENCE_PATH}/${currentStudentId}`), { 
            name: name,
            lastSeen: Date.now()
        });

        // ğŸ’¡ [í•µì‹¬] í•™ìƒ ì ‘ì† ì‹œ ë¬¸ì œ ì„¸íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ë° ê¸°ì¡´ ë‹µë³€ ë¡œë“œ
        listenForQuestionSet(); 
        
        // ê¸°ì¡´ ë‹µë³€ ë¡œë“œ
        const studentAnswersSnapshot = await get(ref(db, `${RESPONSES_PATH}/${currentStudentId}`));
        currentStudentAnswers = studentAnswersSnapshot.val() || {};
    });

    document.getElementById('modify-answer-btn').addEventListener('click', () => {
        document.getElementById('student-quiz-area').classList.remove('hidden');
        document.getElementById('student-submitted-area').classList.add('hidden');
        displayCurrentProblem(); // ë¬¸ì œ í’€ì´ ì¬ê°œ ì‹œ í˜„ì¬ ë¬¸ì œ ë‹¤ì‹œ í‘œì‹œ
    });

    studentPasswordInput.addEventListener('change', () => {
        const password = studentPasswordInput.value.trim();
        set(ref(db, CONFIG_PATH), { studentPassword: password });
    });


    // ----------------------------------------------------
    // 5. êµì‚¬ ë¡œì§ (ë¬¸ì œ ê´€ë¦¬ ë° ì¶œì œ)
    // ----------------------------------------------------

    // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] ë¬¸ì œ ëª©ë¡ì— ì €ì¥ ë²„íŠ¼ ë¡œì§
    saveQuestionBtn.addEventListener('click', () => {
        const text = questionTextarea.value.trim();
        if (!text) {
            alert('ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const type = questionTypeSelect.value;
        const options = type === 'MCQ' ? mcqOptionsInput.value.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];
        const correctAnswer = correctAnswerInput.value.trim();
        
        const newManagedQuestion = {
            text: text,
            type: type,
            options: options,
            image: currentImageBase64,
            correctAnswer: correctAnswer || null,
            timestamp: Date.now()
        };

        push(ref(db, MANAGED_QUESTIONS_PATH), newManagedQuestion)
        .then(() => {
            alert('ë¬¸ì œ ëª©ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            questionTextarea.value = '';
            mcqOptionsInput.value = '1. ë„¤, 2. ì•„ë‹ˆì˜¤, 3. ì•„ë§ˆë„, 4. ê¸€ì„ìš”';
            correctAnswerInput.value = '';
            removeImageBtn.click();
        })
        .catch(error => {
            console.error('ë¬¸ì œ ëª©ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œ ëª©ë¡ ì €ì¥ ì‹¤íŒ¨.');
        });
    });

    // ğŸ’¡ [ìˆ˜ì •] ê´€ë¦¬ ë¬¸ì œ ëª©ë¡ ë Œë”ë§ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)
    function renderManagedQuestions(managedQuestionsData) {
        managedQuestionList.innerHTML = '';
        if (!managedQuestionsData) {
            managedQuestionList.innerHTML = '<p class="text-gray-500">ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            loadSetBtn.disabled = true;
            deleteManagedBtn.disabled = true;
            return;
        }

        const questionsArray = Object.entries(managedQuestionsData);
        
        questionsArray.forEach(([key, question], index) => {
            const div = document.createElement('div');
            div.className = 'question-item p-2 border-b';
            div.dataset.key = key; 
            div.textContent = `${index + 1}ë²ˆ. ${question.text.substring(0, 40)}${question.text.length > 40 ? '...' : ''}`;
            
            if (question.image) { div.textContent += ' ğŸ–¼ï¸'; }
            if (question.correctAnswer) { div.textContent += ` (ì •ë‹µ: ${question.correctAnswer})`; }

            div.onclick = (e) => {
                if (!e.ctrlKey && !e.metaKey) {
                    document.querySelectorAll('.question-item').forEach(item => item.classList.remove('selected'));
                }
                div.classList.toggle('selected');

                const selectedCount = document.querySelectorAll('.question-item.selected').length;
                loadSetBtn.disabled = selectedCount === 0;
                deleteManagedBtn.disabled = selectedCount === 0;
            };

            managedQuestionList.appendChild(div);
        });
    }

    // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] ë¬¸ì œ ì„¸íŠ¸ ì¶œì œ ë¡œì§
    loadSetBtn.addEventListener('click', async () => {
        const selectedElements = document.querySelectorAll('.question-item.selected');
        if (selectedElements.length === 0) {
            alert('ì¶œì œí•  ë¬¸ì œë¥¼ ëª©ë¡ì—ì„œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const managedQuestionsSnapshot = await get(ref(db, MANAGED_QUESTIONS_PATH));
        const allManagedQuestions = managedQuestionsSnapshot.val();
        
        if (!allManagedQuestions) return;

        const selectedSet = [];
        selectedElements.forEach(el => {
            const key = el.dataset.key; 
            const question = allManagedQuestions[key];
            
            question.problemId = key; 
            question.isClosed = false;
            question.isSavedToHistory = false;
            selectedSet.push(question);
        });
        
        await saveCurrentQuestionSetToHistory(); // ì´ì „ ë¬¸ì œ ê¸°ë¡ ì €ì¥

        // ğŸ’¡ [í•µì‹¬] ë¬¸ì œ ì„¸íŠ¸ë¥¼ Firebaseì— ì €ì¥
        set(ref(db, QUESTION_SET_PATH), selectedSet)
        .then(() => {
            alert(`ì´ ${selectedSet.length} ë¬¸ì œê°€ ì¶œì œë˜ì—ˆìŠµë‹ˆë‹¤!`);
            remove(ref(db, RESPONSES_PATH)); // ê¸°ì¡´ ì‘ë‹µ ëª¨ë‘ ì´ˆê¸°í™” (ìƒˆ ì„¸íŠ¸ ì‹œì‘)
            update(ref(db, STATUS_PATH), { isClosed: false });
            document.getElementById('submission-status-teacher').classList.add('hidden');
        })
        .catch(error => {
            console.error('ë¬¸ì œ ì„¸íŠ¸ ì¶œì œ ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œ ì„¸íŠ¸ ì¶œì œ ì‹¤íŒ¨.');
        });
    });

    // ğŸ’¡ [ì¶”ê°€] ê´€ë¦¬ ë¬¸ì œ ì‚­ì œ ë¡œì§
    deleteManagedBtn.addEventListener('click', () => {
        const selectedElements = document.querySelectorAll('.question-item.selected');
        if (selectedElements.length === 0) {
            alert('ì‚­ì œí•  ë¬¸ì œë¥¼ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!confirm('ì •ë§ë¡œ ì„ íƒëœ ë¬¸ì œë“¤ì„ ê´€ë¦¬ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const updates = {};
        selectedElements.forEach(el => {
            const key = el.dataset.key;
            updates[key] = null; // ì‚­ì œí•  ë¬¸ì œë¥¼ ì—…ë°ì´íŠ¸ ê°ì²´ì— ì¶”ê°€
        });

        update(ref(db, MANAGED_QUESTIONS_PATH), updates)
        .then(() => {
            alert('ì„ íƒëœ ë¬¸ì œë“¤ì´ ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadSetBtn.disabled = true;
            deleteManagedBtn.disabled = true;
        })
        .catch(error => {
            console.error('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨.');
        });
    });

    // ğŸ’¡ [í•µì‹¬] ê¸°ë¡ ì €ì¥ í•¨ìˆ˜ (ë¬¸ì œ ì„¸íŠ¸ ë‹¨ìœ„)
    async function saveCurrentQuestionSetToHistory() {
        const setSnapshot = await get(ref(db, QUESTION_SET_PATH));
        const responsesSnapshot = await get(ref(db, RESPONSES_PATH));
        
        const questionSetData = setSnapshot.val();
        const responsesData = responsesSnapshot.val();
        
        if (questionSetData && Array.isArray(questionSetData) && questionSetData.length > 0) {
            
            if (!questionSetData[0].isSavedToHistory) {
                 const historyEntry = {
                    questionSet: questionSetData,
                    responses: responsesData || {},
                    date: new Date().toLocaleString('ko-KR'),
                    type: 'SET'
                };
                push(ref(db, HISTORY_PATH), historyEntry);
                
                const updatedSet = [...questionSetData];
                updatedSet[0].isSavedToHistory = true;
                update(ref(db, QUESTION_SET_PATH), updatedSet); 

                return true; 
            }
        }
        return false; 
    }
    
    // â›” ë‹µë³€ ë§ˆê° ë²„íŠ¼: ê¸°ë¡ ì €ì¥ í›„ ìƒíƒœ ë³€ê²½ (V16.0 ìœ ì§€)
    document.getElementById('close-submission-btn').addEventListener('click', async () => {
        if (!confirm("í˜„ì¬ ë¬¸ì œ ì„¸íŠ¸ì— ëŒ€í•œ í•™ìƒë“¤ì˜ ë‹µë³€ ìˆ˜ì • ë° ì œì¶œì„ ë§ˆê°í•˜ê³  ê¸°ë¡ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        await saveCurrentQuestionSetToHistory(); 
        
        update(ref(db, STATUS_PATH), { isClosed: true })
        .then(() => {
            alert('ë‹µë³€ ë§ˆê°ì´ ì™„ë£Œë˜ê³  ê¸°ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('submission-status-teacher').classList.remove('hidden');
        });
    });

    // ë¬¸ì œ ìˆ¨ê¸°ê¸° ê¸°ëŠ¥ (V16.0 ìœ ì§€)
    document.getElementById('hide-question-btn').addEventListener('click', async () => {
        if (!confirm("í˜„ì¬ ì¶œì œëœ ë¬¸ì œë¥¼ í•™ìƒ í™”ë©´ì—ì„œ ìˆ¨ê¸°ê³  ê¸°ë¡ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        await saveCurrentQuestionSetToHistory();
        
        set(ref(db, QUESTION_SET_PATH), null)
        .then(() => {
            alert('ë¬¸ì œê°€ í•™ìƒ í™”ë©´ì—ì„œ ìˆ¨ê²¨ì¡ŒìŠµë‹ˆë‹¤. ê¸°ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            remove(ref(db, RESPONSES_PATH)); 
            update(ref(db, STATUS_PATH), { isClosed: true });
        });
    });

    // í˜„ì¬ ì‘ë‹µ ì´ˆê¸°í™” (V16.0 ìœ ì§€)
    document.getElementById('clear-results-btn').addEventListener('click', () => {
        if (!confirm("ëª¨ë“  ì‘ë‹µ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        remove(ref(db, RESPONSES_PATH))
        .then(() => {
            alert('ì‘ë‹µ ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
    });

    // ğŸ’£ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™” ë²„íŠ¼ ë¡œì§ (V16.0 ìœ ì§€)
    document.getElementById('clear-history-btn').addEventListener('click', () => {
        if (!confirm("ê²½ê³ : ëˆ„ì ëœ ëª¨ë“  ê³¼ê±° í€´ì¦ˆ ê¸°ë¡ì„ ì˜êµ¬íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
        
        remove(ref(db, HISTORY_PATH))
        .then(() => {
            remove(ref(db, QUESTION_SET_PATH));
            remove(ref(db, RESPONSES_PATH));
            remove(ref(db, PRESENCE_PATH));
            remove(ref(db, MANAGED_QUESTIONS_PATH)); 
            
            alert('ëª¨ë“  ê³¼ê±° ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¶œì œ ë¬¸ì œëŠ” 1ë²ˆë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤.');
            renderHistoryList(null); 
            renderManagedQuestions(null);
        });
    });


    // ----------------------------------------------------
    // 7. í•™ìƒ ë¡œì§ (ìˆœì°¨ í’€ì´ ë° ë‹µë³€ ì €ì¥)
    // ----------------------------------------------------
    
    // ğŸ’¡ [í•µì‹¬] ë¬¸ì œ íƒìƒ‰ ë¡œì§
    function navigateProblem(direction) {
        saveAnswer(); // í˜„ì¬ ë¬¸ì œ ë‹µë³€ ì €ì¥

        const newIndex = currentProblemIndex + direction;
        if (newIndex >= 0 && newIndex < currentQuizSet.length) {
            currentProblemIndex = newIndex;
            displayCurrentProblem();
        }

        prevProblemBtn.disabled = currentProblemIndex === 0;
        nextProblemBtn.disabled = currentProblemIndex === currentQuizSet.length - 1;
    }

    // ğŸ’¡ [í•µì‹¬] í˜„ì¬ ë¬¸ì œ í‘œì‹œ ë° ë¡œë“œ
    function displayCurrentProblem() {
        const problem = currentQuizSet[currentProblemIndex];
        if (!problem) return;

        problemNumberDisplay.textContent = `${currentProblemIndex + 1}ë²ˆ ë¬¸ì œ`;
        setSizeDisplay.textContent = `(ì´ ${currentQuizSet.length} ë¬¸ì œ)`;
        document.getElementById('student-question-text').textContent = problem.text || '';
        
        // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        if (problem.image) {
            document.getElementById('student-question-image').src = problem.image;
            document.getElementById('student-question-image-container').classList.remove('hidden');
        } else {
            document.getElementById('student-question-image-container').classList.add('hidden');
        }

        // ì…ë ¥ í•„ë“œ ë Œë”ë§
        renderStudentInputs(problem);
        
        // ğŸ’¡ [í•µì‹¬] ê¸°ì¡´ ë‹µë³€ ë¡œë“œ ë° í•„ë“œ ì±„ìš°ê¸°
        const problemKey = problem.problemId || `Problem_${currentProblemIndex}`;
        const currentAnswer = currentStudentAnswers[problemKey] ? currentStudentAnswers[problemKey].answer : null;

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.querySelectorAll('input[name="student-answer"]').forEach(r => r.checked = false);
        if (document.getElementById('short-answer-input')) {
             document.getElementById('short-answer-input').value = '';
        }

        if (currentAnswer) {
            if (problem.type === 'ShortAnswer' && document.getElementById('short-answer-input')) {
                document.getElementById('short-answer-input').value = currentAnswer;
            } else if (problem.type === 'MCQ' || problem.type === 'OX') {
                const radio = document.querySelector(`input[value="${currentAnswer}"]`);
                if (radio) radio.checked = true;
            }
        }
    }
    
    // ğŸ’¡ [í•µì‹¬] ë¬¸ì œ ì„¸íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•™ìƒ ëª¨ë“œ)
    function listenForQuestionSet() {
        onValue(ref(db, QUESTION_SET_PATH), async (snapshot) => {
            const set = snapshot.val();
            currentQuizSet = set || [];
            
            if (currentQuizSet.length > 0) {
                // ì„¸íŠ¸ê°€ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” ë° ì²« ë²ˆì§¸ ë¬¸ì œ í‘œì‹œ
                currentProblemIndex = 0;
                
                // ğŸ’¡ [ìˆ˜ì •] ê¸°ì¡´ ë‹µë³€ ë‹¤ì‹œ ë¡œë“œ
                const studentAnswersSnapshot = await get(ref(db, `${RESPONSES_PATH}/${currentStudentId}`));
                currentStudentAnswers = studentAnswersSnapshot.val() || {};

                document.getElementById('navigation-buttons').classList.remove('hidden');
                
                displayCurrentProblem();
                navigateProblem(0); // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                
            } else {
                // ë¬¸ì œ ì„¸íŠ¸ê°€ ì—†ìœ¼ë©´ ëŒ€ê¸° ìƒíƒœë¡œ ìœ ì§€
                document.getElementById('student-question-text').textContent = '[ì„ ìƒë‹˜ì´ ë¬¸ì œ ì„¸íŠ¸ë¥¼ ì¶œì œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.]';
                document.getElementById('navigation-buttons').classList.add('hidden');
            }
        });
    }

    // ğŸ’¡ [í•µì‹¬] ë‹µë³€ ì €ì¥ (ë²„íŠ¼ ë° í˜ì´ì§€ ì´ë™ ì‹œ í˜¸ì¶œ)
    function saveAnswer() {
        if (!currentStudentId || currentQuizSet.length === 0) return;

        const currentProblem = currentQuizSet[currentProblemIndex];
        const problemKey = currentProblem.problemId || `Problem_${currentProblemIndex}`;
        let answer = null;
        
        if (currentProblem.type === 'ShortAnswer') {
            const input = document.getElementById('short-answer-input');
            answer = input ? input.value.trim() : null;
        } else {
            const selected = document.querySelector('input[name="student-answer"]:checked');
            answer = selected ? selected.value : null;
        }

        if (!answer) return;

        // ğŸ’¡ [ìˆ˜ì •] ë¡œì»¬ ê°ì²´ì— ì €ì¥ (ê°ì²´ êµ¬ì¡° ë³€ê²½)
        currentStudentAnswers[problemKey] = { answer: answer, timestamp: Date.now() };
        
        // ğŸ’¡ [í•µì‹¬] Firebaseì— í•™ìƒ ë‹µë³€ì„ [í•™ìƒID]/[ë¬¸ì œID] ê²½ë¡œì— ì €ì¥
        set(ref(db, `${RESPONSES_PATH}/${currentStudentId}/${problemKey}`), {
            answer: answer,
            timestamp: Date.now()
        });
    }

    // ğŸ’¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    nextProblemBtn.addEventListener('click', () => navigateProblem(1));
    prevProblemBtn.addEventListener('click', () => navigateProblem(-1));
    document.getElementById('submit-answer-btn').addEventListener('click', () => {
        saveAnswer();
        document.getElementById('student-quiz-area').classList.add('hidden');
        document.getElementById('student-submitted-area').classList.remove('hidden'); 
    });
    
    // ... (renderStudentInputs í•¨ìˆ˜ ìœ ì§€) ...
    function renderStudentInputs(question) {
        document.getElementById('student-answer-buttons').innerHTML = ''; 
        document.getElementById('submit-answer-btn').classList.remove('hidden');
        
        if (question.type === 'OX') {
            const options = ['O', 'X'];
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = `p-5 text-2xl font-bold rounded-lg ${option === 'O' ? 'bg-green-100 hover:bg-green-200 text-green-700' : 'bg-red-100 hover:bg-red-200 text-red-700'}`;
                btn.textContent = option;
                btn.setAttribute('onclick', `(function(){ saveAnswer(); submitAnswer('${option}'); })();`); 
                document.getElementById('student-answer-buttons').appendChild(btn);
            });
            document.getElementById('submit-answer-btn').classList.add('hidden'); 
            
        } else if (question.type === 'MCQ' && question.options && question.options.length > 0) {
            question.options.forEach((option, index) => {
                const radioId = `mcq-option-${index}`;
                const div = document.createElement('div');
                div.className = 'flex items-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 cursor-pointer';

                const input = document.createElement('input');
                input.type = 'radio';
                input.id = radioId;
                input.name = 'student-answer';
                input.value = option;
                input.className = 'w-6 h-6 text-yellow-600 focus:ring-yellow-500 mr-4';
                
                const label = document.createElement('label');
                label.htmlFor = radioId;
                label.textContent = option;
                label.className = 'text-xl font-medium text-gray-700 flex-1';

                div.appendChild(input);
                div.appendChild(label);
                document.getElementById('student-answer-buttons').appendChild(div);
            });
            document.getElementById('submit-answer-btn').classList.remove('hidden'); 

        } else if (question.type === 'ShortAnswer') {
            const input = document.createElement('textarea');
            input.id = 'short-answer-input';
            input.rows = 4;
            input.className = 'w-full border rounded p-4 text-xl';
            input.placeholder = 'ë‹µë³€ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.';
            document.getElementById('student-answer-buttons').appendChild(input);
            document.getElementById('submit-answer-btn').classList.remove('hidden');
        } else {
             document.getElementById('student-question-text').textContent = '[ì„ ìƒë‹˜ì´ ë¬¸ì œ ìœ í˜• ë˜ëŠ” ë³´ê¸°ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.]';
             document.getElementById('submit-answer-btn').classList.add('hidden');
        }
    }


    // ----------------------------------------------------
    // 9. ìµœì¢… ê²°ê³¼ í‘œì‹œ ë° ì—‘ì…€ ë¡œì§ (V16.0 ìœ ì§€)
    // ----------------------------------------------------
    
    function listenForResponses() {
        onValue(ref(db, RESPONSES_PATH), (snapshot) => {
            renderResults(snapshot.val());
        });
    }

    window.kickUser = function(studentName, studentId) {
        if (!confirm(`${studentName} í•™ìƒì„ í‡´ì¥ì‹œí‚¤ê³  ì•„ì´ë””ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        remove(ref(db, `${PRESENCE_PATH}/${studentId}`)); 

        alert(`${studentName} í•™ìƒì˜ ì ‘ì†ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í•´ë‹¹ í•™ìƒì—ê²Œ ì´ë¦„/ë²ˆí˜¸ë¥¼ ì¬ì…ë ¥í•˜ë„ë¡ ì•ˆë‚´í•´ì£¼ì„¸ìš”.`);
    }

    function renderResults(responses) {
        document.getElementById('results-display').innerHTML = '';
        document.getElementById('correct-list-content').innerHTML = '';
        document.getElementById('full-list-content').innerHTML = '';
        
        const filteredResponses = responses || {};
        
        if (Object.keys(filteredResponses).length === 0) {
            document.getElementById('total-responses').textContent = 0;
            document.getElementById('results-display').innerHTML = '<p class="text-gray-500 text-lg">ì•„ì§ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            document.getElementById('correct-respondents-list').classList.add('hidden');
            document.getElementById('full-list-content').textContent = 'ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        const responseList = Object.values(filteredResponses);
        const totalCount = responseList.length;
        document.getElementById('total-responses').textContent = totalCount;

        get(ref(db, QUESTION_SET_PATH)).then((qSnapshot) => {
            const questionSet = qSnapshot.val();
            
            if (!questionSet || questionSet.length === 0) {
                // ë¬¸ì œ ì„¸íŠ¸ê°€ ì—†ìœ¼ë©´ ì „ì²´ ì‘ë‹µ ëª©ë¡ë§Œ í‘œì‹œ
                const responseList = Object.values(filteredResponses);
                let fullListHTML = '';
                responseList.forEach(studentAnswers => {
                    const firstAnswer = Object.values(studentAnswers)[0];
                    if (firstAnswer) {
                        fullListHTML += `<li class="border-b pb-1"><strong>${firstAnswer.name}</strong>: ${Object.keys(studentAnswers).length} ë¬¸ì œ ì‘ë‹µ ì™„ë£Œ</li>`;
                    }
                });
                document.getElementById('full-list-content').innerHTML = `<ul>${fullListHTML}</ul>`;
                return;
            }
            
            // ğŸ’¡ ì‹œí—˜í˜•ì—ì„œëŠ” ì‹¤ì‹œê°„ í†µê³„ê°€ ì˜ë¯¸ ì—†ìœ¼ë¯€ë¡œ, ì „ì²´ ì‘ë‹µ ëª©ë¡ë§Œ ì—…ë°ì´íŠ¸
            let fullListHTML = '';
            
            Object.keys(filteredResponses).forEach(studentId => {
                const studentAnswers = filteredResponses[studentId];
                let correctCount = 0;
                let totalAnswered = 0;
                
                questionSet.forEach(q => {
                    const studentAnswer = studentAnswers[q.problemId];
                    if (studentAnswer && q.correctAnswer) {
                        totalAnswered++;
                        if (studentAnswer.answer.trim().toLowerCase() === q.correctAnswer.trim().toLowerCase()) {
                            correctCount++;
                        }
                    }
                });

                const studentName = Object.values(studentAnswers)[0].name;

                if (Object.keys(studentAnswers).length > 0) {
                    const accuracy = totalAnswered > 0 ? (correctCount / totalAnswered) * 100 : 0;
                    const answerCount = Object.keys(studentAnswers).length;

                    fullListHTML += `<li class="border-b pb-1"><strong>${studentName}</strong>: ${answerCount} ë¬¸ì œ ì‘ë‹µ (ì •ë‹µ ${correctCount}/${totalAnswered} - ${accuracy.toFixed(0)}%)</li>`;
                }
            });
            
            document.getElementById('full-list-content').innerHTML = `<ul>${fullListHTML}</ul>`;
            document.getElementById('results-display').innerHTML = `
                <div class="p-4 bg-yellow-100 rounded">
                    <strong>ì‹œí—˜í˜• ëª¨ë“œ:</strong> í•™ìƒë“¤ì€ ${questionSet.length} ë¬¸ì œ ì¤‘ ìì‹ ì´ í‘¼ ë¬¸ì œì— ëŒ€í•œ ì •ë‹µë¥ ì„ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì „ì²´ ë‹µë³€ ëª©ë¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                </div>
            `;
            
            document.getElementById('correct-respondents-list').classList.add('hidden'); // ì •ë‹µì ëª…ë‹¨ ê¸°ëŠ¥ ë¹„í™œì„±í™”
        });
    }
    
    // ... (ë‚˜ë¨¸ì§€ ì—‘ì…€ í•¨ìˆ˜ ë° ë³´ì¡° í•¨ìˆ˜ ìœ ì§€) ...
    function renderHistoryList(historyData) {
        document.getElementById('history-list').innerHTML = '';
        
        if (!historyData) {
            document.getElementById('history-list').textContent = 'ê¸°ë¡ëœ ê³¼ê±° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        const historyEntries = Object.entries(historyData).reverse(); 
        const historyArray = Object.values(historyData); 
        
        historyEntries.forEach(([key, entry], index) => {
            const isSet = entry.type === 'SET';
            const questionText = isSet ? `ë¬¸ì œ ì„¸íŠ¸ (${entry.questionSet.length}ë¬¸í•­)` : (entry.question.text || 'ë‹¨ì¼ ë¬¸ì œ');
            const responsesCount = Object.keys(entry.responses).length;
            
            const entryNumber = historyArray.length - index;

            const div = document.createElement('div');
            div.className = 'p-4 border border-blue-400 rounded-lg bg-blue-50 cursor-pointer hover:bg-blue-100';
            div.innerHTML = `
                <div class="font-bold text-blue-800">${entryNumber}ë²ˆ ê¸°ë¡: ${questionText.substring(0, 30)}...</div>
                <div class="text-sm text-gray-600">ì¶œì œì¼: ${entry.date} | ì‘ë‹µ: ${responsesCount}ëª…</div>
            `;
            div.onclick = () => showHistoryDetail(entryNumber, entry); 
            document.getElementById('history-list').appendChild(div);
        });
    }

    // ... (ë‚˜ë¨¸ì§€ í•¨ìˆ˜ ìœ ì§€) ...
    // ... (V16.0 ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ ì§€) ...

</script>

</body>
</html>
