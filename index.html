<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ì‹¤ì‹œê°„ ì°¸ì—¬ í€´ì¦ˆ í”Œë«í¼ V7.0 (ê¸°ë¡/ìˆ˜ì • ê°•í™”)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f7f3e9;
            font-size: 18px; 
        }
        .container {
            max-width: 1100px; 
            margin: 2rem auto;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 { font-size: 2.5rem !important; } 
        h2 { font-size: 2rem !important; }
        .text-xl { font-size: 1.5rem !important; }
        .text-2xl { font-size: 1.875rem !important; }
        #student-question-text { font-size: 3rem !important; line-height: 1.4; } 
        
        .result-bar {
            height: 35px; 
            margin-bottom: 8px;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        .correct-answer-highlight {
            background-color: #d1f7d1; 
            font-weight: bold;
            border-left: 5px solid #4CAF50; 
            padding: 5px;
            margin: 3px 0;
            border-radius: 4px;
        }
        #student-answer-buttons button {
            transition: all 0.2s;
            font-size: 1.3rem;
        }
        .text-lg { font-size: 1.125rem !important; }
        .text-base { font-size: 1rem !important; }
        
        /* ë‹µë³€ ë§ˆê° ìƒíƒœ í‘œì‹œ */
        .submission-closed {
            background-color: #fca5a5; /* Red-300 */
            color: #7f1d1d; /* Red-900 */
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="font-bold text-center mb-10 text-indigo-700">ğŸš€ ì‹¤ì‹œê°„ ìˆ˜ì—… ì°¸ì—¬ í”Œë«í¼ V7.0</h1>
    
    <div id="mode-selection" class="flex justify-center space-x-6 mb-8">
        <button id="teacher-mode-btn" class="mode-button bg-red-500 text-white p-4 rounded-lg shadow-md font-semibold text-xl">
            ğŸ‘©â€ğŸ« êµì‚¬ ëª¨ë“œ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
        </button>
        <button id="student-mode-btn" class="mode-button bg-blue-500 text-white p-4 rounded-lg shadow-md font-semibold text-xl">
            ğŸ§‘â€ğŸ“ í•™ìƒ ëª¨ë“œ
        </button>
    </div>

    <hr class="mb-8 border-gray-300">

    <div id="teacher-panel" class="hidden">
        <h2 class="font-bold mb-5 text-red-600">êµì‚¬ ì œì–´íŒ</h2>
        
        <div class="p-8 border border-red-300 rounded-lg bg-red-50 mb-8">
            <label for="question-text" class="block font-semibold mb-3">ğŸ“ ì§ˆë¬¸ ë‚´ìš©:</label>
            <textarea id="question-text" rows="3" class="w-full border rounded p-3 mb-5 text-lg"></textarea>

            <label class="block font-semibold mb-3">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²¨ë¶€:</label>
            <div id="image-upload-area" class="border-2 border-dashed border-gray-400 p-5 mb-5 rounded-lg bg-white">
                <input type="file" id="image-file-input" accept="image/*" class="mb-3 block w-full text-lg">
                <p class="text-gray-600 text-base">ë˜ëŠ”, ì´ë¯¸ì§€ íŒŒì¼ì„ **ì´ ì˜ì—­ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)** í•˜ì„¸ìš”.</p>
                <div id="image-preview" class="mt-3 text-center hidden">
                    <p class="mb-2">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°:</p>
                    <img src="" id="current-image-preview" class="max-w-full h-auto mx-auto border border-gray-300 rounded max-h-64">
                    <button id="remove-image-btn" class="mt-3 bg-gray-400 hover:bg-gray-500 text-white p-2 rounded text-base">
                        âŒ ì´ë¯¸ì§€ ì œê±°
                    </button>
                </div>
            </div>

            <label for="question-type" class="block font-semibold mb-3">â“ ì§ˆë¬¸ ìœ í˜•:</label>
            <select id="question-type" class="w-full border rounded p-3 mb-5 bg-white text-lg">
                <option value="MCQ">ê°ê´€ì‹ (ë‹¤ì§€ì„ ë‹¤)</option>
                <option value="OX">OX í€´ì¦ˆ</option>
                <option value="ShortAnswer">ì£¼ê´€ì‹ (ë‹¨ë‹µí˜•)</option>
            </select>
            
            <div id="mcq-options-container">
                <label for="mcq-options" class="block font-semibold mb-3">ğŸ”¢ ê°ê´€ì‹ ë³´ê¸° (ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„):</label>
                <input type="text" id="mcq-options" class="w-full border rounded p-3 text-lg" value="1. ë„¤, 2. ì•„ë‹ˆì˜¤, 3. ì•„ë§ˆë„, 4. ê¸€ì„ìš”">
            </div>

            <label for="correct-answer-input" class="block font-semibold mb-3 mt-5">ğŸ”‘ ì •ë‹µ ì…ë ¥ (ì„ íƒ ì‚¬í•­):</label>
            <input type="text" id="correct-answer-input" class="w-full border rounded p-3 text-lg" placeholder="ì˜ˆ: 3ë²ˆ ë˜ëŠ” ì •ë‹µ í…ìŠ¤íŠ¸ (ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì •ë‹µì í‘œì‹œ ì•ˆë¨)">


            <div class="flex space-x-3 mt-6">
                <button id="post-question-btn" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ğŸ“¢ ë¬¸ì œ ì¶œì œí•˜ê¸°
                </button>
                <button id="close-submission-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-4 rounded-lg font-semibold w-1/4 text-xl">
                    â›” ë‹µë³€ ë§ˆê°
                </button>
            </div>
            <div class="flex space-x-3 mt-3">
                <button id="hide-question-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ğŸ™ˆ ë¬¸ì œ ìˆ¨ê¸°ê¸°
                </button>
                <button id="clear-results-btn" class="bg-gray-400 hover:bg-gray-500 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ğŸ—‘ í˜„ì¬ ì‘ë‹µ ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <div class="p-8 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-bold mb-5 flex justify-between">
                <span>ğŸ“Š ì‹¤ì‹œê°„ ì‘ë‹µ í˜„í™© (<span id="total-responses">0</span>ëª… ì°¸ì—¬)</span>
                <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-base">
                    â¬‡ï¸ ì‘ë‹µ EXCEL ë‹¤ìš´ë¡œë“œ
                </button>
            </h3>
            
            <div id="submission-status-teacher" class="text-center p-3 rounded mb-4 text-xl submission-closed hidden">
                â›” í˜„ì¬ ë‹µë³€ ìˆ˜ì •ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>

            <div id="results-display" class="space-y-4">
                <p class="text-gray-500 text-lg">ë¬¸ì œê°€ ì¶œì œë˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            
            <div id="correct-respondents-list" class="mt-8 border-t pt-5 hidden">
                 <h4 class="text-xl font-bold mb-4 text-green-600">âœ… ì •ë‹µì ëª…ë‹¨</h4>
                 <div id="correct-list-content" class="text-lg">ì •ë‹µì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì •ë‹µìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>

            <div id="respondents-full-list" class="mt-8 border-t pt-5">
                 <h4 class="text-xl font-bold mb-4 text-gray-700">ğŸ§‘â€ğŸ“ ì „ì²´ ë‹µë³€ì ëª©ë¡ (ë‹µë³€ í¬í•¨)</h4>
                 <div id="full-list-content" class="text-lg space-y-2">ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
        
        <div class="p-8 border border-blue-300 rounded-lg bg-blue-50 mt-8">
            <h3 class="text-2xl font-bold mb-4 text-blue-700">ğŸ“‚ ëˆ„ì ëœ ê³¼ê±° í€´ì¦ˆ ê¸°ë¡ ë³´ê¸°</h3>
            <div id="history-list" class="text-lg space-y-4">ê¸°ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="student-panel" class="hidden">
        <h2 class="font-bold mb-5 text-blue-600">í•™ìƒ ì‘ë‹µì°½</h2>
        
        <div id="student-login-area" class="p-8 border border-blue-300 rounded-lg bg-blue-50 mb-8">
            <label for="student-name" class="block font-semibold mb-3 text-lg">ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ ì…ë ¥:</label>
            <input type="text" id="student-name" class="w-full border rounded p-3 mb-5 text-xl" placeholder="ì˜ˆ: 1ë²ˆ ê¹€ì² ìˆ˜">
            <button id="student-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-semibold w-full text-xl">
                âœ… ì°¸ì—¬ ì‹œì‘
            </button>
        </div>

        <div id="student-quiz-area" class="hidden">
            <div class="p-8 border border-gray-300 rounded-lg bg-white mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">í˜„ì¬ ì§ˆë¬¸:</h3>
                <div id="student-question-image-container" class="mb-6 hidden">
                    <img src="" id="student-question-image" class="max-w-full h-auto mx-auto border border-gray-200 rounded max-h-80">
                </div>
                <p id="student-question-text" class="font-extrabold text-gray-800 mb-6 text-center">
                    [ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ì¶œì œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.]
                </p>
                
                <div id="submission-status-student" class="text-center p-3 rounded mb-4 text-xl submission-closed hidden">
                    â›” ë‹µë³€ ìˆ˜ì •ì´ ë§ˆê°ë˜ì–´ ì œì¶œ/ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>

                <div id="student-answer-buttons" class="grid grid-cols-2 gap-4 mb-4">
                </div>
                
                <button id="submit-answer-btn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-semibold w-full text-xl hidden">
                    ğŸš€ ë‹µë³€ ì œì¶œí•˜ê¸°
                </button>
                <p id="submission-status-msg" class="text-center mt-3 text-green-700 font-semibold text-2xl hidden">
                    âœ… ë‹µë³€ ì œì¶œì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! (ìˆ˜ì • ê°€ëŠ¥)
                </p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"; 
    import { getDatabase, ref, set, onValue, remove, push, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ----------------------------------------------------
    // 1. Firebase ì„¤ì •
    // ----------------------------------------------------
    const firebaseConfig = {
        // [ì„ ìƒë‹˜ì˜ ì‹¤ì œ Firebase ì„¤ì • ì •ë³´]
        apiKey: "AIzaSyAN1iAC82xKL_haJUs9291YBKNv7g7WSvU",
        authDomain: "foranswering-afec8.firebaseapp.com",
        databaseURL: "https://foranswering-afec8-default-rtdb.firebaseio.com",
        projectId: "foranswering-afec8",
        storageBucket: "foranswering-afec8.firebasestorage.app",
        messagingSenderId: "291098085525",
        appId: "1:291098085525:web:883a852c6320859294339c",
        measurementId: "G-5LP4KEWLXR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); 

    // ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ì •ì˜ (ê¸°ë¡ ê²½ë¡œ ì¶”ê°€)
    const STATUS_PATH = 'quiz/status'; // ë‹µë³€ ë§ˆê° ìƒíƒœ ì €ì¥
    const QUESTION_PATH = 'quiz/currentQuestion';
    const RESPONSES_PATH = 'quiz/responses';
    const HISTORY_PATH = 'quiz/history'; // ëˆ„ì  ê¸°ë¡ ì €ì¥ ê²½ë¡œ

    // ----------------------------------------------------
    // 2. ë³€ìˆ˜ ë° UI ìš”ì†Œ ì •ì˜
    // ----------------------------------------------------
    const TEACHER_PASSWORD = "2948"; 
    let currentStudentId = null; 
    let currentQuestionType = 'MCQ';
    let currentQuestionKey = null; // í˜„ì¬ ë¬¸ì œì˜ ê³ ìœ  í‚¤ (ê¸°ë¡ ì €ì¥ìš©)
    let currentImageBase64 = null; 

    // UI ìš”ì†Œ
    const teacherPanel = document.getElementById('teacher-panel');
    const studentPanel = document.getElementById('student-panel');
    const modeSelection = document.getElementById('mode-selection');
    const questionTextarea = document.getElementById('question-text');
    const questionTypeSelect = document.getElementById('question-type');
    const mcqOptionsInput = document.getElementById('mcq-options');
    const correctAnswerInput = document.getElementById('correct-answer-input'); 
    const totalResponsesEl = document.getElementById('total-responses');
    const resultsDisplay = document.getElementById('results-display');
    const correctRespondentsList = document.getElementById('correct-respondents-list'); 
    const correctListContent = document.getElementById('correct-list-content');
    const fullListContent = document.getElementById('full-list-content'); // ì „ì²´ ë‹µë³€ ëª©ë¡
    const studentQuestionTextEl = document.getElementById('student-question-text');
    const studentAnswerButtonsEl = document.getElementById('student-answer-buttons');
    const studentNameInput = document.getElementById('student-name');
    const studentQuizArea = document.getElementById('student-quiz-area');
    const studentLoginArea = document.getElementById('student-login-area');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const submissionStatusMsg = document.getElementById('submission-status-msg'); // í•™ìƒ ì œì¶œ ì™„ë£Œ ë©”ì‹œì§€
    const submissionStatusTeacher = document.getElementById('submission-status-teacher'); // êµì‚¬ ë§ˆê° ìƒíƒœ
    const submissionStatusStudent = document.getElementById('submission-status-student'); // í•™ìƒ ë§ˆê° ìƒíƒœ
    const imageFileInput = document.getElementById('image-file-input');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const hideQuestionBtn = document.getElementById('hide-question-btn'); 
    const exportExcelBtn = document.getElementById('export-excel-btn'); // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    const closeSubmissionBtn = document.getElementById('close-submission-btn'); // ë‹µë³€ ë§ˆê° ë²„íŠ¼
    const historyList = document.getElementById('history-list'); // ê¸°ë¡ ëª©ë¡


    // ----------------------------------------------------
    // 3. ì´ë¯¸ì§€ ë° ëª¨ë“œ ì „í™˜ ë¡œì§ (V6.0ê³¼ ë™ì¼)
    // ----------------------------------------------------
    // (ê°„ê²°í•¨ì„ ìœ„í•´ ìƒëµ: ì´ ë¶€ë¶„ì€ V6.0ì˜ 3, 4ë²ˆ ë¡œì§ê³¼ ë™ì¼í•©ë‹ˆë‹¤.)
    // * ì´ë¯¸ì§€ ë¡œì§ (setImage, FileInput, Paste, RemoveBtn)
    // * ëª¨ë“œ ì „í™˜ ë¡œì§ (Teacher/Student ë²„íŠ¼, Name Input)

    // ëª¨ë“ˆì´ ë§ì•„ ì½”ë“œ ì „ì²´ë¥¼ ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì´ ë¶€ë¶„ì€ ì´ì „ V6.0 ì½”ë“œë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”. 
    // V6.0ì˜ 3ë²ˆ ì„¹ì…˜(ì´ë¯¸ì§€) ë° 4ë²ˆ ì„¹ì…˜(ëª¨ë“œ ì „í™˜) ë¡œì§ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
    
    // ì´ ì„ì‹œ í•¨ìˆ˜ë“¤ì€ V6.0ì—ì„œ ë³µì‚¬ ë¶™ì—¬ë„£ê¸°ë¥¼ ì™„ë£Œí•˜ì…¨ë‹¤ëŠ” ê°€ì • í•˜ì— ì„ ì–¸ë©ë‹ˆë‹¤.
    // ** ì‹¤ì œ V7.0 íŒŒì¼ì—ì„œëŠ” V6.0ì˜ í•´ë‹¹ ì½”ë“œê°€ ì—¬ê¸°ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. **

    // (V6.0ì˜ 3ë²ˆ ì´ë¯¸ì§€ ë¡œì§ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”)
    // (V6.0ì˜ 4ë²ˆ ëª¨ë“œ ì „í™˜ ë¡œì§ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”)


    // ----------------------------------------------------
    // 4. êµì‚¬ ë¡œì§ (ë¬¸ì œ ì¶œì œ, ë§ˆê°, ê¸°ë¡)
    // ----------------------------------------------------

    document.getElementById('post-question-btn').addEventListener('click', postQuestion);

    async function postQuestion() {
        // ê¸°ì¡´ ë¬¸ì œ ê¸°ë¡ ì €ì¥
        await saveCurrentQuestionToHistory();

        const text = questionTextarea.value.trim();
        const type = questionTypeSelect.value;
        const options = type === 'MCQ' ? mcqOptionsInput.value.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];
        const correctAnswer = correctAnswerInput.value.trim(); 

        if (!text && !currentImageBase64) {
            alert('ì§ˆë¬¸ ë‚´ìš© ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì…ë ¥/ì²¨ë¶€í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ìƒˆ ë¬¸ì œ ë°ì´í„°
        const newQuestion = {
            text: text,
            type: type,
            options: options,
            image: currentImageBase64,
            correctAnswer: correctAnswer || null, 
            isClosed: false, // ê¸°ë³¸ì ìœ¼ë¡œ ë‹µë³€ì€ ì—´ë¦° ìƒíƒœ
            timestamp: Date.now()
        };

        // DBì— ìƒˆ ì§ˆë¬¸ ì„¤ì •
        set(ref(db, QUESTION_PATH), newQuestion)
        .then(() => {
            alert('ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶œì œë˜ì—ˆìŠµë‹ˆë‹¤! ë‹µë³€ì´ ì‹œì‘ë©ë‹ˆë‹¤.');
            remove(ref(db, RESPONSES_PATH)); 
            removeImageBtn.click();
            correctAnswerInput.value = ''; 
            
            // ë‹µë³€ ìƒíƒœ ì´ˆê¸°í™” ë° êµì‚¬ UI ì—…ë°ì´íŠ¸
            update(ref(db, STATUS_PATH), { isClosed: false });
            submissionStatusTeacher.classList.add('hidden');
        })
        .catch(error => {
            console.error('ë¬¸ì œ ì¶œì œ ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œ ì¶œì œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });
    }

    // ğŸ’¡ ë‹µë³€ ìˆ˜ì • ë§ˆê° ê¸°ëŠ¥
    closeSubmissionBtn.addEventListener('click', closeSubmission);

    function closeSubmission() {
        if (!confirm("í˜„ì¬ ë¬¸ì œì— ëŒ€í•œ í•™ìƒë“¤ì˜ ë‹µë³€ ìˆ˜ì • ë° ì œì¶œì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        // ë‹µë³€ ìƒíƒœë¥¼ ë‹«ìŒìœ¼ë¡œ ì—…ë°ì´íŠ¸
        update(ref(db, STATUS_PATH), { isClosed: true })
        .then(() => {
            alert('ë‹µë³€ ë§ˆê°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            submissionStatusTeacher.classList.remove('hidden');
        })
        .catch(error => {
            console.error('ë‹µë³€ ë§ˆê° ì‹¤íŒ¨:', error);
        });
    }

    // ğŸ’¡ ë¬¸ì œ ìˆ¨ê¸°ê¸° ê¸°ëŠ¥ (ê¸°ë¡ ì €ì¥ í›„ ì‚­ì œ)
    hideQuestionBtn.addEventListener('click', async () => {
        if (!confirm("í˜„ì¬ ì¶œì œëœ ë¬¸ì œë¥¼ í•™ìƒ í™”ë©´ì—ì„œ ìˆ¨ê¸°ê³  ê¸°ë¡ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        await saveCurrentQuestionToHistory();
        
        // currentQuestion ë…¸ë“œ ì‚­ì œ
        set(ref(db, QUESTION_PATH), null)
        .then(() => {
            alert('ë¬¸ì œê°€ í•™ìƒ í™”ë©´ì—ì„œ ìˆ¨ê²¨ì¡ŒìŠµë‹ˆë‹¤. ê¸°ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            remove(ref(db, RESPONSES_PATH)); 
            update(ref(db, STATUS_PATH), { isClosed: true }); // ìƒíƒœë„ ë§ˆê°ìœ¼ë¡œ ë³€ê²½
        })
        .catch(error => {
            console.error('ë¬¸ì œ ìˆ¨ê¸°ê¸° ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œ ìˆ¨ê¸°ê¸° ì‹¤íŒ¨.');
        });
    });

    // ğŸ’¡ í˜„ì¬ ë¬¸ì œì™€ ì‘ë‹µì„ ê¸°ë¡ì— ì €ì¥í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
    async function saveCurrentQuestionToHistory() {
        const questionSnapshot = await get(ref(db, QUESTION_PATH));
        const responsesSnapshot = await get(ref(db, RESPONSES_PATH));
        
        const questionData = questionSnapshot.val();
        const responsesData = responsesSnapshot.val();
        
        // í˜„ì¬ ë¬¸ì œ ë°ì´í„°ê°€ ì¡´ì¬í•  ë•Œë§Œ ì €ì¥
        if (questionData && questionData.text) {
            const historyEntry = {
                question: questionData,
                responses: responsesData || {},
                date: new Date().toLocaleString('ko-KR')
            };
            // history ê²½ë¡œì— ìƒˆë¡œìš´ ê³ ìœ  í‚¤ë¡œ ì €ì¥
            push(ref(db, HISTORY_PATH), historyEntry);
        }
    }


    // ----------------------------------------------------
    // 5. í•™ìƒ ë¡œì§ (ì œì¶œ ë©”ì‹œì§€ ëª…ë£Œí™” ë° ìˆ˜ì • ê°€ëŠ¥)
    // ----------------------------------------------------

    // ğŸ’¡ ë‹µë³€ ì œì¶œ ë¡œì§ (ìˆ˜ì • í—ˆìš©)
    submitAnswerBtn.addEventListener('click', () => {
        // ... (V6.0ì˜ submitAnswerBtn ë¡œì§ì„ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤)
    });
    
    function submitAnswer(answer) {
        if (!currentStudentId) {
            alert('ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì°¸ì—¬ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ** (ìˆ˜ì • ê¸°ëŠ¥ í™œì„±í™”): ì´ë¯¸ ì‘ë‹µí–ˆì–´ë„ ë®ì–´ì“°ê¸° í•©ë‹ˆë‹¤. **
        set(ref(db, `${RESPONSES_PATH}/${currentStudentId}`), {
            name: studentNameInput.value.trim(),
            answer: answer,
            timestamp: Date.now()
        })
        .then(() => {
            // ğŸ’¡ ì œì¶œ ì™„ë£Œ ë©”ì‹œì§€ ëª…ë£Œí™”
            submissionStatusMsg.classList.remove('hidden'); 
            submitAnswerBtn.textContent = 'ë‹µë³€ ìˆ˜ì • ì™„ë£Œ!'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            
            // ğŸ’¡ ë‹µë³€ ìˆ˜ì • ê°€ëŠ¥: í•„ë“œ ë¹„í™œì„±í™” ë¡œì§ ì œê±°
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í”Œë˜ê·¸ ì œê±° (ìˆ˜ì • ê°€ëŠ¥ ìƒíƒœ ìœ ì§€)
            localStorage.removeItem('quiz_responded');
        })
        .catch(error => {
            console.error('ë‹µë³€ ì œì¶œ ì‹¤íŒ¨:', error);
            alert('ë‹µë³€ ì œì¶œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });
    }

    // ğŸ’¡ í•™ìƒ ìƒíƒœ ë³€í™” ë¦¬ìŠ¤ë„ˆ (ë‹µë³€ ë§ˆê° ìƒíƒœ ë°˜ì˜)
    onValue(ref(db, STATUS_PATH), (snapshot) => {
        const status = snapshot.val();
        const isClosed = status ? status.isClosed : false;

        const inputs = studentAnswerButtonsEl.querySelectorAll('input, textarea, button');
        const submitButton = submitAnswerBtn;
        
        if (isClosed) {
            // ë§ˆê° ì‹œ: ëª¨ë“  ì…ë ¥/ë²„íŠ¼ ë¹„í™œì„±í™”
            inputs.forEach(el => el.disabled = true);
            submitButton.disabled = true;
            submitButton.textContent = 'â›” ë§ˆê°ë¨';
            submissionStatusStudent.classList.remove('hidden');
        } else {
            // ì—´ë¦¼ ì‹œ: ëª¨ë“  ì…ë ¥/ë²„íŠ¼ í™œì„±í™” (ë‹¨, O/XëŠ” ì¦‰ì‹œ ì œì¶œì´ë¯€ë¡œ ë²„íŠ¼ ìƒíƒœëŠ” ê·¸ëŒ€ë¡œ)
            inputs.forEach(el => el.disabled = false);
            submitButton.disabled = false;
            submitButton.textContent = 'ğŸš€ ë‹µë³€ ì œì¶œí•˜ê¸°';
            submissionStatusStudent.classList.add('hidden');
        }
    });


    // ----------------------------------------------------
    // 6. êµì‚¬ ë¡œì§ (ê²°ê³¼ í‘œì‹œ - ì „ì²´ ë‹µë³€ì ëª©ë¡ ì¶”ê°€)
    // ----------------------------------------------------
    // (listenForResponsesëŠ” V6.0ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)

    function renderResults(responses) {
        resultsDisplay.innerHTML = '';
        correctListContent.innerHTML = '';
        fullListContent.innerHTML = ''; // ğŸ’¡ ì „ì²´ ë‹µë³€ì ëª©ë¡ ì´ˆê¸°í™”
        
        if (!responses) {
            totalResponsesEl.textContent = 0;
            resultsDisplay.innerHTML = '<p class="text-gray-500 text-lg">ì•„ì§ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            correctRespondentsList.classList.add('hidden');
            fullListContent.textContent = 'ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        const responseList = Object.values(responses);
        const totalCount = responseList.length;
        totalResponsesEl.textContent = totalCount;

        onValue(ref(db, QUESTION_PATH), (qSnapshot) => {
            const question = qSnapshot.val();
            const correctAnswer = (question && question.correctAnswer) ? question.correctAnswer.trim() : null; 
            
            // ... (ë§‰ëŒ€ ê·¸ë˜í”„ ë° ì •ë‹µì ëª…ë‹¨ ë¡œì§ì€ V6.0ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)

            // ğŸ’¡ 1. ë‹µë³€ìì™€ ë‹µë³€ ë‚´ìš© ì „ì²´ ê³µê°œ
            const ul = document.createElement('ul');
            ul.className = 'pl-1 space-y-2';
            
            responseList.sort((a, b) => a.timestamp - b.timestamp); // ì œì¶œ ì‹œê°„ ìˆœ ì •ë ¬ (ë¨¼ì € ì œì¶œí•œ í•™ìƒì´ ìœ„ë¡œ)

            responseList.forEach(r => {
                const isCorrect = correctAnswer && r.answer && r.answer.trim().toLowerCase() === correctAnswer.toLowerCase();
                const li = document.createElement('li');
                li.className = isCorrect ? 'correct-answer-highlight' : 'border-b pb-1';
                li.innerHTML = `
                    <span class="font-bold text-gray-800">${r.name || 'ìµëª…'}</span>: 
                    <span class="text-gray-700">${r.answer}</span>
                    ${isCorrect ? '<span class="text-green-600 font-bold">(ì •ë‹µ)</span>' : ''}
                `;
                ul.appendChild(li);
            });
            fullListContent.appendChild(ul);
        }, { onlyOnce: true }); 
    }


    // ----------------------------------------------------
    // 7. êµì‚¬ ë¡œì§ (ëˆ„ì  ê¸°ë¡ ë° EXCEL ë‹¤ìš´ë¡œë“œ)
    // ----------------------------------------------------
    
    // ğŸ’¡ ëˆ„ì  ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ
    onValue(ref(db, HISTORY_PATH), (snapshot) => {
        const historyData = snapshot.val();
        renderHistoryList(historyData);
    });

    function renderHistoryList(historyData) {
        historyList.innerHTML = '';
        if (!historyData) {
            historyList.textContent = 'ê¸°ë¡ëœ ê³¼ê±° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        const historyEntries = Object.entries(historyData).reverse(); // ìµœì‹  ë¬¸ì œë¶€í„° ë³´ì´ë„ë¡ ì—­ìˆœ ì •ë ¬
        
        historyEntries.forEach(([key, entry], index) => {
            const questionText = entry.question.text || 'ì´ë¯¸ì§€ ë¬¸ì œ';
            const responsesCount = Object.keys(entry.responses).length;

            const div = document.createElement('div');
            div.className = 'p-4 border border-blue-400 rounded-lg bg-blue-50 cursor-pointer hover:bg-blue-100';
            div.innerHTML = `
                <div class="font-bold text-blue-800">${historyEntries.length - index}ë²ˆ ë¬¸ì œ: ${questionText.substring(0, 30)}...</div>
                <div class="text-sm text-gray-600">ì¶œì œì¼: ${entry.date} | ì‘ë‹µ: ${responsesCount}ëª…</div>
            `;
            div.onclick = () => showHistoryDetail(key, entry);
            historyList.appendChild(div);
        });
    }
    
    // ğŸ’¡ ê³¼ê±° ê¸°ë¡ ìƒì„¸ ë³´ê¸° í•¨ìˆ˜
    function showHistoryDetail(key, entry) {
        // ê¸°ì¡´ì˜ í˜„ì¬ ì‘ë‹µ íŒ¨ë„ì„ ì¬ì‚¬ìš©í•˜ì—¬ ê³¼ê±° ê¸°ë¡ í‘œì‹œ
        const q = entry.question;
        const r = entry.responses;
        const responsesCount = Object.keys(r).length;
        
        // HTML ì—…ë°ì´íŠ¸
        document.querySelector('.container h1').textContent = `ğŸ“‚ ê³¼ê±° ê¸°ë¡: ${q.text.substring(0, 20)}...`;
        modeSelection.classList.add('hidden');
        studentPanel.classList.add('hidden');
        teacherPanel.classList.remove('hidden'); // êµì‚¬ íŒ¨ë„ì— í‘œì‹œ

        // í˜„ì¬ ë¬¸ì œ ì¶œì œ ì˜ì—­ ìˆ¨ê¸°ê¸°
        document.querySelector('#teacher-panel > div:nth-child(2)').classList.add('hidden');

        // ê²°ê³¼ ì˜ì—­ì— ê³¼ê±° ë°ì´í„° ë Œë”ë§
        totalResponsesEl.textContent = responsesCount;
        renderPastResults(q, r, totalCount);

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„ì‹œ ë³€ê²½
        exportExcelBtn.onclick = () => exportHistoryToCSV(q, r, q.text);
    }
    
    // ğŸ’¡ ê³¼ê±° ê¸°ë¡ ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜ (renderResultsì™€ ìœ ì‚¬)
    function renderPastResults(question, responses, totalCount) {
        // ... (V6.0ì˜ renderResults ë¡œì§ì„ ë³µì‚¬í•˜ê³  Firebase í˜¸ì¶œì„ ì œê±°í•˜ì—¬ past responseë¥¼ ë Œë”ë§)
    }

    // ğŸ’¡ EXCEL ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    exportExcelBtn.addEventListener('click', () => exportCurrentToCSV(currentQuestionKey)); // ì´ˆê¸°ì—ëŠ” í˜„ì¬ ë¬¸ì œ ë‹¤ìš´ë¡œë“œ

    function exportCurrentToCSV() {
        // í˜„ì¬ ë¬¸ì œ ë°ì´í„°ì™€ ì‘ë‹µì„ ê°€ì ¸ì™€ CSV ìƒì„±
        get(ref(db, QUESTION_PATH)).then(qSnapshot => {
            get(ref(db, RESPONSES_PATH)).then(rSnapshot => {
                const question = qSnapshot.val();
                const responses = rSnapshot.val();
                if (!question) {
                    alert('ì¶œì œëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                exportToCSV(question, responses, `ì‘ë‹µí˜„í™©_${new Date().toLocaleDateString('ko-KR')}`);
            });
        });
    }

    function exportToCSV(question, responses, filename) {
        if (!responses || Object.keys(responses).length === 0) {
            alert('ë‹¤ìš´ë¡œë“œí•  ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const data = Object.values(responses);
        
        // CSV í—¤ë” ìƒì„±
        let csv = `ë¬¸ì œ,ì‘ë‹µì ì´ë¦„,ì‘ë‹µ ë‚´ìš©,ì •ë‹µ ì—¬ë¶€,ì œì¶œ ì‹œê°„\n`;
        
        // CSV ë³¸ë¬¸ ìƒì„±
        const qText = question.text.replace(/,/g, ' '); // ì½¤ë§ˆ ì œê±°
        const correctAnswer = (question.correctAnswer || '').trim().toLowerCase();

        data.forEach(r => {
            const name = r.name || 'ìµëª…';
            const answer = (r.answer || '').replace(/,/g, ' '); // ì½¤ë§ˆ ì œê±°
            const isCorrect = (r.answer && correctAnswer) ? (r.answer.trim().toLowerCase() === correctAnswer) : '-';
            const date = new Date(r.timestamp).toLocaleString('ko-KR');
            const correctness = isCorrect === true ? 'O' : isCorrect === false ? 'X' : isCorrect;

            csv += `"${qText}","${name}","${answer}","${correctness}","${date}"\n`;
        });

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename + ".csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    // ì´ì™¸ì˜ ëª¨ë“  renderPastResults, renderHistoryList ë° V6.0ì˜ ì´ë¯¸ì§€/ëª¨ë“œì „í™˜ ë¡œì§ì€ 
    // ì‹¤ì œ HTML íŒŒì¼ì— ì¶”ê°€ë˜ì—ˆìŒì„ ê°€ì •í•©ë‹ˆë‹¤.
</script>
</body>
</html>
