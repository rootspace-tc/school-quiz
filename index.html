<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 실시간 문제 관리형 퀴즈 플랫폼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Jua', sans-serif; background-color: #f7f3e9; font-size: 18px; }
        .container { max-width: 1100px; margin: 2rem auto; padding: 30px; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 2.5rem !important; } 
        h2 { font-size: 2rem !important; }
        .text-xl { font-size: 1.5rem !important; }
        .text-2xl { font-size: 1.875rem !important; }
        #student-question-text { font-size: 3rem !important; line-height: 1.4; } 
        .result-bar { height: 35px; margin-bottom: 8px; color: white; display: flex; align-items: center; padding: 0 10px; border-radius: 4px; transition: width 0.5s ease-out; }
        .correct-answer-highlight { background-color: #d1f7d1; font-weight: bold; border-left: 5px solid #4CAF50; padding: 5px; margin: 3px 0; border-radius: 4px; }
        #student-answer-buttons button { transition: all 0.2s; font-size: 1.3rem; }
        .text-lg { font-size: 1.125rem !important; }
        .text-base { font-size: 1rem !important; }
        .submission-closed { background-color: #fca5a5; color: #7f1d1d; font-weight: bold; }
        .question-item { cursor: pointer; border-left: 5px solid transparent; transition: all 0.2s; }
        .question-item:hover { background-color: #f3f4f6; border-left-color: #3b82f6; }
        .question-item.selected { background-color: #bfdbfe; border-left-color: #1d4ed8; font-weight: bold; }
        .kick-btn { background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; }
        .kick-btn:hover { background-color: #dc2626; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="font-bold text-center mb-10 text-indigo-700">🚀 실시간 문제 관리형 퀴즈 플랫폼 </h1>
    
    <div id="mode-selection" class="flex justify-center space-x-6 mb-8">
        <button id="teacher-mode-btn" class="mode-button bg-red-500 text-white p-4 rounded-lg shadow-md font-semibold text-xl">
            👩‍🏫 교사 모드 (비밀번호 필요)
        </button>
        <button id="student-mode-btn" class="mode-button bg-blue-500 text-white p-4 rounded-lg shadow-md font-semibold text-xl">
            🧑‍🎓 학생 모드
        </button>
    </div>

    <hr class="mb-8 border-gray-300">

    <div id="teacher-panel" class="hidden">
        <h2 class="font-bold mb-5 text-red-600">교사 제어판</h2>
        
        <div id="question-control-area" class="p-8 border border-red-300 rounded-lg bg-red-50 mb-8">
            <div class="p-4 border border-blue-300 rounded-lg bg-blue-50 mb-5">
                <label for="student-password-input" class="block font-semibold mb-3">🔒 학생 접속 비밀번호 설정 (미입력시 비활성화):</label>
                <input type="text" id="student-password-input" class="w-full border rounded p-3 text-lg" placeholder="예: 우리반화이팅">
            </div>

            <div id="question-management-area" class="border-b pb-4 mb-4">
                <h3 class="text-2xl font-bold mb-4">문제 생성 및 목록 관리</h3>
                
                <div id="question-creation-form" class="border-b pb-4 mb-4">
                    <label for="question-text" class="block font-semibold mb-3">📝 질문 내용:</label>
                    <textarea id="question-text" rows="2" class="w-full border rounded p-3 mb-3 text-lg"></textarea>
                    
                    <label class="block font-semibold mb-3">🖼️ 이미지 첨부:</label>
                    <div id="image-upload-area" class="border-2 border-dashed border-gray-400 p-3 mb-3 rounded-lg bg-white">
                        <input type="file" id="image-file-input" accept="image/*" class="mb-2 block w-full text-lg">
                        <p class="text-gray-600 text-base">또는, 이미지 파일을 **이 영역에 붙여넣기(Ctrl+V)** 하세요.</p>
                        <div id="image-preview" class="mt-2 text-center hidden">
                            <p class="mb-2">첨부된 이미지 미리보기:</p>
                            <img src="" id="current-image-preview" class="max-w-full h-auto mx-auto border border-gray-300 rounded max-h-48">
                            <button id="remove-image-btn" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white p-2 rounded text-base">
                                ❌ 이미지 제거
                            </button>
                        </div>
                    </div>

                    <label for="question-type" class="block font-semibold mb-3">❓ 질문 유형:</label>
                    <select id="question-type" class="w-full border rounded p-3 mb-3 bg-white text-lg">
                        <option value="MCQ">객관식 (다지선다)</option>
                        <option value="OX">OX 퀴즈</option>
                        <option value="ShortAnswer">주관식 (단답형)</option>
                    </select>
                    
                    <div id="mcq-options-container">
                        <label for="mcq-options" class="block font-semibold mb-3">🔢 객관식 보기 (콤마(,)로 구분):</label>
                        <input type="text" id="mcq-options" class="w-full border rounded p-3 text-lg" value="1. 네, 2. 아니오, 3. 아마도, 4. 글쎄요">
                    </div>

                    <label for="correct-answer-input" class="block font-semibold mb-3 mt-3">🔑 정답 입력 (선택 사항):</label>
                    <input type="text" id="correct-answer-input" class="w-full border rounded p-3 text-lg" placeholder="예: 3번 또는 정답 텍스트">

                    <button id="save-question-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg font-semibold w-full mt-4 text-xl">
                        📁 문제 목록에 저장
                    </button>
                </div>
                
                <h4 class="text-xl font-bold mb-3 mt-4">📋 관리 중인 문제 목록</h4>
                <div id="managed-question-list" class="space-y-2 border p-3 rounded bg-white max-h-60 overflow-y-auto">
                    <p class="text-gray-500">저장된 문제가 없습니다.</p>
                </div>
                
                <div class="flex space-x-3 mt-4">
                    <button id="load-question-btn" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl" disabled>
                        📢 선택한 문제 출제하기
                    </button>
                    <button id="delete-managed-btn" class="bg-gray-400 hover:bg-gray-500 text-white p-4 rounded-lg font-semibold w-1/4 text-xl" disabled>
                        🗑 삭제
                    </button>
                </div>
            </div>
        </div>
        
        <div class="p-8 border border-gray-300 rounded-lg">
            <h3 class="text-2xl font-bold mb-4">실시간 제어</h3>
            <div class="flex space-x-3 mt-3 mb-6">
                <button id="close-submission-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ⛔ 답변 마감
                </button>
                <button id="hide-question-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    🙈 문제 숨기기
                </button>
                <button id="clear-results-btn" class="bg-gray-400 hover:bg-gray-500 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    🗑 현재 응답 초기화
                </button>
            </div>


            <h3 class="text-xl font-bold mb-5 flex justify-between">
                <span>📊 실시간 응답 현황 (<span id="total-responses">0</span>명 참여)</span>
                <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-base">
                    ⬇️ 전체 기록 EXCEL 다운로드
                </button>
            </h3>
            
            <div id="submission-status-teacher" class="text-center p-3 rounded mb-4 text-xl submission-closed hidden">
                ⛔ 현재 답변 수정이 마감되었습니다.
            </div>

            <div id="results-display" class="space-y-4">
                <p class="text-gray-500 text-lg">문제가 출제되면 여기에 결과가 표시됩니다.</p>
            </div>
            
            <div id="correct-respondents-list" class="mt-8 border-t pt-5 hidden">
                 <h4 class="text-xl font-bold mb-4 text-green-600">✅ 정답자 명단</h4>
                 <div id="correct-list-content" class="text-lg">정답이 설정되지 않았거나, 정답자가 없습니다.</div>
            </div>

            <div id="respondents-full-list" class="mt-8 border-t pt-5">
                 <h4 class="text-xl font-bold mb-4 text-gray-700">🧑‍🎓 전체 답변자 목록 (답변 포함)</h4>
                 <div id="full-list-content" class="text-lg space-y-2">답변이 없습니다.</div>
            </div>
             
            <div id="active-users-list" class="mt-8 border-t pt-5">
                <h4 class="text-xl font-bold mb-4 text-gray-700">🟢 현재 접속 및 답변자 목록 (<span id="active-count">0</span>명)</h4>
                <div id="active-users-content" class="text-lg space-y-2 flex flex-wrap gap-2">
                    <p class="text-gray-500">학생들의 접속 및 응답을 기다리고 있습니다.</p>
                </div>
            </div>
        </div>
        
        <div class="p-8 border border-blue-300 rounded-lg bg-blue-50 mt-8">
            <h3 class="text-2xl font-bold mb-4 text-blue-700">📂 누적된 과거 퀴즈 기록 보기</h3>
            <div id="history-list" class="text-lg space-y-4">기록된 문제가 없습니다.</div>
            <button id="clear-history-btn" class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-semibold w-full mt-4 text-xl">
                💣 전체 기록 초기화
            </button>
        </div>
        
        <div id="history-detail-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <h3 id="modal-question-title" class="text-2xl font-bold mb-4"></h3>
                <div id="modal-results-display" class="space-y-4 border p-4 rounded mb-4"></div>
                <button id="modal-close-btn" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded w-full">닫기</button>
            </div>
        </div>
    </div>

    <div id="student-panel" class="hidden">
        <h2 class="font-bold mb-5 text-blue-600">학생 응답창</h2>
        
        <div id="student-login-area" class="p-8 border border-blue-300 rounded-lg bg-blue-50 mb-8">
            <label for="student-name" class="block font-semibold mb-3 text-lg">이름 또는 번호 입력:</label>
            <input type="text" id="student-name" class="w-full border rounded p-3 mb-5 text-xl" placeholder="예: 1번 김철수">
            <label for="student-access-password" class="block font-semibold mb-3 text-lg">🔒 접속 비밀번호 (교사 설정):</label>
            <input type="text" id="student-access-password" class="w-full border rounded p-3 mb-5 text-xl" placeholder="비밀번호를 입력하세요">

            <button id="student-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-semibold w-full text-xl">
                ✅ 참여 시작
            </button>
        </div>

        <div id="student-quiz-area" class="hidden">
            <div class="p-8 border border-gray-300 rounded-lg bg-white mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">현재 질문:</h3>
                <div id="student-question-image-container" class="mb-6 hidden">
                    <img src="" id="student-question-image" class="max-w-full h-auto mx-auto border border-gray-200 rounded max-h-80">
                </div>
                <p id="student-question-text" class="font-extrabold text-gray-800 mb-6 text-center">
                    [선생님이 문제를 출제할 때까지 기다려주세요.]
                </p>
                
                <div id="submission-status-student" class="text-center p-3 rounded mb-4 text-xl submission-closed hidden">
                    ⛔ 답변 수정이 마감되어 제출/수정이 불가능합니다.
                </div>

                <div id="student-answer-buttons" class="grid grid-cols-2 gap-4 mb-4">
                </div>
                
                <button id="submit-answer-btn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-semibold w-full text-xl hidden">
                    🚀 답변 제출하기
                </button>
                <p id="submission-status-msg" class="text-center mt-3 text-green-700 font-semibold text-2xl hidden">
                    ✅ 답변 제출을 완료했습니다! (수정 가능)
                </p>
            </div>
        </div>
        
        <div id="student-submitted-area" class="hidden text-center p-12 border border-green-300 rounded-lg bg-green-50">
            <h3 class="text-3xl font-bold mb-4 text-green-700">✅ 답변 제출이 완료되었습니다!</h3>
            <p class="text-xl text-gray-700 mb-6">
                선생님의 다음 문제 출제를 기다려주세요.<br>
                (화면을 닫거나 새로고침해도 다음 문제가 보입니다.)
            </p>
            <button id="modify-answer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-lg font-semibold text-xl">
                ✏️ 답변 수정하기
            </button>
            <p class="text-sm mt-4 text-gray-500">
                **[설명]** 답변 수정하기 버튼을 누르면 잠시 응답 화면으로 돌아가서<br>
                답을 수정할 수 있습니다. (단, 선생님이 마감하기 전까지만 가능)
            </p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"; 
    import { getDatabase, ref, set, onValue, remove, push, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ----------------------------------------------------
    // 1. Firebase 설정
    // ----------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAN1iAC82xKL_haJUs9291YBKNv7g7WSvU",
        authDomain: "foranswering-afec8.firebaseapp.com",
        databaseURL: "https://foranswering-afec8-default-rtdb.firebaseio.com",
        projectId: "foranswering-afec8",
        storageBucket: "foranswering-afec8.firebasestorage.app",
        messagingSenderId: "291098085525",
        appId: "1:291098085525:web:883a852c6320859294339c",
        measurementId: "G-5LP4KEWLXR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); 

    // 데이터베이스 경로 정의
    const STATUS_PATH = 'quiz/status'; 
    const QUESTION_PATH = 'quiz/currentQuestion';
    const RESPONSES_PATH = 'quiz/responses';
    const HISTORY_PATH = 'quiz/history'; 
    const PRESENCE_PATH = 'quiz/presence'; 
    const CONFIG_PATH = 'quiz/config'; 
    const MANAGED_QUESTIONS_PATH = 'quiz/managedQuestions'; 

    // ----------------------------------------------------
    // 2. 변수 및 UI 요소 정의
    // ----------------------------------------------------
    const TEACHER_PASSWORD = "2948"; 
    let currentStudentId = null; 
    let currentQuestionType = 'MCQ';
    let currentImageBase64 = null; 
    let selectedManagedQuestionKey = null; 

    // UI 요소
    const teacherPanel = document.getElementById('teacher-panel');
    const studentPanel = document.getElementById('student-panel');
    const modeSelection = document.getElementById('mode-selection');
    const questionTextarea = document.getElementById('question-text');
    const questionTypeSelect = document.getElementById('question-type');
    const mcqOptionsInput = document.getElementById('mcq-options');
    const correctAnswerInput = document.getElementById('correct-answer-input'); 
    const totalResponsesEl = document.getElementById('total-responses');
    const resultsDisplay = document.getElementById('results-display');
    const correctRespondentsList = document.getElementById('correct-respondents-list'); 
    const correctListContent = document.getElementById('correct-list-content');
    const fullListContent = document.getElementById('full-list-content'); 
    const historyList = document.getElementById('history-list'); 
    const activeUsersContent = document.getElementById('active-users-content'); 
    const activeCount = document.getElementById('active-count'); 
    const studentNameInput = document.getElementById('student-name');
    const studentAccessPassword = document.getElementById('student-access-password');
    const studentPasswordInput = document.getElementById('student-password-input');
    const studentQuizArea = document.getElementById('student-quiz-area');
    const studentSubmittedArea = document.getElementById('student-submitted-area');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');

    const saveQuestionBtn = document.getElementById('save-question-btn'); 
    const managedQuestionList = document.getElementById('managed-question-list'); 
    const loadQuestionBtn = document.getElementById('load-question-btn'); 
    const deleteManagedBtn = document.getElementById('delete-managed-btn'); 
    const removeImageBtn = document.getElementById('remove-image-btn');
    const hideQuestionBtn = document.getElementById('hide-question-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');


    // ----------------------------------------------------
    // 3. 이미지 업로드 및 붙여넣기 로직
    // ----------------------------------------------------
    function setImage(base64Data) {
        document.getElementById('current-image-preview').src = base64Data;
        document.getElementById('image-preview').classList.remove('hidden');
        currentImageBase64 = base64Data;
    }
    document.getElementById('image-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => setImage(event.target.result);
            reader.readAsDataURL(file);
        }
    });
    document.getElementById('image-upload-area').addEventListener('paste', (e) => {
        e.preventDefault();
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => setImage(event.target.result);
                reader.readAsDataURL(blob);
                break;
            }
        }
    });
    removeImageBtn.addEventListener('click', () => {
        currentImageBase64 = null;
        document.getElementById('image-file-input').value = '';
        document.getElementById('image-preview').classList.add('hidden');
    });


    // ----------------------------------------------------
    // 4. 모드 전환 및 초기화 로직
    // ----------------------------------------------------
    
    document.getElementById('teacher-mode-btn').addEventListener('click', async () => {
        const password = prompt("교사 모드에 접속하시려면 비밀번호를 입력해주세요.");
        
        if (password === TEACHER_PASSWORD) {
            // 💡 [안정화] 설정 로드
            const configSnapshot = await get(ref(db, CONFIG_PATH));
            const config = configSnapshot.val();
            if (config && config.studentPassword) {
                studentPasswordInput.value = config.studentPassword;
            } else {
                studentPasswordInput.value = '';
            }

            teacherPanel.classList.remove('hidden');
            studentPanel.classList.add('hidden');
            modeSelection.classList.add('hidden');
            onValue(ref(db, HISTORY_PATH), (snapshot) => renderHistoryList(snapshot.val()));
            listenForResponses();
            listenForActiveUsers();
            onValue(ref(db, MANAGED_QUESTIONS_PATH), (snapshot) => renderManagedQuestions(snapshot.val())); 
            document.getElementById('question-control-area').classList.remove('hidden');
        } else {
            alert("비밀번호가 틀렸습니다.");
        }
    });

    document.getElementById('student-mode-btn').addEventListener('click', () => {
        teacherPanel.classList.add('hidden');
        studentPanel.classList.remove('hidden');
        modeSelection.classList.add('hidden');
    });

    // 💡 [수정] 학생 로그인 로직 (보안 및 Presence 기록)
    document.getElementById('student-login-btn').addEventListener('click', async () => {
        const name = studentNameInput.value.trim();
        const accessPassword = studentAccessPassword.value.trim();
        
        if (!name) {
            alert('이름 또는 번호를 입력해주세요.');
            return;
        }

        const configSnapshot = await get(ref(db, CONFIG_PATH));
        const requiredPassword = (configSnapshot.val() && configSnapshot.val().studentPassword) ? configSnapshot.val().studentPassword.trim() : '';

        if (requiredPassword && requiredPassword !== accessPassword) {
            alert('🔒 접속 비밀번호가 틀렸습니다. 다시 확인해주세요.');
            return;
        }
        
        currentStudentId = name.replace(/[.#$/[\]]/g, "_"); 
        document.getElementById('student-login-area').classList.add('hidden');
        studentQuizArea.classList.add('hidden');
        studentSubmittedArea.classList.remove('hidden'); 
        listenForQuestion();
        localStorage.setItem('quiz_student_name', name); 
        
        // Presence 등록: 접속한 학생 이름과 시간을 기록 (접속자 목록에 사용)
        set(ref(db, `${PRESENCE_PATH}/${currentStudentId}`), { 
            name: name,
            lastSeen: Date.now()
        });
    });

    document.getElementById('modify-answer-btn').addEventListener('click', () => {
        studentQuizArea.classList.remove('hidden');
        studentSubmittedArea.classList.add('hidden');
    });

    // 💡 [추가] 교사 모드에서 학생 접속 비밀번호 변경 시 저장
    studentPasswordInput.addEventListener('change', () => {
        const password = studentPasswordInput.value.trim();
        set(ref(db, CONFIG_PATH), { studentPassword: password });
    });


    // ----------------------------------------------------
    // 5. 교사 로직 (문제 관리 및 출제)
    // ----------------------------------------------------

    // 💡 [추가] 문제 목록에 저장 버튼 로직
    saveQuestionBtn.addEventListener('click', () => {
        const text = questionTextarea.value.trim();
        if (!text) {
            alert('질문 내용을 입력해주세요.');
            return;
        }
        
        const type = questionTypeSelect.value;
        const options = type === 'MCQ' ? mcqOptionsInput.value.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];
        const correctAnswer = correctAnswerInput.value.trim();
        
        const newManagedQuestion = {
            text: text,
            type: type,
            options: options,
            image: currentImageBase64,
            correctAnswer: correctAnswer || null,
            timestamp: Date.now()
        };

        push(ref(db, MANAGED_QUESTIONS_PATH), newManagedQuestion)
        .then(() => {
            alert('문제 목록에 저장되었습니다.');
            questionTextarea.value = '';
            mcqOptionsInput.value = '1. 네, 2. 아니오, 3. 아마도, 4. 글쎄요';
            correctAnswerInput.value = '';
            removeImageBtn.click();
        })
        .catch(error => {
            console.error('문제 목록 저장 실패:', error);
            alert('문제 목록 저장 실패.');
        });
    });

    // 💡 [추가] 관리 문제 목록 렌더링
    function renderManagedQuestions(managedQuestionsData) {
        managedQuestionList.innerHTML = '';
        if (!managedQuestionsData) {
            managedQuestionList.innerHTML = '<p class="text-gray-500">저장된 문제가 없습니다.</p>';
            loadQuestionBtn.disabled = true;
            deleteManagedBtn.disabled = true;
            return;
        }

        const questionsArray = Object.entries(managedQuestionsData);
        
        questionsArray.forEach(([key, question], index) => {
            const div = document.createElement('div');
            div.className = 'question-item p-2 border-b';
            div.textContent = `${index + 1}번. ${question.text.substring(0, 40)}${question.text.length > 40 ? '...' : ''}`;
            
            if (question.image) {
                div.textContent += ' 🖼️';
            }
            if (question.correctAnswer) {
                div.textContent += ` (정답: ${question.correctAnswer})`;
            }

            div.onclick = () => {
                document.querySelectorAll('.question-item').forEach(item => item.classList.remove('selected'));
                div.classList.add('selected');
                selectedManagedQuestionKey = key;
                loadQuestionBtn.disabled = false;
                deleteManagedBtn.disabled = false;
            };

            managedQuestionList.appendChild(div);
        });
    }

    // 💡 [수정] 관리 문제 출제 로직
    loadQuestionBtn.addEventListener('click', async () => {
        if (!selectedManagedQuestionKey) {
            alert('출제할 문제를 목록에서 선택해주세요.');
            return;
        }

        const snapshot = await get(ref(db, `${MANAGED_QUESTIONS_PATH}/${selectedManagedQuestionKey}`));
        const questionData = snapshot.val();
        
        if (!questionData) {
             alert('선택된 문제가 Firebase에 없습니다. 목록을 새로고침해주세요.');
             return;
        }

        // 기존의 postQuestion 로직을 재사용하여 출제
        questionData.isClosed = false;
        questionData.isSavedToHistory = false;
        questionData.timestamp = Date.now();

        await saveCurrentQuestionToHistory(); // 이전 문제 기록 저장

        set(ref(db, QUESTION_PATH), questionData)
        .then(() => {
            alert('선택된 문제가 출제되었습니다! 답변이 시작됩니다.');
            remove(ref(db, RESPONSES_PATH)); 
            update(ref(db, STATUS_PATH), { isClosed: false });
            document.getElementById('submission-status-teacher').classList.add('hidden');
        })
        .catch(error => {
            console.error('문제 출제 실패:', error);
            alert('문제 출제 실패.');
        });
    });

    // 💡 [추가] 관리 문제 삭제 로직
    deleteManagedBtn.addEventListener('click', () => {
         if (!selectedManagedQuestionKey) {
            alert('삭제할 문제를 목록에서 선택해주세요.');
            return;
        }
        if (!confirm('정말로 이 문제를 관리 목록에서 삭제하시겠습니까?')) return;
        
        remove(ref(db, `${MANAGED_QUESTIONS_PATH}/${selectedManagedQuestionKey}`))
        .then(() => {
            alert('문제가 목록에서 삭제되었습니다.');
            selectedManagedQuestionKey = null;
            loadQuestionBtn.disabled = true;
            deleteManagedBtn.disabled = true;
        });
    });


    // ----------------------------------------------------
    // 6. 문제 제어 및 데이터 로직 (V16.0 안정화 로직 유지)
    // ----------------------------------------------------

    // 💡 [핵심 수정] 기록 저장 함수 (문제당 1회 저장 보장)
    async function saveCurrentQuestionToHistory() {
        const questionSnapshot = await get(ref(db, QUESTION_PATH));
        const responsesSnapshot = await get(ref(db, RESPONSES_PATH));
        
        const questionData = questionSnapshot.val();
        const responsesData = responsesSnapshot.val();
        
        if (questionData && (questionData.text || questionData.image)) {
            
            if (!questionData.isSavedToHistory) {
                 const historyEntry = {
                    question: questionData,
                    responses: responsesData || {},
                    date: new Date().toLocaleString('ko-KR')
                };
                push(ref(db, HISTORY_PATH), historyEntry);
                
                update(ref(db, QUESTION_PATH), { isSavedToHistory: true });

                return true; 
            }
        }
        return false; 
    }
    
    // ⛔ 답변 마감 버튼: 기록 저장 후 상태 변경
    document.getElementById('close-submission-btn').addEventListener('click', async () => {
        if (!confirm("현재 문제에 대한 학생들의 답변 수정 및 제출을 마감하고 기록에 저장하시겠습니까?")) return;
        
        await saveCurrentQuestionToHistory(); 
        
        update(ref(db, STATUS_PATH), { isClosed: true })
        .then(() => {
            alert('답변 마감이 완료되고 기록에 저장되었습니다.');
            document.getElementById('submission-status-teacher').classList.remove('hidden');
        });
    });

    // 문제 숨기기 기능
    document.getElementById('hide-question-btn').addEventListener('click', async () => {
        if (!confirm("현재 출제된 문제를 학생 화면에서 숨기고 기록에 저장하시겠습니까?")) return;
        
        await saveCurrentQuestionToHistory();
        
        set(ref(db, QUESTION_PATH), null)
        .then(() => {
            alert('문제가 학생 화면에서 숨겨졌습니다. 기록에 저장되었습니다.');
            remove(ref(db, RESPONSES_PATH)); 
            update(ref(db, STATUS_PATH), { isClosed: true });
        });
    });

    // 현재 응답 초기화
    document.getElementById('clear-results-btn').addEventListener('click', () => {
        if (!confirm("모든 응답 결과를 초기화하시겠습니까?")) return;
        remove(ref(db, RESPONSES_PATH))
        .then(() => {
            alert('응답 결과가 초기화되었습니다.');
        });
    });

    // 💣 전체 기록 초기화 버튼 로직
    clearHistoryBtn.addEventListener('click', () => {
        if (!confirm("경고: 누적된 모든 과거 퀴즈 기록을 영구히 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) return;
        
        remove(ref(db, HISTORY_PATH))
        .then(() => {
            remove(ref(db, QUESTION_PATH));
            remove(ref(db, RESPONSES_PATH));
            remove(ref(db, PRESENCE_PATH));
            remove(ref(db, MANAGED_QUESTIONS_PATH)); // 💡 [추가] 관리 문제 목록도 삭제
            
            alert('모든 과거 기록이 삭제되었습니다. 다음 출제 문제는 1번부터 시작됩니다.');
            renderHistoryList(null); 
            renderManagedQuestions(null);
        });
    });


    // ----------------------------------------------------
    // 8. 학생 로직 (V16.0 유지)
    // ----------------------------------------------------
    
    document.getElementById('submit-answer-btn').addEventListener('click', () => {
        let answer = null;
        
        if (currentQuestionType === 'ShortAnswer') {
            const input = document.getElementById('short-answer-input');
            answer = input ? input.value.trim() : null;
        } 
        else {
            const selected = document.querySelector('input[name="student-answer"]:checked');
            answer = selected ? selected.value : null;
        }

        if (answer) {
            submitAnswer(answer);
        } else {
            alert('답변을 선택하거나 입력해주세요.');
        }
    });
    
    function submitAnswer(answer) {
        if (!currentStudentId) {
            alert('먼저 이름을 입력하고 참여를 시작해주세요.');
            return;
        }
        
        get(ref(db, STATUS_PATH)).then(snapshot => {
            const status = snapshot.val();
            if (status && status.isClosed) {
                alert('⛔ 답변 수정이 마감되어 제출할 수 없습니다.');
                document.getElementById('student-quiz-area').classList.add('hidden');
                document.getElementById('student-submitted-area').classList.remove('hidden');
                return;
            }
            
            set(ref(db, `${RESPONSES_PATH}/${currentStudentId}`), {
                name: studentNameInput.value.trim(),
                answer: answer,
                timestamp: Date.now()
            })
            .then(() => {
                document.getElementById('student-quiz-area').classList.add('hidden');
                document.getElementById('student-submitted-area').classList.remove('hidden'); 
            });
        });
    }

    // 💡 답변 마감 상태 동기화 및 버튼 활성화/비활성화
    onValue(ref(db, STATUS_PATH), (snapshot) => {
        const status = snapshot.val();
        const isClosed = status ? status.isClosed : false;

        const inputs = document.querySelectorAll('#student-answer-buttons input, #student-answer-buttons textarea, #student-answer-buttons button');
        const submitButton = document.getElementById('submit-answer-btn');
        const modifyAnswerBtn = document.getElementById('modify-answer-btn');
        
        if (isClosed) {
            inputs.forEach(el => el.disabled = true);
            submitButton.disabled = true;
            submitButton.textContent = '⛔ 마감됨';
            document.getElementById('submission-status-student').classList.remove('hidden');
            modifyAnswerBtn.disabled = true; 
        } else {
            inputs.forEach(el => el.disabled = false);
            submitButton.disabled = false;
            submitButton.textContent = '🚀 답변 제출하기';
            document.getElementById('submission-status-student').classList.add('hidden');
            modifyAnswerBtn.disabled = false; 
        }
    });

    // 💡 문제 출제 시 자동 전환 로직 (핵심)
    function listenForQuestion() {
        onValue(ref(db, QUESTION_PATH), (snapshot) => {
            const questionData = snapshot.val();
            
            if (questionData && (questionData.text || questionData.image)) {
                document.getElementById('student-question-text').textContent = questionData.text || '';
                document.getElementById('currentQuestionType') = questionData.type;
                
                document.getElementById('student-submitted-area').classList.add('hidden'); 
                document.getElementById('student-quiz-area').classList.remove('hidden'); 

                renderStudentInputs(questionData);

                if (questionData.image) {
                    document.getElementById('student-question-image').src = questionData.image;
                    document.getElementById('student-question-image-container').classList.remove('hidden');
                } else {
                    document.getElementById('student-question-image-container').classList.add('hidden');
                }
            } else {
                document.getElementById('student-question-text').textContent = '[선생님이 문제를 출제할 때까지 기다려주세요.]';
                document.getElementById('student-answer-buttons').innerHTML = '';
                document.getElementById('submit-answer-btn').classList.add('hidden');
                document.getElementById('student-question-image-container').classList.add('hidden');
            }
        });
    }
    
    function renderStudentInputs(question) {
        document.getElementById('student-answer-buttons').innerHTML = ''; 
        document.getElementById('submit-answer-btn').classList.remove('hidden');
        
        if (question.type === 'OX') {
            const options = ['O', 'X'];
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = `p-5 text-2xl font-bold rounded-lg ${option === 'O' ? 'bg-green-100 hover:bg-green-200 text-green-700' : 'bg-red-100 hover:bg-red-200 text-red-700'}`;
                btn.textContent = option;
                btn.setAttribute('onclick', `(function(){ submitAnswer('${option}'); })();`); 
                document.getElementById('student-answer-buttons').appendChild(btn);
            });
            document.getElementById('submit-answer-btn').classList.add('hidden'); 
            
        } else if (question.type === 'MCQ' && question.options && question.options.length > 0) {
            question.options.forEach((option, index) => {
                const radioId = `mcq-option-${index}`;
                const div = document.createElement('div');
                div.className = 'flex items-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 cursor-pointer';

                const input = document.createElement('input');
                input.type = 'radio';
                input.id = radioId;
                input.name = 'student-answer';
                input.value = option;
                input.className = 'w-6 h-6 text-yellow-600 focus:ring-yellow-500 mr-4';
                
                const label = document.createElement('label');
                label.htmlFor = radioId;
                label.textContent = option;
                label.className = 'text-xl font-medium text-gray-700 flex-1';

                div.appendChild(input);
                div.appendChild(label);
                document.getElementById('student-answer-buttons').appendChild(div);
            });
            document.getElementById('submit-answer-btn').classList.remove('hidden'); 

        } else if (question.type === 'ShortAnswer') {
            const input = document.createElement('textarea');
            input.id = 'short-answer-input';
            input.rows = 4;
            input.className = 'w-full border rounded p-4 text-xl';
            input.placeholder = '답변을 여기에 입력하세요.';
            document.getElementById('student-answer-buttons').appendChild(input);
            document.getElementById('submit-answer-btn').classList.remove('hidden');
        } else {
             document.getElementById('student-question-text').textContent = '[선생님이 문제 유형 또는 보기를 확인해야 합니다.]';
             document.getElementById('submit-answer-btn').classList.add('hidden');
        }
    }


    // ----------------------------------------------------
    // 9. 최종 결과 표시 및 엑셀 로직 (V16.0 유지)
    // ----------------------------------------------------
    
    // ... (renderResults, renderPastResults, renderHistoryList, exportAllHistoryToCSV, exportToCSV 등 V16.0 로직 유지)
    function listenForResponses() {
        onValue(ref(db, RESPONSES_PATH), (snapshot) => {
            renderResults(snapshot.val());
        });
    }

    // 💡 [수정] 강제 퇴장(Kick) 함수
    window.kickUser = function(studentName, studentId) {
        if (!confirm(`${studentName} 학생을 퇴장시키고 아이디를 초기화하시겠습니까?`)) return;

        remove(ref(db, `${PRESENCE_PATH}/${studentId}`)); // 접속 상태 제거

        alert(`${studentName} 학생의 접속이 초기화되었습니다. 해당 학생에게 이름/번호를 재입력하도록 안내해주세요.`);
    }

    function renderResults(responses) {
        document.getElementById('results-display').innerHTML = '';
        document.getElementById('correct-list-content').innerHTML = '';
        document.getElementById('full-list-content').innerHTML = '';
        
        const filteredResponses = {};
        for (const key in responses) {
            if (!key.startsWith('Q0_')) {
                filteredResponses[key] = responses[key];
            }
        }
        
        if (Object.keys(filteredResponses).length === 0) {
            document.getElementById('total-responses').textContent = 0;
            document.getElementById('results-display').innerHTML = '<p class="text-gray-500 text-lg">아직 응답이 없습니다.</p>';
            document.getElementById('correct-respondents-list').classList.add('hidden');
            document.getElementById('full-list-content').textContent = '답변이 없습니다.';
            return;
        }

        const responseList = Object.values(filteredResponses);
        const totalCount = responseList.length;
        document.getElementById('total-responses').textContent = totalCount;

        get(ref(db, QUESTION_PATH)).then((qSnapshot) => {
            const question = qSnapshot.val();
            if (!question) {
                renderPastResults({text: '문제 없음'}, filteredResponses, totalCount, document.getElementById('results-display'));
                return;
            }
            renderPastResults(question, filteredResponses, totalCount, document.getElementById('results-display'));
        });
    }
    
    function renderPastResults(question, responses, totalCount, displayElement) {
        displayElement.innerHTML = ''; 
        const responseList = Object.values(responses);
        const correctAnswer = (question.correctAnswer || '').trim().toLowerCase(); 
        const correctNames = []; 

        if (question.type === 'MCQ' || question.type === 'OX') {
            const results = {};
            responseList.forEach(r => {
                const answer = r.answer || '미응답';
                results[answer] = (results[answer] || 0) + 1;
                if (correctAnswer && r.answer && r.answer.trim().toLowerCase() === correctAnswer) {
                    correctNames.push(r.name || '익명');
                }
            });
            
            const options = question.type === 'OX' ? ['O', 'X'] : question.options;
            const sortedResults = options.map(option => ({ answer: option, count: results[option] || 0 }));
            
            let graphHTML = '';
            sortedResults.forEach((item, index) => {
                const percentage = totalCount > 0 ? (item.count / totalCount) * 100 : 0;
                const color = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500'][index % 4];
                const isCorrect = correctAnswer && item.answer.trim().toLowerCase() === correctAnswer;
                const barClass = isCorrect ? 'bg-green-700' : color;
                
                graphHTML += `
                    <div class="mb-5">
                        <div class="flex justify-between mb-1 font-medium text-lg">
                            <span>${item.answer} ${isCorrect ? ' (🔑 정답)' : ''}</span>
                            <span>${item.count}명 (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full">
                            <div class="result-bar ${barClass}" style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            });
            if (displayElement === document.getElementById('results-display')) document.getElementById('results-display').innerHTML = graphHTML;
        } 
        
        const ul = document.createElement('ul');
        ul.className = 'pl-1 space-y-2';
        responseList.sort((a, b) => a.timestamp - b.timestamp); 
        
        responseList.forEach(r => {
            const isCorrect = correctAnswer && r.answer && r.answer.trim().toLowerCase() === correctAnswer;
            const li = document.createElement('li');
            li.className = isCorrect ? 'correct-answer-highlight' : 'border-b pb-1';
            li.innerHTML = `
                <span class="font-bold text-gray-800">${r.name || '익명'}</span>: 
                <span class="text-gray-700">${r.answer}</span>
                ${isCorrect ? '<span class="text-green-600 font-bold">(정답)</span>' : ''}
            `;
            ul.appendChild(li);
            if (isCorrect && displayElement !== document.getElementById('results-display')) correctNames.push(r.name || '익명');
        });

        if (displayElement === document.getElementById('results-display')) {
            document.getElementById('full-list-content').innerHTML = '';
            document.getElementById('full-list-content').appendChild(ul);
        } else {
            displayElement.appendChild(document.createElement('h4')).textContent = '답변 목록:';
            displayElement.appendChild(ul);
        }

        if (displayElement === document.getElementById('results-display')) {
            if (correctAnswer) {
                document.getElementById('correct-respondents-list').classList.remove('hidden');
                if (correctNames.length > 0) {
                    document.getElementById('correct-list-content').innerHTML = correctNames.map(name => `<span class="inline-block bg-green-200 text-green-800 px-3 py-1 rounded-full m-1">${name}</span>`).join('');
                } else {
                    document.getElementById('correct-list-content').textContent = '아직 정답자가 없습니다. (정답: ' + correctAnswer + ')';
                }
            } else {
                document.getElementById('correct-respondents-list').classList.add('hidden');
            }
        }
    }
    
    function renderHistoryList(historyData) {
        document.getElementById('history-list').innerHTML = '';
        
        if (!historyData) {
            document.getElementById('history-list').textContent = '기록된 과거 문제가 없습니다.';
            return;
        }

        const historyEntries = Object.entries(historyData).reverse(); 
        const historyArray = Object.values(historyData); 
        
        historyEntries.forEach(([key, entry], index) => {
            const questionText = entry.question.text || '이미지 문제';
            const responsesCount = Object.keys(entry.responses).length;
            
            const entryNumber = historyArray.length - index;

            const div = document.createElement('div');
            div.className = 'p-4 border border-blue-400 rounded-lg bg-blue-50 cursor-pointer hover:bg-blue-100';
            div.innerHTML = `
                <div class="font-bold text-blue-800">${entryNumber}번 문제: ${questionText.substring(0, 30)}...</div>
                <div class="text-sm text-gray-600">출제일: ${entry.date} | 응답: ${responsesCount}명</div>
            `;
            div.onclick = () => showHistoryDetail(entryNumber, entry); 
            document.getElementById('history-list').appendChild(div);
        });
    }

    function showHistoryDetail(number, entry) {
        document.getElementById('question-control-area').classList.add('hidden');
        document.querySelector('.container h1').textContent = `📂 과거 기록: ${number}번 문제 상세`;
        document.getElementById('history-detail-modal').classList.remove('hidden');
        
        const q = entry.question;
        const r = entry.responses;
        const totalCount = Object.keys(r).length;

        document.getElementById('modal-question-title').textContent = q.text || '이미지 문제';
        document.getElementById('modal-results-display').innerHTML = ''; // 초기화

        renderPastResults(q, r, totalCount, document.getElementById('modal-results-display'));

        document.getElementById('export-excel-btn').onclick = () => exportToCSV(q, r, `${number}번_문제_기록`);
    }

    function renderActiveUsers(presenceData) {
        document.getElementById('active-users-content').innerHTML = '';
        let userCount = 0;
        
        if (presenceData) {
            const sortedUsers = Object.values(presenceData).filter(user => user && user.lastSeen).sort((a, b) => b.lastSeen - a.lastSeen); 
            
            sortedUsers.forEach(user => {
                const name = user.name || '익명';
                const userId = name.replace(/[.#$/[\]]/g, "_");
                
                const span = document.createElement('span');
                span.className = 'inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full m-1 flex items-center';
                span.innerHTML = `
                    ${name} 
                    <button class="kick-btn" onclick="kickUser('${name}', '${userId}')">X</button>
                `;
                document.getElementById('active-users-content').appendChild(span);
                userCount++;
            });
        }
        
        if (userCount === 0) {
            document.getElementById('active-users-content').innerHTML = '<p class="text-gray-500">학생들의 접속 및 응답을 기다리고 있습니다.</p>';
        }
        document.getElementById('active-count').textContent = userCount;
    }


    // ----------------------------------------------------
    // 10. 엑셀 다운로드 (CSV) - 전체 기록 안정화
    // ----------------------------------------------------

    document.getElementById('export-excel-btn').addEventListener('click', exportAllHistoryToCSV); 

    async function exportAllHistoryToCSV() {
        if (!confirm("누적된 모든 퀴즈의 전체 응답 기록을 다운로드하시겠습니까? (학생별, 문제별 정답 여부 포함)")) return;

        const snapshot = await get(ref(db, HISTORY_PATH));
        const historyData = snapshot.val();

        if (!historyData) {
            alert('다운로드할 기록된 문제가 없습니다.');
            return;
        }

        const allStudents = new Set();
        const processedHistory = [];
        
        const historyEntries = Object.values(historyData);
        
        historyEntries.forEach((entry, index) => {
            const questionText = (entry.question.text || '이미지 문제').substring(0, 30);
            
            const correctAnswer = (entry.question.correctAnswer || '').trim().toLowerCase();
            
            Object.values(entry.responses).forEach(r => allStudents.add(r.name));

            processedHistory.push({
                number: index + 1, // 1번부터 순서대로 번호 부여
                text: questionText,
                correctAnswer: correctAnswer,
                responses: entry.responses
            });
        });

        const sortedStudents = Array.from(allStudents).sort();
        
        let csvHeader = "참여자 이름";
        processedHistory.forEach(q => {
            csvHeader += `,"${q.number}번 문제 답변: ${q.text}..."`;
            csvHeader += `,"${q.number}번 정답 여부"`;
        });
        let csv = csvHeader + "\n";

        sortedStudents.forEach(studentName => {
            let studentRow = `"${studentName}"`;
            
            processedHistory.forEach(q => {
                const response = Object.values(q.responses).find(r => (r.name || '익명') === studentName);
                
                if (response) {
                    const answer = (response.answer || '').replace(/"/g, '""'); 
                    const isCorrect = (response.answer && q.correctAnswer) ? (response.answer.trim().toLowerCase() === q.correctAnswer) : false;
                    const correctness = isCorrect ? 'O' : 'X';
                    
                    studentRow += `,"${answer}"`; 
                    studentRow += `,"${correctness}"`; 

                } else {
                    studentRow += `,"-"`; 
                    studentRow += `,"-"`; 
                }
            });
            csv += studentRow + "\n";
        });

        const filename = `전체_퀴즈_기록_${new Date().toLocaleDateString('ko-KR')}`;
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function exportToCSV(question, responses, filename) {
        if (!responses || Object.keys(responses).length === 0) {
            alert('다운로드할 응답 데이터가 없습니다.');
            return;
        }

        const data = Object.values(responses);
        
        let csv = `문제,응답자 이름,응답 내용,정답 여부,제출 시간\n`;
        
        const qText = (question.text || '이미지 문제').replace(/,/g, ' '); 
        const correctAnswer = (question.correctAnswer || '').trim().toLowerCase();

        data.forEach(r => {
            const name = r.name || '익명';
            const answer = (r.answer || '').replace(/,/g, ' '); 
            const isCorrect = (r.answer && correctAnswer) ? (r.answer.trim().toLowerCase() === correctAnswer) : '-';
            const date = new Date(r.timestamp).toLocaleString('ko-KR');
            const correctness = isCorrect === true ? 'O' : isCorrect === false ? 'X' : isCorrect;

            csv += `"${qText}","${name}","${answer}","${correctness}","${date}"\n`;
        });

        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
</script>

</body>
</html>
