<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ì‹¤ì‹œê°„ ì°¸ì—¬ í€´ì¦ˆ í”Œë«í¼ V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* BMJUA í°íŠ¸ ìŠ¤íƒ€ì¼ */
        @font-face {
            font-family: 'BMJUA';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/BMJUA.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'BMJUA', sans-serif;
            background-color: #f7f3e9;
            font-size: 18px; /* ê¸°ë³¸ ê¸€ì í¬ê¸° í™•ëŒ€ */
        }
        .container {
            max-width: 1100px; /* ì»¨í…Œì´ë„ˆ í­ í™•ëŒ€ */
            margin: 2rem auto;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* ì œëª© í¬ê¸° í™•ëŒ€ */
        h1 { font-size: 2.5rem !important; } 
        h2 { font-size: 2rem !important; }
        .text-xl { font-size: 1.5rem !important; }
        .text-2xl { font-size: 1.875rem !important; }
        
        /* í•™ìƒ ì§ˆë¬¸ í…ìŠ¤íŠ¸ í¬ê¸° ê°•ì¡° */
        #student-question-text { font-size: 3rem !important; line-height: 1.4; } 
        
        /* ë²„íŠ¼ ë° ê¸°íƒ€ ìŠ¤íƒ€ì¼ ìœ ì§€/ê°œì„  */
        .mode-button:hover { opacity: 0.8; }
        .hidden { display: none; }
        .result-bar {
            height: 35px; /* ë§‰ëŒ€ ê·¸ë˜í”„ ë†’ì´ í™•ëŒ€ */
            margin-bottom: 8px;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        #student-answer-buttons button {
            transition: all 0.2s;
            font-size: 1.3rem; /* í•™ìƒ ë²„íŠ¼ ê¸€ì í¬ê¸° í™•ëŒ€ */
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="font-bold text-center mb-10 text-indigo-700">ğŸš€ ì‹¤ì‹œê°„ ìˆ˜ì—… ì°¸ì—¬ í”Œë«í¼ V2.0</h1>
    
    <div id="mode-selection" class="flex justify-center space-x-6 mb-8">
        <button id="teacher-mode-btn" class="mode-button bg-red-500 text-white p-4 rounded-lg shadow-md font-semibold text-xl">
            ğŸ‘©â€ğŸ« êµì‚¬ ëª¨ë“œ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
        </button>
        <button id="student-mode-btn" class="mode-button bg-blue-500 text-white p-4 rounded-lg shadow-md font-semibold text-xl">
            ğŸ§‘â€ğŸ“ í•™ìƒ ëª¨ë“œ
        </button>
    </div>

    <hr class="mb-8 border-gray-300">

    <div id="teacher-panel" class="hidden">
        <h2 class="font-bold mb-5 text-red-600">êµì‚¬ ì œì–´íŒ</h2>
        
        <div class="p-8 border border-red-300 rounded-lg bg-red-50 mb-8">
            <label for="question-text" class="block font-semibold mb-3">ğŸ“ ì§ˆë¬¸ ë‚´ìš©:</label>
            <textarea id="question-text" rows="3" class="w-full border rounded p-3 mb-5 text-lg"></textarea>

            <label class="block font-semibold mb-3">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²¨ë¶€:</label>
            <div id="image-upload-area" class="border-2 border-dashed border-gray-400 p-5 mb-5 rounded-lg bg-white">
                <input type="file" id="image-file-input" accept="image/*" class="mb-3 block w-full text-lg">
                <p class="text-gray-600 text-base">ë˜ëŠ”, ì´ë¯¸ì§€ íŒŒì¼ì„ **ì´ ì˜ì—­ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)** í•˜ì„¸ìš”.</p>
                <div id="image-preview" class="mt-3 text-center hidden">
                    <p class="mb-2">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°:</p>
                    <img src="" id="current-image-preview" class="max-w-full h-auto mx-auto border border-gray-300 rounded max-h-64">
                    <button id="remove-image-btn" class="mt-3 bg-gray-400 hover:bg-gray-500 text-white p-2 rounded text-base">
                        âŒ ì´ë¯¸ì§€ ì œê±°
                    </button>
                </div>
            </div>

            <label for="question-type" class="block font-semibold mb-3">â“ ì§ˆë¬¸ ìœ í˜•:</label>
            <select id="question-type" class="w-full border rounded p-3 mb-5 bg-white text-lg">
                <option value="MCQ">ê°ê´€ì‹ (ë‹¤ì§€ì„ ë‹¤)</option>
                <option value="OX">OX í€´ì¦ˆ</option>
                <option value="ShortAnswer">ì£¼ê´€ì‹ (ë‹¨ë‹µí˜•)</option>
            </select>
            
            <div id="mcq-options-container">
                <label for="mcq-options" class="block font-semibold mb-3">ğŸ”¢ ê°ê´€ì‹ ë³´ê¸° (ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„):</label>
                <input type="text" id="mcq-options" class="w-full border rounded p-3 text-lg" value="1. ë„¤, 2. ì•„ë‹ˆì˜¤, 3. ì•„ë§ˆë„, 4. ê¸€ì„ìš”">
            </div>

            <div class="flex space-x-3 mt-6">
                <button id="post-question-btn" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg font-semibold flex-1 text-xl">
                    ğŸ“¢ ë¬¸ì œ ì¶œì œí•˜ê¸°
                </button>
                <button id="clear-results-btn" class="bg-gray-400 hover:bg-gray-500 text-white p-4 rounded-lg font-semibold w-1/4 text-xl">
                    ğŸ—‘ ê²°ê³¼ ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <div class="p-8 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-bold mb-5">ğŸ“Š ì‹¤ì‹œê°„ ì‘ë‹µ í˜„í™© (<span id="total-responses">0</span>ëª… ì°¸ì—¬)</h3>
            <div id="results-display" class="space-y-4">
                <p class="text-gray-500 text-lg">ë¬¸ì œê°€ ì¶œì œë˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div id="student-panel" class="hidden">
        <h2 class="font-bold mb-5 text-blue-600">í•™ìƒ ì‘ë‹µì°½</h2>
        
        <div id="student-login-area" class="p-8 border border-blue-300 rounded-lg bg-blue-50 mb-8">
            <label for="student-name" class="block font-semibold mb-3 text-lg">ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ ì…ë ¥:</label>
            <input type="text" id="student-name" class="w-full border rounded p-3 mb-5 text-xl" placeholder="ì˜ˆ: 1ë²ˆ ê¹€ì² ìˆ˜">
            <button id="student-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-semibold w-full text-xl">
                âœ… ì°¸ì—¬ ì‹œì‘
            </button>
        </div>

        <div id="student-quiz-area" class="hidden">
            <div class="p-8 border border-gray-300 rounded-lg bg-white mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">í˜„ì¬ ì§ˆë¬¸:</h3>
                <div id="student-question-image-container" class="mb-6 hidden">
                    <img id="student-question-image" class="max-w-full h-auto mx-auto border border-gray-200 rounded max-h-80">
                </div>
                <p id="student-question-text" class="font-extrabold text-gray-800 mb-6 text-center">
                    [ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ì¶œì œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.]
                </p>

                <div id="student-answer-buttons" class="grid grid-cols-2 gap-4 mb-4">
                    </div>
                
                <button id="submit-answer-btn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-semibold w-full text-xl hidden">
                    ğŸš€ ë‹µë³€ ì œì¶œí•˜ê¸°
                </button>
                <p id="submission-status" class="text-center mt-3 text-green-700 font-semibold text-lg hidden">âœ… ì‘ë‹µì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Firebase v9+ ëª¨ë“ˆ ì„í¬íŠ¸
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ----------------------------------------------------
    // 1. Firebase ì„¤ì • (ì„ ìƒë‹˜ì˜ ì‹¤ì œ í‚¤ ì ìš©)
    // ----------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAN1iAC82xKL_haJUs9291YBKNv7g7WSvU",
        authDomain: "foranswering-afec8.firebaseapp.com",
        databaseURL: "https://foranswering-afec8-default-rtdb.firebaseio.com",
        projectId: "foranswering-afec8",
        storageBucket: "foranswering-afec8.firebasestorage.app",
        messagingSenderId: "291098085525",
        appId: "1:291098085525:web:883a852c6320859294339c",
        measurementId: "G-5LP4KEWLXR"
    };

    // Firebase ì•± ë° ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ì •ì˜
    const QUESTION_PATH = 'quiz/currentQuestion';
    const RESPONSES_PATH = 'quiz/responses';

    // ----------------------------------------------------
    // 2. ë³€ìˆ˜ ë° UI ìš”ì†Œ ì •ì˜
    // ----------------------------------------------------
    const TEACHER_PASSWORD = "2948"; // ğŸ”’ ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸! (ê¼­ ë³€ê²½í•´ì£¼ì„¸ìš”)
    let currentStudentId = null; 
    let currentQuestionType = 'MCQ';
    let currentImageBase64 = null; // í˜„ì¬ ì²¨ë¶€ëœ ì´ë¯¸ì§€ Base64 ë°ì´í„°

    const teacherPanel = document.getElementById('teacher-panel');
    const studentPanel = document.getElementById('student-panel');
    const modeSelection = document.getElementById('mode-selection');
    const questionTextarea = document.getElementById('question-text');
    const questionTypeSelect = document.getElementById('question-type');
    const mcqOptionsContainer = document.getElementById('mcq-options-container');
    const mcqOptionsInput = document.getElementById('mcq-options');
    const totalResponsesEl = document.getElementById('total-responses');
    const resultsDisplay = document.getElementById('results-display');
    const studentQuestionTextEl = document.getElementById('student-question-text');
    const studentAnswerButtonsEl = document.getElementById('student-answer-buttons');
    const studentNameInput = document.getElementById('student-name');
    const studentQuizArea = document.getElementById('student-quiz-area');
    const studentLoginArea = document.getElementById('student-login-area');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const submissionStatusEl = document.getElementById('submission-status');
    // ì´ë¯¸ì§€ ê´€ë ¨ ìš”ì†Œ
    const imageFileInput = document.getElementById('image-file-input');
    const imageUploadArea = document.getElementById('image-upload-area');
    const imagePreviewContainer = document.getElementById('image-preview');
    const currentImagePreview = document.getElementById('current-image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const studentQuestionImageContainer = document.getElementById('student-question-image-container');
    const studentQuestionImage = document.getElementById('student-question-image');


    // ----------------------------------------------------
    // 3. ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë¶™ì—¬ë„£ê¸° ë¡œì§ (ì¶”ê°€ëœ í•µì‹¬ ê¸°ëŠ¥)
    // ----------------------------------------------------

    // Base64 ë¬¸ìì—´ì„ ì €ì¥í•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function setImage(base64Data) {
        currentImageBase64 = base64Data;
        currentImagePreview.src = base64Data;
        imagePreviewContainer.classList.remove('hidden');
    }

    // íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    imageFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => setImage(event.target.result);
            reader.readAsDataURL(file);
        }
    });

    // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì²˜ë¦¬)
    imageUploadArea.addEventListener('paste', (e) => {
        e.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë™ì‘ ë°©ì§€
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => setImage(event.target.result);
                reader.readAsDataURL(blob);
                break; // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë§Œ ì²˜ë¦¬
            }
        }
    });

    // ì´ë¯¸ì§€ ì œê±° ë²„íŠ¼ í•¸ë“¤ëŸ¬
    removeImageBtn.addEventListener('click', () => {
        currentImageBase64 = null;
        imageFileInput.value = ''; // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        imagePreviewContainer.classList.add('hidden');
    });


    // ----------------------------------------------------
    // 4. ëª¨ë“œ ì „í™˜ ë° ì´ˆê¸°í™” ë¡œì§
    // ----------------------------------------------------
    
    // ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ ê°ê´€ì‹ ë³´ê¸° ì…ë ¥ì°½ í‘œì‹œ/ìˆ¨ê¹€
    questionTypeSelect.addEventListener('change', (e) => {
        currentQuestionType = e.target.value;
        if (currentQuestionType === 'MCQ') {
            mcqOptionsContainer.classList.remove('hidden');
        } else {
            mcqOptionsContainer.classList.add('hidden');
        }
    });

    // êµì‚¬ ëª¨ë“œ ë³´ê¸° (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
    document.getElementById('teacher-mode-btn').addEventListener('click', () => {
        const password = prompt("êµì‚¬ ëª¨ë“œì— ì ‘ì†í•˜ì‹œë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        if (password === TEACHER_PASSWORD) {
            teacherPanel.classList.remove('hidden');
            studentPanel.classList.add('hidden');
            modeSelection.classList.add('hidden');
            listenForResponses();
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    });

    // í•™ìƒ ëª¨ë“œ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì´ˆê¸° í™”ë©´ í‘œì‹œ
    document.getElementById('student-mode-btn').addEventListener('click', () => {
        teacherPanel.classList.add('hidden');
        studentPanel.classList.remove('hidden');
        modeSelection.classList.add('hidden');
    });

    // í•™ìƒ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
    document.getElementById('student-login-btn').addEventListener('click', () => {
        const name = studentNameInput.value.trim();
        if (name) {
            currentStudentId = name.replace(/[.#$/[\]]/g, "_"); 
            studentLoginArea.classList.add('hidden');
            studentQuizArea.classList.remove('hidden');
            listenForQuestion();
            localStorage.setItem('quiz_student_name', name); 
        } else {
            alert('ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
    });

    // ìë™ ë¡œê·¸ì¸/ì´ë¦„ ë³µì›
    document.addEventListener('DOMContentLoaded', () => {
        const savedName = localStorage.getItem('quiz_student_name');
        if (savedName) {
            studentNameInput.value = savedName;
        }
    });


    // ----------------------------------------------------
    // 5. êµì‚¬ ë¡œì§ (ë¬¸ì œ ì¶œì œ ë° ê²°ê³¼ ì´ˆê¸°í™”)
    // ----------------------------------------------------

    document.getElementById('post-question-btn').addEventListener('click', postQuestion);

    function postQuestion() {
        const text = questionTextarea.value.trim();
        const type = questionTypeSelect.value;
        const options = type === 'MCQ' ? mcqOptionsInput.value.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];

        if (!text && !currentImageBase64) {
            alert('ì§ˆë¬¸ ë‚´ìš© ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì…ë ¥/ì²¨ë¶€í•´ì£¼ì„¸ìš”.');
            return;
        }

        // DBì— ìƒˆ ì§ˆë¬¸ ì„¤ì •
        set(ref(db, QUESTION_PATH), {
            text: text,
            type: type,
            options: options,
            image: currentImageBase64, // ì´ë¯¸ì§€ Base64 ë°ì´í„° ì¶”ê°€
            timestamp: Date.now()
        })
        .then(() => {
            alert('ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶œì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            // ìƒˆ ë¬¸ì œê°€ ì¶œì œë˜ë©´ ì‘ë‹µ ë°ì´í„°ë¥¼ ë¹„ì›Œì¤ë‹ˆë‹¤.
            remove(ref(db, RESPONSES_PATH)); 
            
            // ë¬¸ì œ ì¶œì œ í›„ êµì‚¬ í™”ë©´ì—ì„œ ì´ë¯¸ì§€ ë°ì´í„° ì´ˆê¸°í™” (ë‹¤ìŒ ë¬¸ì œë¥¼ ìœ„í•´)
            removeImageBtn.click(); 
        })
        .catch(error => {
            console.error('ë¬¸ì œ ì¶œì œ ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œ ì¶œì œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });
    }

    document.getElementById('clear-results-btn').addEventListener('click', clearResults);

    function clearResults() {
        if (!confirm("ëª¨ë“  ì‘ë‹µ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        remove(ref(db, RESPONSES_PATH))
        .then(() => {
            alert('ì‘ë‹µ ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        })
        .catch(error => {
            console.error('ê²°ê³¼ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        });
    }

    // ----------------------------------------------------
    // 6. í•™ìƒ ë¡œì§ (ì§ˆë¬¸ ìˆ˜ì‹  ë° ë‹µë³€ ì œì¶œ)
    // ----------------------------------------------------

    // ë‹µë³€ ì œì¶œ ë²„íŠ¼ í´ë¦­ (ê°ê´€ì‹/ì£¼ê´€ì‹ìš©)
    submitAnswerBtn.addEventListener('click', () => {
        let answer = null;
        
        if (currentQuestionType === 'ShortAnswer') {
            const input = document.getElementById('short-answer-input');
            answer = input ? input.value.trim() : null;
        } else { // MCQ
            const selected = document.querySelector('input[name="student-answer"]:checked');
            answer = selected ? selected.value : null;
        }

        if (answer) {
            submitAnswer(answer);
        } else {
            alert('ë‹µë³€ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
    });

    function submitAnswer(answer) {
        if (!currentStudentId) {
            alert('ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì°¸ì—¬ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        set(ref(db, `${RESPONSES_PATH}/${currentStudentId}`), {
            name: studentNameInput.value.trim(),
            answer: answer,
            timestamp: Date.now()
        })
        .then(() => {
            submissionStatusEl.classList.remove('hidden'); 
            setTimeout(() => submissionStatusEl.classList.add('hidden'), 3000);
            
            const disableElements = (elements) => elements.forEach(el => el.disabled = true);
            
            if (currentQuestionType === 'ShortAnswer') {
                disableElements(studentAnswerButtonsEl.querySelectorAll('textarea'));
            } else if (currentQuestionType === 'MCQ') {
                 disableElements(studentAnswerButtonsEl.querySelectorAll('input[type="radio"]'));
            } else if (currentQuestionType === 'OX') {
                 disableElements(studentAnswerButtonsEl.querySelectorAll('button'));
            }
            
            submitAnswerBtn.classList.add('hidden');
            localStorage.setItem('quiz_responded', 'true');
        })
        .catch(error => {
            console.error('ë‹µë³€ ì œì¶œ ì‹¤íŒ¨:', error);
            alert('ë‹µë³€ ì œì¶œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });
    }

    // ì‹¤ì‹œê°„ìœ¼ë¡œ ì§ˆë¬¸ ìˆ˜ì‹  ëŒ€ê¸° (í•™ìƒ ëª¨ë“œ)
    function listenForQuestion() {
        onValue(ref(db, QUESTION_PATH), (snapshot) => {
            const questionData = snapshot.val();
            
            if (questionData && (questionData.text || questionData.image)) {
                studentQuestionTextEl.textContent = questionData.text || '';
                currentQuestionType = questionData.type;
                localStorage.removeItem('quiz_responded');
                renderStudentInputs(questionData);

                // ì´ë¯¸ì§€ í‘œì‹œ ì²˜ë¦¬
                if (questionData.image) {
                    studentQuestionImage.src = questionData.image;
                    studentQuestionImageContainer.classList.remove('hidden');
                } else {
                    studentQuestionImageContainer.classList.add('hidden');
                }
            } else {
                studentQuestionTextEl.textContent = '[ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ì¶œì œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.]';
                studentAnswerButtonsEl.innerHTML = '';
                submitAnswerBtn.classList.add('hidden');
                studentQuestionImageContainer.classList.add('hidden');
            }
        });
    }

    // ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ í•™ìƒ ì…ë ¥ í•„ë“œë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§ (ë¡œì§ì€ V1.0ê³¼ ë™ì¼)
    function renderStudentInputs(question) {
        studentAnswerButtonsEl.innerHTML = ''; 
        submitAnswerBtn.classList.remove('hidden');
        submissionStatusEl.classList.add('hidden');

        const hasResponded = localStorage.getItem('quiz_responded') === 'true';

        if (question.type === 'OX') {
            const options = ['O', 'X'];
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = `p-5 text-2xl font-bold rounded-lg ${option === 'O' ? 'bg-green-100 hover:bg-green-200 text-green-700' : 'bg-red-100 hover:bg-red-200 text-red-700'}`;
                btn.textContent = option;
                btn.onclick = () => { submitAnswer(option); };
                if (hasResponded) btn.disabled = true;
                studentAnswerButtonsEl.appendChild(btn);
            });
            submitAnswerBtn.classList.add('hidden'); 
            
        } else if (question.type === 'MCQ' && question.options && question.options.length > 0) {
            question.options.forEach((option, index) => {
                const radioId = `mcq-option-${index}`;
                
                const div = document.createElement('div');
                div.className = 'flex items-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 cursor-pointer';

                const input = document.createElement('input');
                input.type = 'radio';
                input.id = radioId;
                input.name = 'student-answer';
                input.value = option;
                input.className = 'w-6 h-6 text-yellow-600 focus:ring-yellow-500 mr-4';
                if (hasResponded) input.disabled = true;
                
                const label = document.createElement('label');
                label.htmlFor = radioId;
                label.textContent = option;
                label.className = 'text-xl font-medium text-gray-700 flex-1';

                div.appendChild(input);
                div.appendChild(label);
                studentAnswerButtonsEl.appendChild(div);
            });
            submitAnswerBtn.classList.remove('hidden'); 
            if (hasResponded) submitAnswerBtn.disabled = true;

        } else if (question.type === 'ShortAnswer') {
            const input = document.createElement('textarea');
            input.id = 'short-answer-input';
            input.rows = 4;
            input.className = 'w-full border rounded p-4 text-xl';
            input.placeholder = 'ë‹µë³€ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.';
            if (hasResponded) input.disabled = true;
            studentAnswerButtonsEl.appendChild(input);
            submitAnswerBtn.classList.remove('hidden');
            if (hasResponded) submitAnswerBtn.disabled = true;
        } else {
             studentQuestionTextEl.textContent = '[ì„ ìƒë‹˜ì´ ë¬¸ì œ ìœ í˜• ë˜ëŠ” ë³´ê¸°ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.]';
             submitAnswerBtn.classList.add('hidden');
        }
    }


    // ----------------------------------------------------
    // 7. êµì‚¬ ë¡œì§ (ì‹¤ì‹œê°„ ê²°ê³¼ í‘œì‹œ)
    // ----------------------------------------------------

    function listenForResponses() {
        onValue(ref(db, RESPONSES_PATH), (snapshot) => {
            const responses = snapshot.val();
            renderResults(responses);
        });
    }

    function renderResults(responses) {
        resultsDisplay.innerHTML = '';
        if (!responses) {
            totalResponsesEl.textContent = 0;
            resultsDisplay.innerHTML = '<p class="text-gray-500 text-lg">ì•„ì§ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const responseList = Object.values(responses);
        const totalCount = responseList.length;
        totalResponsesEl.textContent = totalCount;

        onValue(ref(db, QUESTION_PATH), (qSnapshot) => {
            const question = qSnapshot.val();

            if (!question || !question.type) {
                resultsDisplay.innerHTML = '<p class="text-gray-500 text-lg">ë¬¸ì œê°€ ì¶œì œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            if (question.type === 'MCQ' || question.type === 'OX') {
                const results = {};
                responseList.forEach(r => {
                    const answer = r.answer || 'ë¯¸ì‘ë‹µ';
                    results[answer] = (results[answer] || 0) + 1;
                });
                
                const options = question.type === 'OX' ? ['O', 'X'] : question.options;
                const sortedResults = options.map(option => ({
                    answer: option,
                    count: results[option] || 0
                }));
                
                sortedResults.forEach((item, index) => {
                    const percentage = totalCount > 0 ? (item.count / totalCount) * 100 : 0;
                    const color = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500'][index % 4];
                    
                    resultsDisplay.innerHTML += `
                        <div class="mb-5">
                            <div class="flex justify-between mb-1 font-medium text-lg">
                                <span>${item.answer}</span>
                                <span>${item.count}ëª… (${percentage.toFixed(1)}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full">
                                <div class="result-bar ${color}" style="width: ${percentage}%;">
                                    
                                </div>
                            </div>
                        </div>
                    `;
                });
            } 
            
            else if (question.type === 'ShortAnswer') {
                resultsDisplay.innerHTML = '<h4 class="text-xl font-bold mb-4">ğŸ“ ì œì¶œëœ ì£¼ê´€ì‹ ë‹µë³€:</h4>';
                
                const ul = document.createElement('ul');
                ul.className = 'list-disc pl-6 space-y-3 text-lg';
                
                responseList.forEach(r => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${r.name || 'ìµëª…'}</strong>: <span class="text-gray-700">${r.answer}</span>`;
                    ul.appendChild(li);
                });
                resultsDisplay.appendChild(ul);
            }
        }, { onlyOnce: true }); 
    }

</script>

</body>
</html>