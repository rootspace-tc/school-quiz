<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí„° ì†ŒíŠ¸ í¼ì¦ (Water Sort Puzzle)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- êµ¬ê¸€ í°íŠ¸: Jua -->
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #1e1e2e; /* ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
            color: white;
            user-select: none;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* íŠœë¸Œ ìŠ¤íƒ€ì¼ */
        .tube {
            width: 70px;
            height: 240px; /* 4ì¹¸(50px * 4) + ì—¬ìœ  + ë°”ë‹¥ */
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            border-right: 4px solid rgba(255, 255, 255, 0.4);
            border-bottom: 4px solid rgba(255, 255, 255, 0.4);
            border-radius: 0 0 25px 25px; /* ë‘¥ê·¼ ë°”ë‹¥ (í”Œë¼ìŠ¤í¬ ëŠë‚Œ) */
            position: relative;
            display: flex;
            flex-direction: column-reverse; /* ì•„ë˜ì—ì„œ ìœ„ë¡œ ìŒ“ì„ */
            overflow: visible; /* ë¬¼ ë”°ë¥´ëŠ” ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ */
            cursor: pointer;
            transition: transform 0.3s ease;
            background-color: rgba(255, 255, 255, 0.05); /* ìœ ë¦¬ ëŠë‚Œ */
            margin: 10px;
        }

        /* íŠœë¸Œ ì…êµ¬ (í…Œë‘ë¦¬ ì¥ì‹) */
        .tube::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -6px;
            width: calc(100% + 8px);
            height: 10px;
            border: 4px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            box-sizing: border-box;
        }

        /* ì„ íƒëœ íŠœë¸Œ (ìœ„ë¡œ ì˜¬ë¼ì˜´) */
        .tube.selected {
            transform: translateY(-30px);
            border-color: rgba(255, 255, 255, 0.8);
        }

        /* ë¬¼(ì•¡ì²´) ìŠ¤íƒ€ì¼ */
        .liquid {
            width: 100%;
            height: 50px; /* ì „ì²´ ë†’ì´ì˜ 1/4 (ìµœëŒ€ 4ì¹¸) */
            transition: all 0.3s ease;
            position: relative;
        }

        /* ë¬¼ í‘œë©´ ë‘¥ê¸€ê²Œ (ë§¨ ìœ—ì¹¸ì´ê±°ë‚˜ í˜¼ì ìˆì„ ë•Œ) */
        .liquid:last-child {
            border-radius: 5px 5px 0 0;
        }
        /* íŠœë¸Œ ë°”ë‹¥ì˜ ë¬¼ ë‘¥ê¸€ê²Œ */
        .liquid:first-child {
            border-radius: 0 0 20px 20px;
        }
        /* ê½‰ ì°¼ì„ ë•Œ ë°”ë‹¥ê³¼ ìœ„ ëª¨ë‘ ë‘¥ê¸€ê²Œ */
        .liquid:first-child:last-child {
            border-radius: 0 0 20px 20px;
        }
        
        /* ë°˜ì§ì´ëŠ” íš¨ê³¼ */
        .liquid::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 5px;
            height: 80%;
            background-color: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* ìŠ¹ë¦¬ íŒŒí‹°í´ íš¨ê³¼ ì»¨í…Œì´ë„ˆ */
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .game-btn {
            background: linear-gradient(145deg, #4f46e5, #4338ca);
            box-shadow: 0 4px 0 #312e81;
            transition: all 0.1s;
        }
        .game-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê·¸ë£¹ */
        .control-btn {
            padding: 8px 16px;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            transition: background-color 0.2s;
        }

        /* ì‹œì‘ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        
        /* ìˆ¨ê¹€ í´ë˜ìŠ¤ */
        .hidden {
            display: none !important;
        }

        /* ì‹œì‘ ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ */
        .pulse-btn {
            animation: pulse-scale 1.5s infinite;
        }
        @keyframes pulse-scale {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen relative">

    <div id="confetti"></div>

    <!-- íƒ€ì´ë¨¸ í‘œì‹œ -->
    <div id="timer" class="absolute top-6 right-6 text-3xl font-bold bg-black/30 px-4 py-2 rounded-xl text-yellow-300">
        â±ï¸ 00:00
    </div>

    <!-- í—¤ë” -->
    <header class="text-center mb-4">
        <h1 class="text-5xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
            ğŸ§ª ì›Œí„° ì†ŒíŠ¸ í¼ì¦
        </h1>
        <p class="text-gray-400 text-xl">ê°™ì€ ìƒ‰ê¹” ë¬¼ë¼ë¦¬ ëª¨ì•„ë³´ì„¸ìš”!</p>
    </header>

    <!-- ë‚œì´ë„ ì„ íƒ -->
    <div class="flex gap-4 mb-4">
        <button onclick="initGame('easy')" class="game-btn px-6 py-2 rounded-xl text-lg font-bold">ì‰¬ì›€</button>
        <button onclick="initGame('normal')" class="game-btn px-6 py-2 rounded-xl text-lg font-bold">ë³´í†µ</button>
        <button onclick="initGame('hard')" class="game-btn px-6 py-2 rounded-xl text-lg font-bold">ì–´ë ¤ì›€</button>
    </div>

    <!-- ê²Œì„ ì»¨íŠ¸ë¡¤ (ë‹¤ì‹œí•˜ê¸° / ìƒˆ ê²Œì„) -->
    <div class="flex gap-4 mb-8">
        <button onclick="resetCurrentLevel()" class="control-btn bg-gray-600 hover:bg-gray-500">â†º ì²˜ìŒ ìƒíƒœë¡œ (ë‹¤ì‹œí•˜ê¸°)</button>
        <button onclick="startNewGame()" class="control-btn bg-emerald-600 hover:bg-emerald-500">âœ¨ ìƒˆë¡œìš´ ê²Œì„</button>
    </div>

    <!-- íŠœë¸Œë“¤ì´ ë†“ì¼ ê²Œì„ ë³´ë“œ -->
    <div id="game-board" class="flex flex-wrap justify-center items-end gap-2 max-w-4xl p-4 relative">
        <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ íŠœë¸Œ ìƒì„± -->
        
        <!-- ì‹œì‘ ì˜¤ë²„ë ˆì´ (ê²Œì„ ë³´ë“œ ìœ„ì— í‘œì‹œ) -->
        <div id="start-overlay" class="rounded-3xl">
            <button onclick="startGame()" class="pulse-btn bg-emerald-500 hover:bg-emerald-400 text-white text-3xl font-bold px-12 py-6 rounded-2xl shadow-lg border-b-4 border-emerald-700 transition-transform active:translate-y-1 active:border-b-0">
                â–¶ ê²Œì„ ì‹œì‘
            </button>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ì°½ -->
    <div id="message" class="mt-8 text-2xl font-bold text-yellow-400 h-8"></div>

    <!-- [ì¶”ê°€] ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ (ë¸Œë¼ìš°ì € ê¸°ë³¸ confirm ëŒ€ì²´) -->
    <div id="confirm-modal" class="hidden absolute inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-[#2a2a40] p-8 rounded-3xl text-center border-2 border-gray-600 shadow-2xl transform transition-all scale-100">
            <h3 class="text-3xl font-bold text-white mb-2">ìƒˆ ê²Œì„ì„ í• ê¹Œìš”?</h3>
            <p class="text-gray-400 text-lg mb-8">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²Œì„ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <div class="flex gap-4 justify-center">
                <button onclick="confirmNewGame()" class="bg-emerald-500 hover:bg-emerald-400 text-white px-8 py-3 rounded-2xl text-xl font-bold shadow-lg transition-transform active:scale-95">
                    ë„¤, ì¢‹ì•„ìš”!
                </button>
                <button onclick="closeConfirmModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-8 py-3 rounded-2xl text-xl font-bold shadow-lg transition-transform active:scale-95">
                    ì•„ë‹ˆìš”
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- ê²Œì„ ì„¤ì • ë° ë°ì´í„° ---
        const COLORS = [
            '#ef4444', // Red
            '#3b82f6', // Blue
            '#eab308', // Yellow
            '#22c55e', // Green
            '#a855f7', // Purple
            '#f97316', // Orange
            '#ec4899', // Pink
            '#14b8a6', // Teal
            '#6366f1'  // Indigo
        ];
        
        const TUBE_CAPACITY = 4; // íŠœë¸Œ í•˜ë‚˜ë‹¹ ìµœëŒ€ 4ì¹¸
        
        let tubes = []; // í˜„ì¬ íŠœë¸Œ ìƒíƒœ (2ì°¨ì› ë°°ì—´)
        let initialTubes = []; // ë¦¬ì…‹ìš© ì´ˆê¸° ìƒíƒœ
        let selectedTubeIndex = -1; // í˜„ì¬ ì„ íƒëœ íŠœë¸Œ (-1ì€ ì„ íƒ ì•ˆë¨)
        let isAnimating = false;
        let isGameActive = false; // ê²Œì„ í™œì„± ìƒíƒœ
        
        // ì¶”ê°€ëœ ìƒíƒœ ë³€ìˆ˜ë“¤
        let currentDifficulty = 'easy'; // í˜„ì¬ ë‚œì´ë„ ì €ì¥
        let timerInterval = null;
        let secondsElapsed = 0;
        let audioCtx = null; // Web Audio API ì»¨í…ìŠ¤íŠ¸

        // --- ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ (Web Audio API) ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // ë½! ì†Œë¦¬ (ì„ íƒ ì‹œ)
        function playPopSound() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.type = 'sine';
            // ì£¼íŒŒìˆ˜ ë¹ ë¥´ê²Œ ë–¨ì–´ëœ¨ë ¤ 'ë½' ëŠë‚Œ ë‚´ê¸°
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // [ìˆ˜ì •ë¨] ìª¼ë¥´ë¥µ ë¬¼ì†Œë¦¬ (Bubble Stream ë°©ì‹)
        function playPourSound() {
            initAudio();
            const now = audioCtx.currentTime;
            const bubbleCount = 7; // ë¬¼ë°©ìš¸ ê°œìˆ˜
            const duration = 0.4; // ì „ì²´ ì§€ì† ì‹œê°„

            for(let i=0; i<bubbleCount; i++) {
                const startTime = now + (Math.random() * duration);
                createBubble(startTime);
            }
        }

        // ë¬¼ë°©ìš¸ í•˜ë‚˜ ìƒì„± (ë¿…!)
        function createBubble(startTime) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // ë¬¼ë°©ìš¸ì€ ì‚¬ì¸íŒŒì˜ í”¼ì¹˜ê°€ ê¸‰ê²©íˆ ì˜¬ë¼ê°€ë©° ë°œìƒ
            osc.type = 'sine';
            // ëœë¤í•œ ì‹œì‘ ì£¼íŒŒìˆ˜ (500~1000Hz)
            const startFreq = 500 + Math.random() * 500;
            
            osc.frequency.setValueAtTime(startFreq, startTime);
            // 0.05ì´ˆ ë™ì•ˆ ì£¼íŒŒìˆ˜ê°€ ìœ„ë¡œ ì†Ÿêµ¬ì¹¨ (Glug sound)
            osc.frequency.exponentialRampToValueAtTime(startFreq * 2, startTime + 0.05);

            // ë³¼ë¥¨ ì—”ë²¨ë¡œí”„ (ì§§ê²Œ ì¹˜ê³  ë¹ ì§)
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(startTime);
            osc.stop(startTime + 0.1);
        }

        function playWinSound() {
            // ìŠ¹ë¦¬ ì‹œ ê°„ë‹¨í•œ íŒ¡íŒŒë ˆ (3í™”ìŒ)
            initAudio();
            const notes = [523.25, 659.25, 783.99]; // ë„, ë¯¸, ì†”
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = freq;
                
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.1 + (i*0.05));
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6 + (i*0.05));

                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + (i*0.1));
                osc.stop(audioCtx.currentTime + 1);
            });
        }


        // --- íƒ€ì´ë¨¸ ë¡œì§ ---
        function startTimer() {
            stopTimer(); // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ì§€
            secondsElapsed = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                secondsElapsed++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
            const seconds = (secondsElapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `â±ï¸ ${minutes}:${seconds}`;
        }


        // --- ì´ˆê¸°í™”: ë‚œì´ë„ë³„ ì„¤ì • ---
        function initGame(difficulty) {
            currentDifficulty = difficulty; 
            let colorCount, emptyCount;

            if (difficulty === 'easy') {
                colorCount = 3; emptyCount = 2; 
            } else if (difficulty === 'normal') {
                colorCount = 5; emptyCount = 2; 
            } else {
                colorCount = 7; emptyCount = 2; 
            }

            generateLevel(colorCount, emptyCount);
            render();
            
            // íƒ€ì´ë¨¸ ì •ì§€ ë° ì´ˆê¸°í™”
            stopTimer();
            secondsElapsed = 0;
            updateTimerDisplay();

            // ê²Œì„ ë¹„í™œì„±í™” ë° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
            isGameActive = false;
            document.getElementById('start-overlay').classList.remove('hidden');
            
            document.getElementById('message').innerText = "ì¤€ë¹„ê°€ ë˜ë©´ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!";
            document.getElementById('message').className = "mt-8 text-2xl font-bold text-gray-400 h-8";
            document.getElementById('confetti').innerHTML = '';
        }

        // --- [NEW] ê²Œì„ ì‹œì‘ í•¨ìˆ˜ ---
        function startGame() {
            initAudio(); // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” (ì‚¬ìš©ì ì œìŠ¤ì²˜)
            isGameActive = true;
            document.getElementById('start-overlay').classList.add('hidden');
            startTimer();
            document.getElementById('message').innerText = "íŠœë¸Œë¥¼ í´ë¦­í•´ì„œ ë¬¼ì„ ì˜®ê¸°ì„¸ìš”!";
            document.getElementById('message').className = "mt-8 text-2xl font-bold text-yellow-400 h-8";
            playPopSound(); // ì‹œì‘ìŒ
        }

        // --- [ìˆ˜ì •] ìƒˆë¡œìš´ ê²Œì„ ë²„íŠ¼ ë¡œì§ (ì»¤ìŠ¤í…€ ëª¨ë‹¬ ì‚¬ìš©) ---
        function startNewGame() {
            // ë¸Œë¼ìš°ì € ê¸°ë³¸ confirm ëŒ€ì‹  ì»¤ìŠ¤í…€ ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function confirmNewGame() {
            closeConfirmModal();
            initGame(currentDifficulty);
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        // --- ë ˆë²¨ ìƒì„±ê¸° (Reverse Shuffling) ---
        function generateLevel(colorCount, emptyCount) {
            tubes = [];
            for (let i = 0; i < colorCount; i++) {
                let tube = [];
                for (let j = 0; j < TUBE_CAPACITY; j++) {
                    tube.push(COLORS[i]);
                }
                tubes.push(tube);
            }
            for (let i = 0; i < emptyCount; i++) {
                tubes.push([]);
            }

            const shuffleMoves = colorCount * 50; 
            for (let i = 0; i < shuffleMoves; i++) {
                const fromIdx = Math.floor(Math.random() * tubes.length);
                const toIdx = Math.floor(Math.random() * tubes.length);

                if (fromIdx === toIdx) continue;
                if (tubes[fromIdx].length === 0) continue; 
                if (tubes[toIdx].length >= TUBE_CAPACITY) continue; 

                const color = tubes[fromIdx].pop();
                tubes[toIdx].push(color);
            }
            initialTubes = JSON.parse(JSON.stringify(tubes));
            selectedTubeIndex = -1;
        }

        // --- í˜„ì¬ ë ˆë²¨ ë‹¤ì‹œí•˜ê¸° ---
        function resetCurrentLevel() {
            tubes = JSON.parse(JSON.stringify(initialTubes));
            selectedTubeIndex = -1;
            render();
            // ë‹¤ì‹œí•˜ê¸°ëŠ” ë³´í†µ ë°”ë¡œ ë¦¬ì…‹ë˜ê¸¸ ì›í•˜ë¯€ë¡œ íƒ€ì´ë¨¸ë§Œ ë¦¬ì…‹í•˜ê³  ë°”ë¡œ ì‹œì‘
            stopTimer();
            secondsElapsed = 0;
            updateTimerDisplay();
            startTimer();
            
            document.getElementById('message').innerText = "ì²˜ìŒ ìƒíƒœë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.";
            document.getElementById('confetti').innerHTML = '';
        }

        // --- í™”ë©´ ê·¸ë¦¬ê¸° ---
        function render() {
            const board = document.getElementById('game-board');
            
            // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ìœ ì§€ (ì‚­ì œë˜ì§€ ì•Šë„ë¡)
            const overlay = document.getElementById('start-overlay');
            board.innerHTML = ''; // ì´ˆê¸°í™”
            if(overlay) board.appendChild(overlay); // ì˜¤ë²„ë ˆì´ ë‹¤ì‹œ ë¶™ì´ê¸°

            tubes.forEach((tube, index) => {
                const tubeEl = document.createElement('div');
                tubeEl.className = `tube ${index === selectedTubeIndex ? 'selected' : ''}`;
                tubeEl.onclick = () => handleTubeClick(index);

                tube.forEach(color => {
                    const liquid = document.createElement('div');
                    liquid.className = 'liquid';
                    liquid.style.backgroundColor = color;
                    tubeEl.appendChild(liquid);
                });

                board.insertBefore(tubeEl, overlay); // ì˜¤ë²„ë ˆì´ ë’¤ì— íŠœë¸Œ ì¶”ê°€
            });
        }

        // --- í´ë¦­ í•¸ë“¤ëŸ¬ ---
        function handleTubeClick(index) {
            // ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì´ë©´ ë¬´ì‹œ
            if (!isGameActive || isAnimating) return; 

            // ìµœì´ˆ í´ë¦­ ì‹œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            initAudio();

            // 1. ì„ íƒ
            if (selectedTubeIndex === -1) {
                if (tubes[index].length === 0) return; 
                selectedTubeIndex = index;
                playPopSound(); 
                render();
                return;
            }

            // 2. ì„ íƒ í•´ì œ
            if (selectedTubeIndex === index) {
                selectedTubeIndex = -1;
                playPopSound(); 
                render();
                return;
            }

            // 3. ì´ë™ ì‹œë„
            attemptPour(selectedTubeIndex, index);
        }

        // --- ë¬¼ ë¶“ê¸° ë¡œì§ ---
        function attemptPour(fromIdx, toIdx) {
            const fromTube = tubes[fromIdx];
            const toTube = tubes[toIdx];

            const colorToMove = fromTube[fromTube.length - 1];
            const targetColor = toTube.length > 0 ? toTube[toTube.length - 1] : null;

            if (toTube.length >= TUBE_CAPACITY) {
                showMessage("íŠœë¸Œê°€ ê½‰ ì°¼ìŠµë‹ˆë‹¤!");
                shakeTube(toIdx);
                selectedTubeIndex = -1;
                render();
                return;
            }

            if (targetColor !== null && targetColor !== colorToMove) {
                showMessage("ê°™ì€ ìƒ‰ê¹” ìœ„ì—ë§Œ ë¶€ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
                shakeTube(toIdx);
                selectedTubeIndex = -1;
                render();
                return;
            }

            let movedCount = 0;
            const spaceAvailable = TUBE_CAPACITY - toTube.length;

            while (
                fromTube.length > 0 && 
                fromTube[fromTube.length - 1] === colorToMove && 
                movedCount < spaceAvailable
            ) {
                fromTube.pop(); 
                toTube.push(colorToMove); 
                movedCount++;
            }

            selectedTubeIndex = -1;
            playPourSound(); // [ë³€ê²½ëœ íš¨ê³¼ìŒ]
            render();
            checkWin();
        }

        // --- ìŠ¹ë¦¬ ì¡°ê±´ ê²€ì‚¬ ---
        function checkWin() {
            const isWin = tubes.every(tube => {
                if (tube.length === 0) return true; 
                if (tube.length !== TUBE_CAPACITY) return false; 
                
                const firstColor = tube[0];
                return tube.every(color => color === firstColor);
            });

            if (isWin) {
                stopTimer();
                isGameActive = false; // ê²Œì„ ì¢…ë£Œ ìƒíƒœ
                const finalTime = document.getElementById('timer').innerText.replace('â±ï¸ ', '');
                document.getElementById('message').innerHTML = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${finalTime}ë§Œì— ì„±ê³µ! ğŸ‰`;
                document.getElementById('message').className = "mt-8 text-3xl font-bold text-green-400 h-8 animate-bounce";
                createConfetti();
                playWinSound();
            } else {
                document.getElementById('message').innerText = "";
            }
        }

        function showMessage(text) {
            const msgEl = document.getElementById('message');
            msgEl.innerText = text;
            setTimeout(() => {
                if(msgEl.innerText === text) msgEl.innerText = "";
            }, 1500);
        }

        function shakeTube(index) {
            const tubeEls = document.getElementsByClassName('tube');
            // ì˜¤ë²„ë ˆì´ ë•Œë¬¸ì— ì¸ë±ìŠ¤ê°€ ë°€ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íŠœë¸Œ í´ë˜ìŠ¤ë§Œ ì„ íƒ
            // íŠœë¸ŒëŠ” ì˜¤ë²„ë ˆì´(ë§ˆì§€ë§‰) ì•ì— ì¶”ê°€ë¨
            if (tubeEls[index]) {
                tubeEls[index].animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-5px)' },
                    { transform: 'translateX(5px)' },
                    { transform: 'translateX(0)' }
                ], {
                    duration: 300
                });
            }
        }

        function createConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            let confettiHtml = '';
            for(let i=0; i<100; i++) {
                const left = Math.random() * 100;
                const animDelay = Math.random() * 2;
                const bg = colors[Math.floor(Math.random() * colors.length)];
                confettiHtml += `<div style="
                    position: absolute;
                    left: ${left}%;
                    top: -10px;
                    width: 10px;
                    height: 10px;
                    background: ${bg};
                    animation: fall 3s linear ${animDelay}s infinite;
                "></div>`;
            }
            
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fall {
                    to { transform: translateY(100vh) rotate(720deg); }
                }
            `;
            document.head.appendChild(style);
            document.getElementById('confetti').innerHTML = confettiHtml;
        }

        // ê²Œì„ ì´ˆê¸°í™” (ëŒ€ê¸° ìƒíƒœ)
        initGame('easy');

    </script>
</body>
</html>