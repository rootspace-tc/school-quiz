<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒ‰ í˜¼í•© ë°°ìš°ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-picker@2.1.2/dist/vanilla-picker.min.css">
    
    <style>
        /* CSS: ì „ì²´ì ì¸ ë””ìì¸ */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Jua', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden;
        }

        body {
            display: grid;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header"
                "main"
                "palette";
            gap: 15px;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            grid-area: header;
            text-align: center;
            margin: 0;
            font-size: 2.5rem;
            color: #2c3e50;
        }

        /* ë©”ì¸ ì˜ì—­: ë¬¸ì œì™€ ìº”ë²„ìŠ¤ */
        .main-container {
            grid-area: main;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 0; /* ê·¸ë¦¬ë“œ/í”Œë ‰ìŠ¤ ì•„ì´í…œì´ ë¶€ëª¨ë¥¼ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ í•¨ */
        }

        /* ë¬¸ì œ ë° ì •ë‹µ ì˜ì—­ (ì™¼ìª½) */
        .problem-container {
            display: flex;
            flex-direction: column;
            justify-content: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            gap: 20px;
            padding: 25px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center; /* ë‚´ë¶€ ìš”ì†Œë“¤ì„ ì¤‘ì•™ ì •ë ¬ */
        }

        .problem-container h2 {
            margin: 0;
            font-size: 1.8rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px; /* ì œëª©ê³¼ ìƒ‰ìƒ ê²¬ë³¸ ì‚¬ì´ ê°„ê²© */
        }

        /* 'ë¬¼ê° íŠ„ ìêµ­' ë””ìì¸ */
        .splotch {
            width: 180px; /* ë¬¸ì œ ìƒ‰ìƒ í¬ê¸° ì¡°ì • */
            height: 180px;
            margin: 0 auto; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            border: 3px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            
            border-radius: 40% 60% 70% 30% / 30% 50% 50% 70%;
            transition: all 0.3s ease;
        }

        #problem-swatch {
            background-color: #ccc;
        }

        #answer-container {
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            margin-top: 20px;
        }
        
        #answer-container h3 {
            font-size: 1.5rem;
            margin: 10px 0;
        }

        .answer-swatches {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        /* ì •ë‹µ ìƒ‰ìƒ ê²¬ë³¸ (ì‘ì€ ì›) */
        .answer-swatch {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ìº”ë²„ìŠ¤ ì˜ì—­ (ì˜¤ë¥¸ìª½) */
        .canvas-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            position: relative; /* ìº”ë²„ìŠ¤ ìœ„ ì˜¤ë²„ë ˆì´ë¥¼ ìœ„í•´ */
        }

        #mix-canvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #fff; /* ìº”ë²„ìŠ¤ ìì²´ì˜ ë°°ê²½(í° ì¢…ì´) */
            cursor: crosshair; /* ë¶“ ëª¨ì–‘ ì»¤ì„œ */
        }

        .canvas-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            color: rgba(0,0,0,0.3);
            text-align: center;
            pointer-events: none; /* ìº”ë²„ìŠ¤ í´ë¦­ì— ë°©í•´ë˜ì§€ ì•Šë„ë¡ */
        }

        /* íŒ”ë ˆíŠ¸ ì˜ì—­ (í•˜ë‹¨) */
        .palette-container {
            grid-area: palette;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            align-items: center;
        }

        /* ì»¬ëŸ¬ í”¼ì»¤ ì»¨í…Œì´ë„ˆ */
        .color-picker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #picker-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #color-picker-target {
            width: 100px;
            height: 100px;
            border: 2px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            border-radius: 50%; /* í”¼ì»¤ ë²„íŠ¼ì€ ì›í˜•ìœ¼ë¡œ */
        }
        
        .current-color {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #current-swatch {
            width: 100px;
            height: 100px;
            background-color: rgb(128, 128, 128);
            border-radius: 55% 45% 30% 70% / 50% 60% 40% 50%;
            border: 2px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .paint-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }

        button {
            font-family: 'Jua', sans-serif;
            font-size: 1.2rem;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            flex-grow: 1;
        }

        #paint-1-btn { background-color: #3498db; }
        #paint-2-btn { background-color: #e67e22; }
        #check-btn   { background-color: #2ecc71; }
        #next-btn    { background-color: #9b59b6; display: none; }

        button:hover {
            opacity: 0.85;
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        #result-text {
            font-size: 1.5rem;
            color: #34495e;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <h1>ğŸ¨ ë¬¼ê° ìƒ‰ í˜¼í•© ë°°ìš°ê¸° ğŸ¨</h1>

    <main class="main-container">

        <section class="problem-container">
            <h2>ë¬¸ì œì˜ ìƒ‰ìƒ</h2>
            <div id="problem-swatch" class="splotch"></div>
            
            <div id="result-area">
                <p id="result-text"></p>
                <div id="answer-container">
                    <h3>ì •ë‹µ ì¡°í•©</h3>
                    <div class="answer-swatches">
                        <div id="answer-1" class="answer-swatch"></div>
                        <div id="answer-2" class="answer-swatch"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="canvas-container">
            <h2>ë‚˜ì˜ ìº”ë²„ìŠ¤ (í° ì¢…ì´)</h2>
            <canvas id="mix-canvas" width="600" height="400"></canvas>
            <div class="canvas-overlay-text" id="canvas-overlay">
                ì—¬ê¸°ì— ë¬¼ê°ì„ ì¹ í•´ ë³´ì„¸ìš”!
            </div>
        </section>

    </main>

    <footer class="palette-container">
        
        <div class="color-picker-container">
            <div id="color-picker-target" style="background-color: rgb(128,128,128);"></div>
            <span>í´ë¦­í•˜ì—¬ ìƒ‰ìƒ ì„ íƒ</span>
        </div>

        <div class="current-color">
            <div id="current-swatch"></div>
            <span>í˜„ì¬ ì„ íƒí•œ ìƒ‰</span>
        </div>

        <div class="paint-actions">
            <button id="paint-1-btn" data-color-target="1">1. ì²« ë²ˆì§¸ ìƒ‰ ì¹ í•˜ê¸°</button>
            <button id="paint-2-btn" data-color-target="2" disabled>2. ë‘ ë²ˆì§¸ ìƒ‰ ì¹ í•˜ê¸°</button>
            <button id="check-btn" disabled>3. ì •ë‹µ í™•ì¸í•˜ê¸°</button>
            <button id="next-btn">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/vanilla-picker@2.1.2/dist/vanilla-picker.min.js"></script>

    <script>
        // JavaScript: ê²Œì„ ë¡œì§
        window.onload = function() {
            
            // --- 1. ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const canvas = document.getElementById('mix-canvas');
            const ctx = canvas.getContext('2d');
            const canvasOverlay = document.getElementById('canvas-overlay');

            // íŒ”ë ˆíŠ¸
            const colorPickerTarget = document.getElementById('color-picker-target');
            const currentSwatch = document.getElementById('current-swatch');

            // ë¬¸ì œ
            const problemSwatch = document.getElementById('problem-swatch');
            
            // ë²„íŠ¼
            const paint1Btn = document.getElementById('paint-1-btn');
            const paint2Btn = document.getElementById('paint-2-btn');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');

            // ê²°ê³¼
            const resultText = document.getElementById('result-text');
            const answerContainer = document.getElementById('answer-container');
            const answer1 = document.getElementById('answer-1');
            const answer2 = document.getElementById('answer-2');

            // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
            let color1Paintings = []; // ì‚¬ìš©ìê°€ ì¹ í•œ ì²« ë²ˆì§¸ ìƒ‰ìƒ ë¬¼ê° ìêµ­ë“¤
            let color2Paintings = []; // ì‚¬ìš©ìê°€ ì¹ í•œ ë‘ ë²ˆì§¸ ìƒ‰ìƒ ë¬¼ê° ìêµ­ë“¤
            let problemColor = null; // ë¬¸ì œë¡œ ì¶œì œëœ ìƒ‰
            let correctColor1 = null; // ì •ë‹µ 1
            let correctColor2 = null; // ì •ë‹µ 2
            let activePaintingColorTarget = null; // í˜„ì¬ ì¹ í•˜ê³  ìˆëŠ” ìƒ‰ìƒ (1 ë˜ëŠ” 2)
            let selectedColor = { r: 128, g: 128, b: 128 }; // í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ (ì´ˆê¸°ê°’)

            let isPainting = false; // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì¤‘ì¸ì§€
            let lastX, lastY; // ë§ˆì§€ë§‰ ë§ˆìš°ìŠ¤ ìœ„ì¹˜

            // ë¬¸ì œ ì€í–‰ (ê°ì‚° í˜¼í•©ì—ì„œ ì˜ ì„ì´ëŠ” ìƒ‰ìƒ ìœ„ì£¼)
            const baseColors = [
                { r: 255, g: 0, b: 0 },    // ë¹¨ê°• (Magenta-ish)
                { r: 0, g: 255, b: 0 },    // ì´ˆë¡ (Yellow-ish)
                { r: 0, g: 0, b: 255 },    // íŒŒë‘ (Cyan-ish)
                { r: 255, g: 255, b: 0 }, // ë…¸ë‘ (R+G)
                { r: 0, g: 255, b: 255 }, // ì‹œì•ˆ (G+B)
                { r: 255, g: 0, b: 255 }, // ë§ˆì  íƒ€ (R+B)
                { r: 255, g: 128, b: 0 }, // ì£¼í™©
                { r: 128, g: 0, b: 128 }, // ë³´ë¼
                { r: 0, g: 128, b: 0 },    // ì¤‘ê°„ ì´ˆë¡
            ];

            // --- 2. í—¬í¼ í•¨ìˆ˜ ---

            /** RGB ê°ì²´ë¥¼ CSS ë¬¸ìì—´ "rgb(r, g, b)"ë¡œ ë³€í™˜ */
            function rgbToCss(rgb) {
                return `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }

            /**
             * ë‘ ìƒ‰ìƒì„ ê°ì‚° í˜¼í•©(Multiply)í•©ë‹ˆë‹¤.
             * ë¬¼ê° í˜¼í•©ì˜ ì›ë¦¬: (C1 * C2) / 255
             */
            function subtractiveMix(c1, c2) {
                return {
                    r: Math.round((c1.r * c2.r) / 255),
                    g: Math.round((c1.g * c2.g) / 255),
                    b: Math.round((c1.b * c2.b) / 255)
                };
            }

            /** * ë‘ RGB ìƒ‰ìƒ ê°„ì˜ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤ (0-100%)
             * 3D RGB ê³µê°„ì—ì„œì˜ ìœ í´ë¦¬ë“œ ê±°ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
             */
            function calculateColorSimilarity(rgb1, rgb2) {
                const deltaR = rgb1.r - rgb2.r;
                const deltaG = rgb1.g - rgb2.g;
                const deltaB = rgb1.b - rgb2.b;

                // 3D ê³µê°„ì—ì„œì˜ ê±°ë¦¬ ê³„ì‚°
                const distance = Math.sqrt(deltaR * deltaR + deltaG * deltaG + deltaB * deltaB);

                // ìµœëŒ€ ê°€ëŠ¥í•œ ê±°ë¦¬ (ê²€ì •[0,0,0] vs í°ìƒ‰[255,255,255])
                const maxDistance = Math.sqrt(3 * (255 * 255)); // ì•½ 441.67

                // ê±°ë¦¬ë¥¼ ìœ ì‚¬ë„(%)ë¡œ ë³€í™˜ (ê±°ë¦¬ê°€ 0ì´ë©´ 100% ìœ ì‚¬)
                const similarity = (1 - (distance / maxDistance)) * 100;
                return similarity.toFixed(1); // ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€
            }

            /** ë¹„ì •í˜• ë¬¼ê° ìêµ­ ê·¸ë¦¬ê¸° í•¨ìˆ˜ */
            function drawSplotch(context, x, y, size, color, rotation = 0) {
                context.save();
                context.translate(x, y);
                context.rotate(rotation);
                context.fillStyle = rgbToCss(color);
                
                context.beginPath();
                // ë³µì¡í•œ bezier ê³¡ì„ ìœ¼ë¡œ ë¹„ì •í˜• ëª¨ì–‘ ìƒì„±
                context.moveTo(0, -size / 2);
                context.bezierCurveTo(size / 3, -size / 2, size / 2, -size / 4, size / 2, 0);
                context.bezierCurveTo(size / 2, size / 4, size / 3, size / 2, 0, size / 2);
                context.bezierCurveTo(-size / 3, size / 2, -size / 2, size / 4, -size / 2, 0);
                context.bezierCurveTo(-size / 2, -size / 4, -size / 3, -size / 2, 0, -size / 2);
                context.closePath();
                context.fill();
                context.restore();
            }

            // --- 3. í•µì‹¬ ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---

            /** ìƒˆ ë¬¸ì œë¥¼ ìƒì„± */
            function generateProblem() {
                // 1. ë¬¸ì œ ìƒ‰ìƒ 2ê°œ ë¬´ì‘ìœ„ ì„ íƒ (ê²¹ì¹˜ì§€ ì•Šê²Œ, ë„ˆë¬´ ì–´ë‘¡ì§€ ì•Šì€ ìƒ‰ ìœ„ì£¼ë¡œ)
                let availableColors = baseColors.filter(c => (c.r > 50 && c.g > 50 && c.b > 50) || (c.r > 100 || c.g > 100 || c.b > 100)); // ë„ˆë¬´ ì–´ë‘ìš´ ìƒ‰ì€ ì œì™¸
                if (availableColors.length < 2) availableColors = baseColors; // ìµœì†Œí•œì˜ ìƒ‰ìƒ ë³´ì¥

                let index1 = Math.floor(Math.random() * availableColors.length);
                let index2 = index1;
                while (index2 === index1) {
                    index2 = Math.floor(Math.random() * availableColors.length);
                }
                
                correctColor1 = availableColors[index1];
                correctColor2 = availableColors[index2];

                // 2. ë‘ ìƒ‰ì„ í˜¼í•©í•˜ì—¬ ë¬¸ì œ ìƒ‰ìƒ(problemColor) ìƒì„±
                problemColor = subtractiveMix(correctColor1, correctColor2);
                
                // í˜¼í•©ëœ ìƒ‰ì´ ë„ˆë¬´ ì–´ë‘ìš°ë©´ ë‹¤ì‹œ ìƒì„± (ì˜ˆ: ë¹¨ê°• + ì´ˆë¡ + íŒŒë‘ -> ê±°ì˜ ê²€ì •)
                // í‰ê·  ë°ê¸°ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
                const avgBrightness = (problemColor.r + problemColor.g + problemColor.b) / 3;
                if (avgBrightness < 50) { // ë„ˆë¬´ ì–´ë‘¡ë‹¤ë©´ ë‹¤ì‹œ
                    console.log("Generated too dark, retrying problem...");
                    generateProblem();
                    return;
                }

                // 3. UI ì—…ë°ì´íŠ¸
                problemSwatch.style.backgroundColor = rgbToCss(problemColor);

                // 4. ìƒíƒœ ì´ˆê¸°í™”
                color1Paintings = [];
                color2Paintings = [];
                activePaintingColorTarget = null;
                drawCanvas(); // ìº”ë²„ìŠ¤ ë¹„ìš°ê¸°

                resultText.textContent = '';
                answerContainer.style.display = 'none';
                checkBtn.disabled = true;
                paint1Btn.disabled = false;
                paint2Btn.disabled = true;
                paint1Btn.textContent = '1. ì²« ë²ˆì§¸ ìƒ‰ ì¹ í•˜ê¸°';
                paint2Btn.textContent = '2. ë‘ ë²ˆì§¸ ìƒ‰ ì¹ í•˜ê¸°';
                checkBtn.style.display = 'block'; // ì •ë‹µ í™•ì¸ ë²„íŠ¼ì€ ë‹¤ì‹œ ë³´ì´ê²Œ
                nextBtn.style.display = 'none';
                canvasOverlay.textContent = 'ì—¬ê¸°ì— ë¬¼ê°ì„ ì¹ í•´ ë³´ì„¸ìš”!';
            }

            /** í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ ê²¬ë³¸ ì—…ë°ì´íŠ¸ */
            function updateCurrentColorSwatch() {
                currentSwatch.style.backgroundColor = rgbToCss(selectedColor);
                colorPickerTarget.style.backgroundColor = rgbToCss(selectedColor); // í”¼ì»¤ ë²„íŠ¼ ìƒ‰ìƒë„ ì—…ë°ì´íŠ¸
            }
            
            // --- ìº”ë²„ìŠ¤ ë“œë¡œì‰ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
            function startPainting(e) {
                if (!activePaintingColorTarget) return; // ì¹ í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•˜ìœ¼ë©´ ë™ì‘ ì•ˆ í•¨

                isPainting = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;

                addSplotch(lastX, lastY); // ì²« í´ë¦­ ì‹œ ë¬¼ê° ìêµ­ í•˜ë‚˜ ì¶”ê°€
            }

            function paint(e) {
                if (!isPainting || !activePaintingColorTarget) return;

                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                const distance = Math.sqrt(Math.pow(currentX - lastX, 2) + Math.pow(currentY - lastY, 2));
                if (distance > 15) { // ì¼ì • ê±°ë¦¬ ì´ìƒ ì´ë™í•´ì•¼ ìƒˆ ìêµ­ ì¶”ê°€ (ì¡°ê¸ˆ ë” ë„“ê²Œ ì¹ í•´ì§€ë„ë¡)
                    addSplotch(currentX, currentY);
                    lastX = currentX;
                    lastY = currentY;
                }
            }

            function stopPainting() {
                if (isPainting) { // ë“œë˜ê·¸ê°€ ëë‚¬ì„ ë•Œë§Œ
                    isPainting = false;
                    
                    // ì¹ í•˜ê¸° ì¤‘ì¸ ìƒ‰ìƒ íƒ€ê²Ÿì„ ë¹„í™œì„±í™” (ë²„íŠ¼ ëˆŒëŸ¬ì•¼ë§Œ ë‹¤ì‹œ ì¹ í•  ìˆ˜ ìˆë„ë¡)
                    // activePaintingColorTarget = null; // ì´ ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ì—¬, í•œ ë²ˆ ëˆ„ë¥¸ ìƒ‰ìƒì€ ê³„ì† ì¹ í•  ìˆ˜ ìˆë„ë¡ í•¨
                    
                    // ìƒ‰ìƒì´ ì¹ í•´ì¡Œìœ¼ë©´ ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ í™œì„±í™”
                    if (color1Paintings.length > 0) paint2Btn.disabled = false;
                    if (color1Paintings.length > 0 && color2Paintings.length > 0) checkBtn.disabled = false;

                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ìƒ ë³µêµ¬
                    if (activePaintingColorTarget === 1) {
                        paint1Btn.textContent = '1. ì²« ë²ˆì§¸ ìƒ‰ ì¹ í•˜ê¸° ì™„ë£Œ';
                        paint1Btn.disabled = true; // ì²« ë²ˆì§¸ ìƒ‰ì€ í•œ ë²ˆë§Œ ì¹ í•˜ë„ë¡
                    } else if (activePaintingColorTarget === 2) {
                        paint2Btn.textContent = '2. ë‘ ë²ˆì§¸ ìƒ‰ ì¹ í•˜ê¸° ì™„ë£Œ';
                        paint2Btn.disabled = true; // ë‘ ë²ˆì§¸ ìƒ‰ë„ í•œ ë²ˆë§Œ ì¹ í•˜ë„ë¡
                    }
                    canvasOverlay.textContent = 'ë¬¼ê°ì´ ì¹ í•´ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.';
                }
            }

            function addSplotch(x, y) {
                const size = Math.random() * 60 + 80; // 80px ~ 140px í¬ê¸°
                const rotation = Math.random() * Math.PI * 2; // ë¬´ì‘ìœ„ íšŒì „
                const newSplotch = { x, y, size, color: selectedColor, rotation };

                if (activePaintingColorTarget === 1) {
                    color1Paintings.push(newSplotch);
                } else if (activePaintingColorTarget === 2) {
                    color2Paintings.push(newSplotch);
                }
                drawCanvas();
            }

            /** ìº”ë²„ìŠ¤ì— ëª¨ë“  ë¬¼ê° ìêµ­ ê·¸ë¦¬ê¸° */
            function drawCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // ìº”ë²„ìŠ¤ ì „ì²´ ì§€ìš°ê¸°
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height); // í° ì¢…ì´ ë°°ê²½

                // ì²« ë²ˆì§¸ ìƒ‰ìƒ ë¬¼ê° ìêµ­ë“¤ ê·¸ë¦¬ê¸° (ê¸°ë³¸ ëª¨ë“œ)
                ctx.globalCompositeOperation = 'source-over';
                color1Paintings.forEach(p => {
                    drawSplotch(ctx, p.x, p.y, p.size, p.color, p.rotation);
                });

                // ë‘ ë²ˆì§¸ ìƒ‰ìƒ ë¬¼ê° ìêµ­ë“¤ ê·¸ë¦¬ê¸° (ê°ì‚° í˜¼í•© ëª¨ë“œ)
                if (color2Paintings.length > 0) {
                    // ì´ ë¶€ë¶„ì´ í•µì‹¬: ë‘ ë²ˆì§¸ ìƒ‰ìƒì„ ê·¸ë¦´ ë•Œ 'multiply' ëª¨ë“œë¡œ ì„¤ì •
                    ctx.globalCompositeOperation = 'multiply';
                    color2Paintings.forEach(p => {
                        drawSplotch(ctx, p.x, p.y, p.size, p.color, p.rotation);
                    });
                }
                // ë‹¤ìŒ ê·¸ë¦¼ì„ ìœ„í•´ í•­ìƒ 'source-over'ë¡œ ë³µì›
                ctx.globalCompositeOperation = 'source-over'; 

                // ìº”ë²„ìŠ¤ ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ í‘œì‹œ ì—¬ë¶€
                if (color1Paintings.length === 0 && color2Paintings.length === 0) {
                    canvasOverlay.style.display = 'block';
                } else {
                    canvasOverlay.style.display = 'none';
                }
            }
            
            /** 'ìƒ‰ ì¹ í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ */
            function handlePaintButtonClick(targetNumber) {
                // í˜„ì¬ ì¹ í•˜ê³  ìˆëŠ” ìƒ‰ìƒ íƒ€ê²Ÿì„ ì„¤ì •
                activePaintingColorTarget = targetNumber;
                canvasOverlay.textContent = `${targetNumber}ë²ˆì§¸ ë¬¼ê°ì„ ìº”ë²„ìŠ¤ì— ì¹ í•´ì£¼ì„¸ìš”! ë§ˆìš°ìŠ¤ë¥¼ í´ë¦­í•˜ê³  ë“œë˜ê·¸í•˜ì„¸ìš”.`;

                // ì¹ í•˜ê¸° ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ì„ ë¹„í™œì„±í™”í•˜ê³ , í˜„ì¬ ì¹ í•˜ëŠ” ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½
                paint1Btn.disabled = (targetNumber === 1); // 1ë²ˆ ì¹ í•˜ê¸° ì¤‘ì´ë©´ 1ë²ˆ ë²„íŠ¼ ë¹„í™œì„±í™” (ìƒˆë¡œìš´ ì¹ í•˜ê¸° ë§‰ìŒ)
                paint2Btn.disabled = (targetNumber === 2) || (color1Paintings.length === 0); // 2ë²ˆ ì¹ í•˜ê¸° ì¤‘ì´ê±°ë‚˜ 1ë²ˆ ì¹  ì•ˆí–ˆìœ¼ë©´ 2ë²ˆ ë¹„í™œì„±í™”
                checkBtn.disabled = true;
                nextBtn.disabled = true;

                if (targetNumber === 1) {
                    paint1Btn.textContent = '1. ì¹ í•˜ëŠ” ì¤‘...';
                } else { // targetNumber === 2
                    paint2Btn.textContent = '2. ì¹ í•˜ëŠ” ì¤‘...';
                }
            }

            /** 'ì •ë‹µ í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ */
            function checkAnswer() {
                if (color1Paintings.length === 0 || color2Paintings.length === 0) {
                    alert('ë‘ ê°€ì§€ ìƒ‰ì„ ëª¨ë‘ ìº”ë²„ìŠ¤ì— ì¹ í•´ì•¼ í•©ë‹ˆë‹¤!');
                    return;
                }

                // ìº”ë²„ìŠ¤ì˜ ìµœì¢… í˜¼í•©ëœ ìƒ‰ì„ í”½ì…€ ë°ì´í„°ë¡œ ì¶”ì¶œ
                // ìº”ë²„ìŠ¤ë¥¼ ì„ì‹œë¡œ ë³µì œí•˜ì—¬ ìµœì¢… ê²°ê³¼ ìƒ‰ìƒì„ ì–»ìŠµë‹ˆë‹¤.
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.fillStyle = '#FFFFFF';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                tempCtx.globalCompositeOperation = 'source-over';
                color1Paintings.forEach(p => {
                    drawSplotch(tempCtx, p.x, p.y, p.size, p.color, p.rotation);
                });

                tempCtx.globalCompositeOperation = 'multiply';
                color2Paintings.forEach(p => {
                    drawSplotch(tempCtx, p.x, p.y, p.size, p.color, p.rotation);
                });
                tempCtx.globalCompositeOperation = 'source-over';

                // ìº”ë²„ìŠ¤ì˜ ì¤‘ì•™ ë¶€ë¶„ í”½ì…€ í‰ê·  ìƒ‰ìƒ ì¶”ì¶œ (ê²¹ì¹˜ëŠ” ë¶€ë¶„)
                // ê²¹ì¹˜ëŠ” ì˜ì—­ì„ ëŒ€ëµì ìœ¼ë¡œ ì¡ì•„ ì¤‘ì•™ ë¶€ë¶„ì˜ í”½ì…€ì„ ìƒ˜í”Œë§
                const sampleAreaX1 = canvas.width / 4;
                const sampleAreaY1 = canvas.height / 4;
                const sampleAreaX2 = canvas.width * 3 / 4;
                const sampleAreaY2 = canvas.height * 3 / 4;

                const imageData = tempCtx.getImageData(sampleAreaX1, sampleAreaY1, sampleAreaX2 - sampleAreaX1, sampleAreaY2 - sampleAreaY1).data;
                let rSum = 0, gSum = 0, bSum = 0, pixelCount = 0;

                for (let i = 0; i < imageData.length; i += 4) {
                    const r = imageData[i];
                    const g = imageData[i + 1];
                    const b = imageData[i + 2];
                    const a = imageData[i + 3];

                    // íˆ¬ëª…í•˜ì§€ ì•Šê³  (ì™„ì „ í°ìƒ‰ì´ ì•„ë‹Œ) ìƒ‰ìƒ í”½ì…€ë§Œ ê³„ì‚°
                    if (a > 0 && !(r === 255 && g === 255 && b === 255)) { 
                        rSum += r;
                        gSum += g;
                        bSum += b;
                        pixelCount++;
                    }
                }

                let userMixedColor = { r: 255, g: 255, b: 255 }; // ê¸°ë³¸ í°ìƒ‰
                if (pixelCount > 0) {
                    userMixedColor = {
                        r: Math.round(rSum / pixelCount),
                        g: Math.round(gSum / pixelCount),
                        b: Math.round(bSum / pixelCount)
                    };
                } else {
                    alert('ìº”ë²„ìŠ¤ì— ë¬¼ê°ì´ ì¶©ë¶„íˆ ì¹ í•´ì§€ì§€ ì•Šì•˜ê±°ë‚˜ ê²¹ì¹˜ëŠ” ë¶€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤. ë” ë„“ê²Œ ì¹ í•˜ê±°ë‚˜ ê²¹ì³ì„œ ì¹ í•´ ë³´ì„¸ìš”.');
                    return;
                }

                // 2. ì‚¬ìš©ìì˜ í˜¼í•© ìƒ‰ê³¼ ë¬¸ì œì˜ ìƒ‰ ë¹„êµ
                const similarity = calculateColorSimilarity(userMixedColor, problemColor);

                // 3. ê²°ê³¼ í‘œì‹œ
                resultText.textContent = `ë¬¸ì œì˜ ìƒ‰ê³¼ ${similarity}% ì¼ì¹˜í•©ë‹ˆë‹¤!`;
                
                // 4. ì •ë‹µ ê³µê°œ
                answer1.style.backgroundColor = rgbToCss(correctColor1);
                answer2.style.backgroundColor = rgbToCss(correctColor2);
                answerContainer.style.display = 'block';

                // 5. ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                checkBtn.style.display = 'none';
                nextBtn.style.display = 'block';
                paint1Btn.disabled = true;
                paint2Btn.disabled = true;
                activePaintingColorTarget = null;
                canvasOverlay.textContent = 'ì •ë‹µì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì œë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”!';
            }

            // --- 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
            
            // Vanilla Picker ì´ˆê¸°í™”
            const picker = new Picker({
                parent: colorPickerTarget,
                popup: 'right', // íŒì—… ìœ„ì¹˜
                color: selectedColor,
                alpha: false, // íˆ¬ëª…ë„ ì¡°ì ˆ ë¹„í™œì„±í™”
                onDone: function(color) {
                    selectedColor = color.rgb; // Pickerì—ì„œ ì„ íƒëœ ìƒ‰ìƒ ì €ì¥
                    updateCurrentColorSwatch(); // ì„ íƒ ìƒ‰ìƒ ê²¬ë³¸ ì—…ë°ì´íŠ¸
                }
            });

            // ì´ˆê¸° Picker ë²„íŠ¼ ë° í˜„ì¬ ìƒ‰ìƒ ê²¬ë³¸ ì—…ë°ì´íŠ¸
            updateCurrentColorSwatch();


            // ìº”ë²„ìŠ¤ ë“œë¡œì‰ ì´ë²¤íŠ¸
            canvas.addEventListener('mousedown', startPainting);
            canvas.addEventListener('mouseup', stopPainting);
            canvas.addEventListener('mouseout', stopPainting); // ìº”ë²„ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ë“œë˜ê·¸ ì¤‘ë‹¨
            canvas.addEventListener('mousemove', paint);

            // ë²„íŠ¼
            paint1Btn.addEventListener('click', () => handlePaintButtonClick(1));
            paint2Btn.addEventListener('click', () => handlePaintButtonClick(2));
            checkBtn.addEventListener('click', checkAnswer);
            nextBtn.addEventListener('click', generateProblem);

            // --- 5. ê²Œì„ ì‹œì‘ ---
            generateProblem(); // ì²« ë²ˆì§¸ ë¬¸ì œ ì¶œì œ
        };
    </script>

</body>
</html>