<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>디지털 시계와 알림장</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f7e1e1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #4a2828;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .date { font-size: 3rem; margin-bottom: 0.5rem; color: #8a6552; }
        .time { font-size: 7rem; font-weight: bold; line-height: 1; margin-bottom: 2rem; text-shadow: 2px 2px #f0a3a3; }
        .time .time-label { font-size: 2.5rem; font-weight: normal; }
        
        .button-row { display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem; }
        .button {
            background-color: #f0a3a3; color: white; padding: 0.75rem 1.5rem;
            border-radius: 9999px; font-weight: bold; transition: background-color 0.3s;
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; outline: none;
        }
        .button:hover { background-color: #e57373; }
        .button.selected { background-color: #b76c6c; }

        .content-section {
            width: 100%; margin-top: 2rem; background-color: #fff9f9;
            border-radius: 1.5rem; padding: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }

        .goal-label { font-size: 1.5rem; margin-bottom: 1rem; color: #8a6552; }
        .goal-display { font-size: 7rem; font-weight: bold; line-height: 1; margin-bottom: 1rem; color: #4CAF50; text-shadow: 2px 2px #FFEB3B; }
        .goal-display .time-label { font-size: 2.5rem; font-weight: normal; }
        .remaining-time-display { font-size: 7rem; font-weight: bold; color: #E53935; text-shadow: 2px 2px #f0a3a3; }
        .goal-input {
            width: 100%; padding: 0.75rem; border-radius: 1rem; border: 2px solid #f0a3a3;
            background-color: white; font-family: 'Jua', sans-serif; text-align: center;
        }
        #memo-area {
            width: 100%; height: 300px; border: 2px solid #a0c4ff; border-radius: 1rem;
            padding: 20px; box-sizing: border-box; font-family: 'Jua', sans-serif;
            font-size: 2.5rem; line-height: 1.6; resize: vertical;
        }
        .memo-controls { margin-top: 1rem; }

        .message-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: #ffe0e0; padding: 2rem; border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000; text-align: center;
            border: 2px solid #e57373;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="date-container">
            <div id="date-display" class="date"></div>
        </div>
        <div class="time-container">
            <div id="time-display" class="time"></div>
        </div>

        <div class="button-row">
            <button id="show-memo-button" class="button">알림장</button>
            <button id="show-goal-button" class="button">목표 시간 설정</button>
            <button id="tts-toggle-button" class="button">TTS 켜기</button>
            <div id="tts-interval-container" class="button-row">
                <button class="tts-interval-button button" data-interval="1">1분</button>
                <button class="tts-interval-button button" data-interval="3">3분</button>
                <button class="tts-interval-button button" data-interval="5">5분</button>
                <button class="tts-interval-button button" data-interval="10">10분</button>
                <button class="tts-interval-button button" data-interval="30">30분</button>
            </div>
        </div>

        <div id="goal-section" class="content-section hidden">
             <h2 class="goal-label">목표 시간 설정</h2>
            <div class="flex flex-col gap-4 items-center">
                <input type="datetime-local" id="goal-time-input" class="goal-input">
                <div class="button-row mt-4">
                    <button id="set-goal-button" class="button">목표 설정</button>
                    <button id="close-goal-button" class="button">목표 닫기</button>
                </div>
            </div>
            <div id="goal-time-display" class="goal-display mt-4"></div>
            <div id="remaining-time-display" class="remaining-time-display"></div>
        </div>

        <div id="memo-section" class="content-section hidden">
            <textarea id="memo-area" placeholder="알림장 내용을 입력하세요..."></textarea>
            <div class="memo-controls">
                <button id="decrease-font" class="button">-</button>
                <button id="increase-font" class="button">+</button>
            </div>
        </div>
    </div>
    
    <div id="message-box" class="message-box hidden">
        <p id="message-text" class="text-lg font-bold mb-4"></p>
        <button id="close-message-box" class="button">확인</button>
    </div>

    <audio id="goal-set-sound" src="이곳에 '목표 설정' 효과음 Base64 코드를 넣어주세요"></audio>
    <audio id="countdown-beep" src="이곳에 '10초 카운트다운' 효과음 Base64 코드를 넣어주세요"></audio>
    
    <script>
        // --- DOM 요소 ---
        const dateDisplay = document.getElementById('date-display');
        const timeDisplay = document.getElementById('time-display');
        const showGoalButton = document.getElementById('show-goal-button');
        const ttsToggleButton = document.getElementById('tts-toggle-button');
        const ttsIntervalButtons = document.querySelectorAll('.tts-interval-button');
        const goalSection = document.getElementById('goal-section');
        const goalTimeInput = document.getElementById('goal-time-input');
        const setGoalButton = document.getElementById('set-goal-button');
        const goalTimeDisplay = document.getElementById('goal-time-display');
        const remainingTimeDisplay = document.getElementById('remaining-time-display');
        const closeGoalButton = document.getElementById('close-goal-button');
        const ttsIntervalContainer = document.getElementById('tts-interval-container');
        const showMemoButton = document.getElementById('show-memo-button');
        const memoSection = document.getElementById('memo-section');
        const memoArea = document.getElementById('memo-area');
        const increaseFontBtn = document.getElementById('increase-font');
        const decreaseFontBtn = document.getElementById('decrease-font');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBoxButton = document.getElementById('close-message-box');
        
        // --- 오디오 & TTS 관련 ---
        const countdownBeep = document.getElementById('countdown-beep');
        const goalSetSound = document.getElementById('goal-set-sound');
        const alarmMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
        let isAudioUnlocked = false;
        let isTtsEnabled = true;
        let ttsIntervalMinutes = 1;
        let lastTtsSpeakMinute = -1;
        
        // --- 상태 변수 ---
        let goalInterval;
        let goalTime = null;
        let memoFontSize = 2.5;

        // --- ✨ 안정성 개선: 오디오 잠금 해제 함수 ---
        function unlockAudio() {
            if (isAudioUnlocked) return;
            const allAudio = [alarmMusic, countdownBeep, goalSetSound];
            allAudio.forEach(audio => {
                audio.play().catch(() => {});
                audio.pause();
                audio.currentTime = 0;
            });
            isAudioUnlocked = true;
        }

        // --- 함수 선언 ---
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }
        function closeMessageBox() {
            messageBox.classList.add('hidden');
        }
        
        function updateClock() {
            const now = new Date();
            dateDisplay.textContent = now.toLocaleDateString('ko-KR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const ampm = now.getHours() >= 12 ? '오후' : '오전';
            const hours = String(now.getHours() % 12 || 12).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            timeDisplay.innerHTML = `${ampm} <span class="time-number">${hours}</span><span class="time-label">시</span> <span class="time-number">${minutes}</span><span class="time-label">분</span> <span class="time-number">${seconds}</span><span class="time-label">초</span>`;
        }
        
        function speakText(text) {
            if (!isTtsEnabled) return;
            unlockAudio(); // TTS 사용 전에도 오디오 잠금 해제
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            window.speechSynthesis.speak(utterance);
        }
        
        function playBeep() { if (countdownBeep) { countdownBeep.currentTime = 0; countdownBeep.play().catch(e => {}); } }
        function playGoalSetSound() { if (goalSetSound) { goalSetSound.currentTime = 0; goalSetSound.play().catch(e => {}); } }
        
        function updateGoalDisplay() {
            if (!goalTime) return;
            const diff = goalTime.getTime() - new Date().getTime();
            if (diff <= 0) {
                clearInterval(goalInterval);
                remainingTimeDisplay.textContent = "목표 달성!";
                alarmMusic.play();
                speakText("목표 시간을 달성했습니다!");
                return;
            }
            if (diff <= 10000) { playBeep(); }
            if (isTtsEnabled && diff > 10000) {
                const minutesRemaining = Math.ceil(diff / 60000);
                if (minutesRemaining > 0 && minutesRemaining % ttsIntervalMinutes === 0 && minutesRemaining !== lastTtsSpeakMinute) {
                    speakText(`${minutesRemaining}분 남았습니다`);
                    lastTtsSpeakMinute = minutesRemaining;
                }
            }
            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / 60000) % 60);
            const hours = Math.floor(diff / 3600000);
            remainingTimeDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function changeMemoFontSize(amount) {
            memoFontSize += amount * 0.2;
            memoFontSize = Math.max(1, memoFontSize);
            memoArea.style.fontSize = `${memoFontSize}rem`;
            localStorage.setItem('memoFontSize', memoFontSize);
        }

        // --- 이벤트 리스너 설정 ---
        closeMessageBoxButton.addEventListener('click', closeMessageBox);
        setInterval(updateClock, 1000);
        
        showGoalButton.addEventListener('click', () => {
            unlockAudio();
            memoSection.classList.add('hidden');
            goalSection.classList.toggle('hidden');
            ttsIntervalContainer.style.display = goalSection.classList.contains('hidden') ? 'none' : 'flex';
        });
        
        showMemoButton.addEventListener('click', () => {
            unlockAudio();
            goalSection.classList.add('hidden');
            ttsIntervalContainer.style.display = 'none';
            memoSection.classList.toggle('hidden');
        });

        ttsToggleButton.addEventListener('click', () => {
            unlockAudio();
            isTtsEnabled = !isTtsEnabled;
            ttsToggleButton.textContent = isTtsEnabled ? 'TTS 끄기' : 'TTS 켜기';
            showMessage(isTtsEnabled ? "TTS 기능이 켜졌습니다." : "TTS 기능이 꺼졌습니다.");
            if (!isTtsEnabled) window.speechSynthesis.cancel();
            else lastTtsSpeakMinute = -1;
        });

        ttsIntervalButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                unlockAudio();
                ttsIntervalButtons.forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                ttsIntervalMinutes = parseInt(e.target.dataset.interval, 10);
                showMessage(`${ttsIntervalMinutes}분 간격으로 TTS가 설정되었습니다.`);
                lastTtsSpeakMinute = -1;
            });
        });

        setGoalButton.addEventListener('click', () => {
            const goalDate = goalTimeInput.value;
            if (!goalDate) { showMessage("목표 시간을 설정해 주세요."); return; }
            goalTime = new Date(goalDate);
            if (goalTime.getTime() <= new Date().getTime()) {
                showMessage("현재 시간보다 이후의 시간을 설정해 주세요."); return;
            }
            playGoalSetSound();
            const initialDiff = goalTime.getTime() - new Date().getTime();
            if (isTtsEnabled && initialDiff > 10000) {
                lastTtsSpeakMinute = Math.ceil(initialDiff / 60000);
            }
            const ampm = goalTime.getHours() >= 12 ? '오후' : '오전';
            const hours = String(goalTime.getHours() % 12 || 12).padStart(2, '0');
            const minutes = String(goalTime.getMinutes()).padStart(2, '0');
            goalTimeDisplay.innerHTML = `${ampm} ${hours}<span class="time-label">시</span> ${minutes}<span class="time-label">분</span> 까지`;
            if (goalInterval) clearInterval(goalInterval);
            updateGoalDisplay();
            goalInterval = setInterval(updateGoalDisplay, 1000);
        });
        
        closeGoalButton.addEventListener('click', () => {
            if (goalInterval) clearInterval(goalInterval);
            alarmMusic.pause(); alarmMusic.currentTime = 0;
            goalTime = null; goalTimeDisplay.textContent = ''; remainingTimeDisplay.textContent = '';
            goalSection.classList.add('hidden'); ttsIntervalContainer.style.display = 'none';
            window.speechSynthesis.cancel();
        });

        memoArea.addEventListener('input', () => { localStorage.setItem('memoContent', memoArea.value); });
        increaseFontBtn.addEventListener('click', () => changeMemoFontSize(1));
        decreaseFontBtn.addEventListener('click', () => changeMemoFontSize(-1));

        // --- 페이지 로드 시 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            document.querySelector('.tts-interval-button[data-interval="1"]').classList.add('selected');
            ttsIntervalContainer.style.display = 'none';
            messageBox.style.display = 'none'; // ✨ 안정성을 위해 JS로도 숨김 처리
            const savedMemo = localStorage.getItem('memoContent');
            if (savedMemo) memoArea.value = savedMemo;
            const savedFontSize = localStorage.getItem('memoFontSize');
            if (savedFontSize) {
                memoFontSize = parseFloat(savedFontSize);
                memoArea.style.fontSize = `${memoFontSize}rem`;
            }
        });
    </script>
</body>
</html>
