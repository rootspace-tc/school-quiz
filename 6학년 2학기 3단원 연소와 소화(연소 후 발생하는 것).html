<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연소 후 생기는 물질은 무엇일까?</title>
    <!-- Jua 글꼴 불러오기 --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <!-- Tailwind CSS 불러오기 --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Jua', sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8; /* 밝은 실험실 배경색 */
        }
        .canvas-container {
            background-color: #ffffff;
            border: 2px solid #90a4ae;
            border-radius: 0.5rem;
            padding: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: grab;
        }
        .canvas-container:active {
            cursor: grabbing;
        }
        canvas {
            display: block;
        }
        .tab-button {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 1.1rem;
            border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            border-color: #1d4ed8;
        }
        .tab-button:not(.active) {
            background-color: #e5e7eb;
        }
        .tab-button.disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col items-center justify-center w-screen h-screen p-4">

    <div class="flex flex-col lg:flex-row items-center justify-center gap-8 w-full">
        <!-- 시뮬레이션 영역 -->
        <div class="flex flex-col gap-2">
            <!-- 탭 버튼 -->
            <div id="tab-buttons" class="flex justify-center gap-2">
                <button class="tab-button active" data-tab="combustion">① 연소 과정</button>
                <button class="tab-button disabled" data-tab="water" id="water-tab-btn">② 물 검출</button>
                <button class="tab-button disabled" data-tab="co2" id="co2-tab-btn">③ CO₂ 검출</button>
            </div>
            <!-- 탭 콘텐츠 -->
            <div id="tab-contents">
                <div id="combustion-content" class="tab-content active canvas-container">
                    <canvas id="combustionCanvas"></canvas>
                </div>
                <div id="water-content" class="tab-content canvas-container">
                    <canvas id="waterDetectCanvas"></canvas>
                </div>
                <div id="co2-content" class="tab-content canvas-container">
                    <canvas id="co2DetectCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- 설명 및 컨트롤 패널 -->
        <div id="controls" class="p-6 bg-white rounded-xl shadow-2xl flex flex-col gap-4 w-full max-w-sm">
            <h1 id="title" class="text-3xl font-bold text-center text-blue-600">연소 생성물 확인 실험</h1>
            <p id="desc" class="text-center text-lg h-24">
                '실험 시작' 버튼을 눌러 양초를 태우고, 생성된 물질을 직접 검출해 보세요.
            </p>
            <div class="flex items-center gap-2">
                <label for="moleculeFontSizeSlider" class="whitespace-nowrap">분자 글씨 크기:</label>
                <input type="range" id="moleculeFontSizeSlider" min="8" max="24" value="14" class="w-full">
            </div>
            <div class="mt-2 flex justify-center">
                <button id="startButton" class="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-white text-xl rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    실험 시작
                </button>
            </div>
             <div id="info-panel" class="mt-4 pt-4 border-t-2 space-y-2">
                 <!-- 내용이 JS를 통해 동적으로 채워짐 -->
            </div>
        </div>
    </div>

    <script>
        // 캔버스 및 컨텍스트
        const combustionCanvas = document.getElementById('combustionCanvas');
        const combustionCtx = combustionCanvas.getContext('2d');
        const waterCanvas = document.getElementById('waterDetectCanvas');
        const waterCtx = waterCanvas.getContext('2d');
        const co2Canvas = document.getElementById('co2DetectCanvas');
        const co2Ctx = co2Canvas.getContext('2d');
        
        // UI 요소
        const desc = document.getElementById('desc');
        const startButton = document.getElementById('startButton');
        const moleculeFontSizeSlider = document.getElementById('moleculeFontSizeSlider');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const infoPanel = document.getElementById('info-panel');
        const waterTabBtn = document.getElementById('water-tab-btn');
        const co2TabBtn = document.getElementById('co2-tab-btn');

        // 캔버스 크기 설정
        const canvasSize = Math.min(window.innerHeight * 0.7, 500);
        [combustionCanvas, waterCanvas, co2Canvas].forEach(c => {
            c.width = canvasSize;
            c.height = canvasSize;
        });

        // 전역 상태 변수
        let molecules = [];
        let isBurning = false;
        let animationFrameId;
        let moleculeFontSize = 14;
        let simulationFinished = false;
        let activeTab = 'combustion';
        
        // 검출 실험 상태
        let waterMolecules = [];
        let co2Molecules = [];
        let cobaltPaperState = 'blue'; // blue, red
        let limewaterState = 'clear'; // clear, cloudy, clear_again
        let co2AddedCount = 0;
        let draggingMolecule = null;

        const OXYGEN_COUNT = 30;
        const OXYGEN_THRESHOLD = OXYGEN_COUNT * 0.1; 

        // 이벤트 리스너
        moleculeFontSizeSlider.addEventListener('input', (e) => { moleculeFontSize = parseInt(e.target.value); });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.classList.contains('disabled')) return;
                const tabName = button.dataset.tab;
                setActiveTab(tabName);
            });
        });

        function setActiveTab(tabName) {
            activeTab = tabName;
            tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === tabName));
            tabContents.forEach(c => c.classList.toggle('active', c.id.startsWith(tabName)));
            updateInfoPanel();
        }

        function updateInfoPanel() {
            infoPanel.innerHTML = ''; // 초기화
            if (activeTab === 'combustion') {
                infoPanel.innerHTML = `<p class="text-base text-center bg-gray-100 p-2 rounded-lg">양초가 <strong class="text-red-500">'산소(O₂)'</strong>와 만나 빛과 열을 내며 타는 <strong class="text-red-500">'연소'</strong> 과정입니다.</p>`;
            } else if (activeTab === 'water') {
                infoPanel.innerHTML = `
                    <p class="text-base mb-2">H₂O 분자를 드래그해서 종이에 올려보세요.</p>
                    <div class="text-center bg-blue-50 p-3 rounded-lg">
                        <strong class="text-blue-500">물(H₂O)</strong> + 푸른 염화코발트 종이 ⟶ <strong class="text-red-500">붉은색 변화</strong>
                    </div>
                    <p class="text-sm text-center mt-2">염화코발트 종이는 물과 반응하면 색이 변하는 성질이 있어요. (CoCl₂ + 6H₂O ⟶ [Co(H₂O)₆]Cl₂)</p>
                `;
            } else if (activeTab === 'co2') {
                let html = `<p class="text-base mb-2">CO₂ 분자를 드래그해서 석회수에 넣어보세요.</p>`;
                if (limewaterState === 'clear') {
                     html += `<div class="text-center bg-yellow-50 p-3 rounded-lg">
                        <strong class="text-yellow-500">CO₂</strong> + 석회수 ⟶ <strong class="text-gray-500">뿌옇게 흐려짐</strong>
                     </div>
                     <p class="text-sm text-center mt-2">석회수(수산화칼슘)가 CO₂와 만나면 물에 녹지 않는 흰색 앙금(탄산칼슘)이 생겨요.</p>`;
                } else if (limewaterState === 'cloudy') {
                    html += `<p class="text-base mb-2 text-red-500 font-bold">계속해서 CO₂를 더 넣어보세요!</p>
                     <div class="text-center bg-green-50 p-3 rounded-lg">
                        (앙금) + <strong class="text-yellow-500">CO₂</strong> + H₂O ⟶ <strong class="text-blue-500">다시 맑아짐</strong>
                     </div>
                     <p class="text-sm text-center mt-2">앙금 상태에서 CO₂가 더 녹아들면 물에 잘 녹는 탄산수소칼슘이 되어 다시 맑아져요.</p>`;
                } else { // clear_again
                     html += `<div class="text-center bg-green-50 p-3 rounded-lg">
                        <strong class="text-blue-500">실험 성공!</strong> 다시 맑아지는 현상까지 관찰했습니다.
                     </div>`;
                }
                infoPanel.innerHTML = html;
            }
        }

        class Molecule {
             constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.radius = 15; // hitbox
                this.type = type;
            }

            draw(ctx, fontSize) {
                // 1. Draw molecule shape
                if (this.type === 'O2') {
                    this.drawDiatomic(ctx, '#ef4444');
                } else if (this.type === 'CO2') {
                    this.drawTriatomic(ctx, '#374151', '#fbbf24');
                } else if (this.type === 'H2O') {
                    this.drawTriatomic(ctx, '#3b82f6', '#e5e7eb', true);
                }

                // 2. Draw text below the shape
                ctx.font = `${fontSize}px Jua`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const textY = this.y + 18; // Offset for text

                if (this.type === 'O2') {
                    ctx.fillStyle = '#ef4444';
                    ctx.fillText('O₂', this.x, textY);
                } else if (this.type === 'CO2') {
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillText('CO₂', this.x, textY);
                } else if (this.type === 'H2O') {
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillText('H₂O', this.x, textY);
                }
            }
            
            drawDiatomic(ctx, color) {
                ctx.fillStyle = color;
                ctx.beginPath(); ctx.arc(this.x - 5, this.y, 5, 0, 2 * Math.PI); ctx.fill();
                ctx.beginPath(); ctx.arc(this.x + 5, this.y, 5, 0, 2 * Math.PI); ctx.fill();
            }
            drawTriatomic(ctx, centerColor, sideColor, bent = false) {
                ctx.fillStyle = centerColor;
                ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, 2 * Math.PI); ctx.fill();
                ctx.fillStyle = sideColor;
                if(bent) {
                    ctx.beginPath(); ctx.arc(this.x - 6, this.y + 6, 4, 0, 2 * Math.PI); ctx.fill();
                    ctx.beginPath(); ctx.arc(this.x + 6, this.y + 6, 4, 0, 2 * Math.PI); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.arc(this.x - 10, this.y, 5, 0, 2 * Math.PI); ctx.fill();
                    ctx.beginPath(); ctx.arc(this.x + 10, this.y, 5, 0, 2 * Math.PI); ctx.fill();
                }
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x < this.radius || this.x > canvasSize - this.radius) this.vx *= -1;
                if (this.y < this.radius || this.y > canvasSize - this.radius - 20) this.vy *= -1; // Keep text inside
            }
            isMouseOver(mx, my) {
                return Math.sqrt((mx - this.x)**2 + (my - this.y)**2) < this.radius;
            }
        }
        
        // --- 그리기 함수들 ---
        function drawCandle(ctx) {
            const candleWidth = canvasSize * 0.1, candleHeight = canvasSize * 0.3, baseX = canvasSize / 2, baseY = canvasSize - 50;
            ctx.fillStyle = '#a1a1aa'; ctx.fillRect(baseX - candleWidth * 0.7, baseY, candleWidth * 1.4, 20);
            ctx.fillStyle = '#fffbeb'; ctx.fillRect(baseX - candleWidth / 2, baseY - candleHeight, candleWidth, candleHeight);
            ctx.fillStyle = '#44403c'; ctx.fillRect(baseX - 2, baseY - candleHeight - 10, 4, 10);
        }
        
        function drawFlame(ctx, time) {
             const baseX = canvasSize / 2, baseY = canvasSize - 50 - canvasSize * 0.3 - 10, flicker = Math.sin(time / 100) * 5;
             ctx.fillStyle = 'rgba(250, 204, 21, 0.8)'; ctx.beginPath(); ctx.moveTo(baseX, baseY);
             ctx.quadraticCurveTo(baseX + 20 + flicker, baseY - 30, baseX, baseY - 60 - flicker);
             ctx.quadraticCurveTo(baseX - 20 - flicker, baseY - 30, baseX, baseY); ctx.fill();
             ctx.fillStyle = 'rgba(59, 130, 246, 0.7)'; ctx.beginPath(); ctx.moveTo(baseX, baseY);
             ctx.quadraticCurveTo(baseX + 10, baseY - 15, baseX, baseY - 25);
             ctx.quadraticCurveTo(baseX - 10, baseY - 15, baseX, baseY); ctx.fill();
        }

        function drawCombustionScene(time) {
            combustionCtx.clearRect(0, 0, canvasSize, canvasSize);
            drawCandle(combustionCtx);
            if (isBurning) drawFlame(combustionCtx, time);
            molecules.forEach(m => m.draw(combustionCtx, moleculeFontSize));
        }

        const cobaltPaperRect = { x: canvasSize/2 - 100, y: canvasSize/2 - 50, w: 200, h: 100 };
        function drawWaterDetectionScene() {
            waterCtx.clearRect(0, 0, canvasSize, canvasSize);
            const paperColor = cobaltPaperState === 'red' ? '#fda4af' : '#93c5fd';
            waterCtx.fillStyle = paperColor;
            waterCtx.fillRect(cobaltPaperRect.x, cobaltPaperRect.y, cobaltPaperRect.w, cobaltPaperRect.h);
            waterCtx.strokeStyle = "#6b7280";
            waterCtx.strokeRect(cobaltPaperRect.x, cobaltPaperRect.y, cobaltPaperRect.w, cobaltPaperRect.h);
            waterCtx.fillStyle = '#111827'; waterCtx.font = '24px Jua'; waterCtx.textAlign = 'center';
            waterCtx.fillText('푸른 염화코발트 종이', canvasSize/2, canvasSize/2 - 70);
            waterMolecules.forEach(m => m.draw(waterCtx, moleculeFontSize));
        }

        const beakerRect = {x: canvasSize/2 - 100, y: canvasSize/2 - 125, w: 200, h: 250};
        function drawCo2DetectionScene() {
            co2Ctx.clearRect(0, 0, canvasSize, canvasSize);
            co2Ctx.strokeStyle = '#9ca3af'; co2Ctx.lineWidth = 5;
            co2Ctx.beginPath(); co2Ctx.moveTo(beakerRect.x, beakerRect.y); co2Ctx.lineTo(beakerRect.x, beakerRect.y + beakerRect.h);
            co2Ctx.lineTo(beakerRect.x + beakerRect.w, beakerRect.y + beakerRect.h); co2Ctx.lineTo(beakerRect.x + beakerRect.w, beakerRect.y); co2Ctx.stroke();
            let limewaterColor = 'rgba(135, 206, 250, 0.4)';
            if (limewaterState === 'cloudy') limewaterColor = 'rgba(229, 231, 235, 0.95)';
            if (limewaterState === 'clear_again') limewaterColor = 'rgba(135, 206, 250, 0.6)';
            co2Ctx.fillStyle = limewaterColor;
            co2Ctx.fillRect(beakerRect.x+3, beakerRect.y + 125, beakerRect.w-6, beakerRect.h - 128);
            co2Ctx.fillStyle = '#111827'; co2Ctx.font = '24px Jua'; co2Ctx.textAlign = 'center';
            co2Ctx.fillText('석회수', canvasSize/2, beakerRect.y - 20);
            co2Molecules.forEach(m => m.draw(co2Ctx, moleculeFontSize));
        }

        // --- 초기화 및 메인 루프 ---
        function init() {
            molecules = [];
            for (let i = 0; i < OXYGEN_COUNT; i++) {
                molecules.push(new Molecule(
                    Math.random() * (canvasSize - 80) + 40, 
                    Math.random() * (canvasSize * 0.7), 'O2'
                ));
            }
            isBurning = false;
            simulationFinished = false;
            waterTabBtn.classList.add('disabled');
            co2TabBtn.classList.add('disabled');
            setActiveTab('combustion');
            startButton.disabled = false;
            startButton.innerText = '실험 시작';
            desc.innerHTML = "'실험 시작' 버튼을 눌러 양초를 태우고, 생성된 물질을 직접 검출해 보세요.";
            updateInfoPanel();
        }
        
        let lastConversionTime = 0; const conversionInterval = 500;
        function animate(time) {
            if (isBurning) {
                const oxygenCount = molecules.filter(m => m.type === 'O2').length;
                if (oxygenCount > OXYGEN_THRESHOLD && time - lastConversionTime > conversionInterval) {
                    lastConversionTime = time;
                    const oxygenIndex = molecules.findIndex(m => m.type === 'O2');
                    if (oxygenIndex > -1) {
                        const oxygenMolecule = molecules.splice(oxygenIndex, 1)[0];
                        molecules.push(new Molecule(oxygenMolecule.x, oxygenMolecule.y, 'CO2'));
                        molecules.push(new Molecule(oxygenMolecule.x, oxygenMolecule.y, 'H2O'));
                    }
                } else if (oxygenCount <= OXYGEN_THRESHOLD && isBurning) {
                    isBurning = false;
                    simulationFinished = true;
                    waterTabBtn.classList.remove('disabled');
                    co2TabBtn.classList.remove('disabled');
                    desc.innerHTML = `불이 꺼졌습니다. ②, ③번 탭에서 생성된 물질을 직접 검출해 보세요!`;
                    startButton.innerText = '다시 실험하기';
                    startButton.disabled = false;
                    // 검출 실험용 분자 생성
                    waterMolecules = []; co2Molecules = [];
                    for(let i=0; i<5; i++) {
                        waterMolecules.push(new Molecule(50 + i*80, 50, 'H2O'));
                        co2Molecules.push(new Molecule(50 + i*80, 50, 'CO2'));
                    }
                    cobaltPaperState = 'blue'; limewaterState = 'clear'; co2AddedCount = 0;
                }
            }
            if(!draggingMolecule) {
                if(activeTab === 'combustion') molecules.forEach(m => m.update());
                if(activeTab === 'water') waterMolecules.forEach(m => m.update());
                if(activeTab === 'co2') co2Molecules.forEach(m => m.update());
            }
            
            drawCombustionScene(time);
            drawWaterDetectionScene();
            drawCo2DetectionScene();
            requestAnimationFrame(animate);
        }

        // --- 마우스 이벤트 핸들러 (드래그 앤 드롭) ---
        function handleMouseDown(e, molArray, canvas) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            for (let i = molArray.length - 1; i >= 0; i--) {
                if (molArray[i].isMouseOver(mouseX, mouseY)) {
                    draggingMolecule = molArray[i];
                    break;
                }
            }
        }
        function handleMouseMove(e, canvas) {
            if (draggingMolecule) {
                const rect = canvas.getBoundingClientRect();
                draggingMolecule.x = e.clientX - rect.left;
                draggingMolecule.y = e.clientY - rect.top;
            }
        }
        function handleMouseUp(molArray) {
            if (!draggingMolecule) return;
            
            if (activeTab === 'water') {
                if (draggingMolecule.x > cobaltPaperRect.x && draggingMolecule.x < cobaltPaperRect.x + cobaltPaperRect.w &&
                    draggingMolecule.y > cobaltPaperRect.y && draggingMolecule.y < cobaltPaperRect.y + cobaltPaperRect.h) {
                    cobaltPaperState = 'red';
                    molArray.splice(molArray.indexOf(draggingMolecule), 1);
                }
            } else if (activeTab === 'co2') {
                if (draggingMolecule.x > beakerRect.x && draggingMolecule.x < beakerRect.x + beakerRect.w &&
                    draggingMolecule.y > beakerRect.y + 125 && draggingMolecule.y < beakerRect.y + beakerRect.h) {
                    co2AddedCount++;
                    if(co2AddedCount >= 2 && co2AddedCount < 5) limewaterState = 'cloudy';
                    if(co2AddedCount >= 5) limewaterState = 'clear_again';
                    molArray.splice(molArray.indexOf(draggingMolecule), 1);
                    updateInfoPanel();
                }
            }
            draggingMolecule = null;
        }

        [combustionCanvas, waterCanvas, co2Canvas].forEach(canvas => {
            canvas.addEventListener('mousedown', (e) => {
                if(activeTab === 'combustion') handleMouseDown(e, molecules, combustionCanvas);
                if(activeTab === 'water') handleMouseDown(e, waterMolecules, waterCanvas);
                if(activeTab === 'co2') handleMouseDown(e, co2Molecules, co2Canvas);
            });
            canvas.addEventListener('mousemove', (e) => {
                if(activeTab === 'combustion') handleMouseMove(e, combustionCanvas);
                if(activeTab === 'water') handleMouseMove(e, waterCanvas);
                if(activeTab === 'co2') handleMouseMove(e, co2Canvas);
            });
            canvas.addEventListener('mouseup', () => {
                if(activeTab === 'combustion') handleMouseUp(molecules);
                if(activeTab === 'water') handleMouseUp(waterMolecules);
                if(activeTab === 'co2') handleMouseUp(co2Molecules);
            });
             canvas.addEventListener('mouseleave', () => {
                if(activeTab === 'combustion') handleMouseUp(molecules);
                if(activeTab === 'water') handleMouseUp(waterMolecules);
                if(activeTab === 'co2') handleMouseUp(co2Molecules);
            });
        });

        startButton.addEventListener('click', () => {
            if (isBurning) return;
            if (simulationFinished) { // "다시 실험하기"
                init();
                return;
            }
            isBurning = true;
            lastConversionTime = performance.now();
            startButton.disabled = true;
            startButton.innerText = '실험 진행 중...';
            desc.innerHTML = `양초가 타고 있습니다. 산소가 사라지고 새로운 물질이 생깁니다.`;
        });
        
        init();
        animate(0);
    </script>
</body>
</html>

