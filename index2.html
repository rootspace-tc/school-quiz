<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ì™„ì„±í˜• í€´ì¦ˆ í”Œë«í¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; background-color: #f0f4f8; font-size: 18px; }
        .container { max-width: 1300px; margin: 2rem auto; padding: 30px; background: #fff; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { font-family: 'Jua', sans-serif; }
        .dashboard-table { width: 100%; border-collapse: collapse; }
        .dashboard-table th, .dashboard-table td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; }
        .dashboard-table th { background-color: #f1f5f9; }
        .dashboard-table td { min-width: 80px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
        .dashboard-table th:first-child, .dashboard-table td:first-child { position: sticky; left: 0; background-color: #f8fafc; z-index: 10; min-width: 120px; }
        .correct { background-color: #dcfce7 !important; }
        .incorrect { background-color: #fee2e2 !important; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .order-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0 4px; color: #64748b; }
        .order-btn:hover { color: #1e293b; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="font-bold text-center mb-10 text-3xl text-gray-800">ğŸš€ ì™„ì„±í˜• í€´ì¦ˆ í”Œë«í¼</h1>
    
    <div id="mode-selection" class="flex justify-center space-x-6 mb-8">
        <button id="teacher-mode-btn" class="mode-button bg-red-500 text-white p-4 rounded-lg shadow-md text-xl">ğŸ‘©â€ğŸ« êµì‚¬ ëª¨ë“œ</button>
        <button id="student-mode-btn" class="mode-button bg-blue-500 text-white p-4 rounded-lg shadow-md text-xl">ğŸ§‘â€ğŸ“ í•™ìƒ ëª¨ë“œ</button>
    </div>

    <hr class="mb-8 border-gray-300">

    <div id="teacher-panel" class="hidden">
        <h2 class="font-bold mb-5 text-2xl text-red-600">êµì‚¬ ì œì–´íŒ</h2>
        
        <div class="p-6 border border-red-200 rounded-lg bg-red-50 mb-8">
            <div class="grid grid-cols-2 gap-6 mb-4 pb-4 border-b">
                <div>
                    <label for="student-password-input" class="block font-semibold mb-2 text-gray-700">ğŸ”’ í•™ìƒ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</label>
                    <input type="text" id="student-password-input" class="w-full border rounded p-2" placeholder="ë¯¸ì…ë ¥ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ">
                </div>
                <div>
                    <label for="quiz-slot-select" class="block font-semibold mb-2 text-gray-700">ğŸ’¾ ì‹œí—˜ì§€ ì €ì¥ ìŠ¬ë¡¯</label>
                    <div class="flex space-x-2">
                        <select id="quiz-slot-select" class="w-full border rounded p-2 bg-white">
                            <option value="slot1">ìŠ¬ë¡¯ 1</option><option value="slot2">ìŠ¬ë¡¯ 2</option><option value="slot3">ìŠ¬ë¡¯ 3</option><option value="slot4">ìŠ¬ë¡¯ 4</option><option value="slot5">ìŠ¬ë¡¯ 5</option>
                        </select>
                        <button id="save-slot-btn" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded">ì €ì¥</button>
                        <button id="load-slot-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div id="question-creation-form">
                    <h3 class="font-bold text-xl mb-3">ğŸ“ ë¬¸ì œ ë§Œë“¤ê¸°</h3>
                    <div class="space-y-4">
                        <textarea id="question-text" rows="3" class="w-full border rounded p-3 text-lg" placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        <div id="image-upload-area" class="border-2 border-dashed border-gray-400 p-4 rounded-lg bg-white">
                            <input type="file" id="image-file-input" accept="image/*" class="mb-2 block w-full text-sm">
                            <p class="text-gray-500 text-sm">ë˜ëŠ”, ì´ë¯¸ì§€ íŒŒì¼ì„ ì´ ì˜ì—­ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.</p>
                            <div id="image-preview" class="mt-2 text-center hidden"><img src="" id="current-image-preview" class="max-w-full h-auto mx-auto border rounded max-h-40"><button id="remove-image-btn" class="mt-2 bg-gray-400 text-white p-1 rounded text-sm">âŒ ì´ë¯¸ì§€ ì œê±°</button></div>
                        </div>
                        <select id="question-type" class="w-full border rounded p-3 bg-white text-lg"><option value="MCQ">ê°ê´€ì‹ (ë‹¨ì¼ ì„ íƒ)</option><option value="MultipleChoice">ì¤‘ë³µ ì„ íƒ (ì²´í¬ë°•ìŠ¤)</option><option value="OX">OX í€´ì¦ˆ</option><option value="ShortAnswer">ì£¼ê´€ì‹ (ë‹¨ë‹µí˜•)</option></select>
                        <div id="mcq-options-container"><input type="text" id="mcq-options" class="w-full border rounded p-3 text-lg" placeholder="ë³´ê¸° ëª©ë¡ (ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„)"></div>
                        <input type="text" id="correct-answer-input" class="w-full border rounded p-3 text-lg" placeholder="ì •ë‹µ ì…ë ¥ (ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„)">
                        <button id="add-question-btn" class="w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg font-semibold text-lg">â• ì„¸íŠ¸ì— ë¬¸ì œ ì¶”ê°€</button>
                    </div>
                </div>
                <div class="p-4 border rounded-lg bg-white">
                    <h3 class="font-bold text-xl mb-3">ğŸ“‹ ì¶œì œí•  ë¬¸ì œ ëª©ë¡ (<span id="question-count">0</span>/50)</h3>
                    <div id="question-set-list" class="space-y-2 max-h-[420px] overflow-y-auto"><p class="text-gray-500">ì•„ì§ ì¶”ê°€ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>
                </div>
            </div>

            <div class="mt-6 border-t pt-6 space-y-3">
                 <button id="publish-quiz-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-semibold text-xl">ğŸ“¢ í•™ìƒë“¤ì—ê²Œ ì‹œí—˜ì§€ ë°°í¬ (ì‹œí—˜ ì‹œì‘)</button>
                 <div class="flex space-x-3">
                    <button id="close-quiz-btn" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-lg font-semibold text-xl">â›” ì‹œí—˜ ì¢…ë£Œ</button>
                    <button id="analyze-results-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-lg font-semibold text-xl">ğŸ“ˆ ê²°ê³¼ ë¶„ì„ ë³´ê¸°</button>
                    <button id="reset-quiz-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-semibold text-xl">ğŸ’£ ì „ì²´ ì‹œí—˜ ì´ˆê¸°í™”</button>
                 </div>
            </div>
        </div>

        <div class="p-6 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-bold mb-4">ğŸ“Š ì‹¤ì‹œê°„ ë‹µì•ˆ ì œì¶œ í˜„í™©íŒ (ì˜¤ë‹µ í´ë¦­ ì‹œ ì •ë‹µ ì²˜ë¦¬)</h3>
             <div id="submission-status-teacher" class="text-center p-3 rounded mb-4 text-xl bg-red-200 text-red-800 hidden">â›” ì‹œí—˜ì´ ì¢…ë£Œë˜ì–´ ë” ì´ìƒ ë‹µì•ˆì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            <div class="overflow-x-auto"><table id="dashboard-table" class="dashboard-table"><thead><tr id="dashboard-header"><th>í•™ìƒ ì´ë¦„</th></tr></thead><tbody id="dashboard-body"><tr><td class="text-gray-500 p-4" colspan="2">ì‹œí—˜ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ í˜„í™©ì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr></tbody></table></div>
        </div>
    </div>

    <div id="student-panel" class="hidden">
        <h2 class="font-bold mb-5 text-2xl text-blue-600">í•™ìƒ ì‹œí—˜ ì‘ì‹œ</h2>
        <div id="student-login-area"><div class="p-8 border border-blue-200 rounded-lg bg-blue-50 mb-8 max-w-lg mx-auto"><label for="student-name" class="block font-semibold mb-2 text-lg">ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ ì…ë ¥:</label><input type="text" id="student-name" class="w-full border rounded p-3 mb-4 text-xl" placeholder="ì˜ˆ: 1ë²ˆ ê¹€ì² ìˆ˜"><label for="student-access-password" class="block font-semibold mb-2 text-lg">ğŸ”’ ì ‘ì† ë¹„ë°€ë²ˆí˜¸:</label><input type="password" id="student-access-password" class="w-full border rounded p-3 mb-4 text-xl" placeholder="ì„ ìƒë‹˜ì´ ì•Œë ¤ì¤€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"><button id="student-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-semibold w-full text-xl">âœ… ì‹œí—˜ ì°¸ì—¬</button></div></div>
        <div id="student-quiz-area" class="hidden"><div class="p-8 border border-gray-300 rounded-lg bg-white mb-6"><h3 id="student-question-title" class="text-2xl font-bold mb-4 text-gray-700"></h3><div id="student-question-image-container" class="mb-6 text-center hidden"><img src="" id="student-question-image" class="max-w-full h-auto mx-auto border rounded max-h-80"></div><p id="student-question-text" class="text-3xl font-bold text-gray-800 mb-6 min-h-[100px]"></p><div id="student-answer-options" class="space-y-3"></div></div><div class="flex justify-between items-center"><button id="prev-question-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 p-3 rounded-lg font-semibold w-1/4 text-xl">â† ì´ì „ ë¬¸ì œ</button><span id="question-progress" class="text-lg font-semibold text-gray-600"></span><button id="next-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg font-semibold w-1/4 text-xl">ë‹¤ìŒ ë¬¸ì œ â†’</button></div><div id="submission-status-student" class="text-center p-3 rounded mt-4 text-xl bg-red-200 text-red-800 hidden">â›” ì‹œí—˜ì´ ì¢…ë£Œë˜ì–´ ë” ì´ìƒ ë‹µì•ˆì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div></div>
        <div id="student-waiting-area" class="hidden text-center p-12 border border-gray-300 rounded-lg bg-gray-50"><h3 class="text-3xl font-bold mb-4 text-gray-700">â³ ì‹œí—˜ ëŒ€ê¸°ì¤‘...</h3><p class="text-xl text-gray-600">ì„ ìƒë‹˜ì´ ì‹œí—˜ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p></div>
        <div id="student-finished-area" class="hidden text-center p-12 border border-green-300 rounded-lg bg-green-50"><h3 class="text-3xl font-bold mb-4 text-green-700">ğŸ‰ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</h3><p class="text-xl text-gray-600">ë‹µì•ˆ ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì„ ìƒë‹˜ì˜ ì•ˆë‚´ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p></div>
    </div>

    <div id="results-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">ğŸ“ˆ ì‹œí—˜ ê²°ê³¼ ë¶„ì„</h2><button id="close-results-modal-btn" class="text-2xl font-bold">&times;</button></div><div class="flex space-x-2 border-b mb-4"><button class="tab-btn p-2 border-b-4 border-blue-500" data-tab="overall">ì „ì²´ ê²°ê³¼</button><button class="tab-btn p-2 border-b-4 border-transparent" data-tab="by-student">í•™ìƒë³„ ê²°ê³¼</button><button class="tab-btn p-2 border-b-4 border-transparent" data-tab="by-question">ë¬¸ì œë³„ ê²°ê³¼</button></div><div id="results-content"></div></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyAN1iAC82xKL_haJUs9291YBKNv7g7WSvU", authDomain: "foranswering-afec8.firebaseapp.com", databaseURL: "https://foranswering-afec8-default-rtdb.firebaseio.com", projectId: "foranswering-afec8", storageBucket: "foranswering-afec8.firebasestorage.app", messagingSenderId: "291098085525", appId: "1:291098085525:web:883a852c6320859294339c" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const QUIZ_SET_PATH = 'multiQuiz/quizSet';
    const RESPONSES_PATH = 'multiQuiz/responses';
    const STATUS_PATH = 'multiQuiz/status';
    const CONFIG_PATH = 'multiQuiz/config';
    const SLOTS_PATH = 'multiQuiz/slots';
    const TEACHER_PASSWORD = "2948";

    const teacherPanel = document.getElementById('teacher-panel');
    const studentPanel = document.getElementById('student-panel');
    const modeSelection = document.getElementById('mode-selection');

    // ====================================================
    // êµì‚¬ ë¡œì§
    // ====================================================
    let localQuestionSet = [];
    let currentImageBase64 = null;
    let allResponses = {};

    if (document.getElementById('teacher-mode-btn')) {
        const studentPasswordInput = document.getElementById('student-password-input');
        const slotSelect = document.getElementById('quiz-slot-select');
        const questionText = document.getElementById('question-text');
        const questionType = document.getElementById('question-type');
        const mcqOptions = document.getElementById('mcq-options');
        const mcqOptionsContainer = document.getElementById('mcq-options-container');
        const correctAnswer = document.getElementById('correct-answer-input');
        const imageFileInput = document.getElementById('image-file-input'), imageUploadArea = document.getElementById('image-upload-area'), imagePreview = document.getElementById('image-preview'), currentImagePreview = document.getElementById('current-image-preview'), removeImageBtn = document.getElementById('remove-image-btn');
        
        studentPasswordInput.addEventListener('change', () => { update(ref(db, CONFIG_PATH), { studentPassword: studentPasswordInput.value.trim() }); });
        document.getElementById('save-slot-btn').addEventListener('click', () => { if (localQuestionSet.length === 0) return alert("ì €ì¥í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."); const selectedSlot = slotSelect.value; set(ref(db, `${SLOTS_PATH}/${selectedSlot}`), localQuestionSet); alert(`${selectedSlot}ì— í˜„ì¬ ë¬¸ì œ ì„¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`); });
        document.getElementById('load-slot-btn').addEventListener('click', () => { const selectedSlot = slotSelect.value; get(ref(db, `${SLOTS_PATH}/${selectedSlot}`)).then(snapshot => { if (snapshot.exists()) { localQuestionSet = snapshot.val(); renderQuestionSetList(); alert(`${selectedSlot}ì˜ ë¬¸ì œ ì„¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`); } else { alert(`${selectedSlot}ì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`); } }); });
        function setImage(base64) { currentImageBase64 = base64; currentImagePreview.src = base64; imagePreview.classList.remove('hidden'); }
        imageFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => setImage(event.target.result); reader.readAsDataURL(file); } });
        imageUploadArea.addEventListener('paste', (e) => { e.preventDefault(); const items = e.clipboardData.items; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf('image') !== -1) { const blob = items[i].getAsFile(); const reader = new FileReader(); reader.onload = (event) => setImage(event.target.result); reader.readAsDataURL(blob); break; } } });
        removeImageBtn.addEventListener('click', () => { currentImageBase64 = null; imageFileInput.value = ''; imagePreview.classList.add('hidden'); });
        questionType.addEventListener('change', () => { mcqOptionsContainer.style.display = (questionType.value === 'MCQ' || questionType.value === 'MultipleChoice') ? 'block' : 'none'; });
        document.getElementById('add-question-btn').addEventListener('click', () => { if (localQuestionSet.length >= 50) return alert("ë¬¸ì œëŠ” ìµœëŒ€ 50ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); const newQuestion = { text: questionText.value.trim(), image: currentImageBase64, type: questionType.value, options: (questionType.value === 'MCQ' || questionType.value === 'MultipleChoice') ? mcqOptions.value.split(',').map(o => o.trim()) : [], correctAnswer: correctAnswer.value.trim() || null }; if (!newQuestion.text && !newQuestion.image) return alert("ì§ˆë¬¸ ë‚´ìš©ì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); localQuestionSet.push(newQuestion); renderQuestionSetList(); questionText.value = ''; mcqOptions.value = ''; correctAnswer.value = ''; removeImageBtn.click(); });
        
        function renderQuestionSetList() {
            const listEl = document.getElementById('question-set-list'); listEl.innerHTML = ''; document.getElementById('question-count').textContent = localQuestionSet.length; if (localQuestionSet.length === 0) { listEl.innerHTML = '<p class="text-gray-500">ì•„ì§ ì¶”ê°€ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            localQuestionSet.forEach((q, index) => {
                const item = document.createElement('div'); item.className = 'flex justify-between items-center p-2 border rounded bg-gray-50'; const displayText = q.text ? `${q.text.substring(0, 30)}...` : '[ì´ë¯¸ì§€ ë¬¸ì œ]'; const imageIcon = q.image ? 'ğŸ–¼ï¸' : '';
                item.innerHTML = `<span class="font-semibold">${index + 1}. ${imageIcon} ${displayText}</span><div class="flex items-center"><button class="order-btn up-btn" data-index="${index}" style="visibility: ${index === 0 ? 'hidden' : 'visible'}">â–²</button><button class="order-btn down-btn" data-index="${index}" style="visibility: ${index === localQuestionSet.length - 1 ? 'hidden' : 'visible'}">â–¼</button><button class="edit-btn text-sm bg-yellow-400 text-white px-2 py-1 rounded ml-2" data-index="${index}">ìˆ˜ì •</button><button class="delete-btn text-sm bg-red-500 text-white px-2 py-1 rounded" data-index="${index}">ì‚­ì œ</button></div>`; listEl.appendChild(item);
            });
            listEl.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { const index = parseInt(e.target.dataset.index); localQuestionSet.splice(index, 1); renderQuestionSetList(); }));
            listEl.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => { const index = parseInt(e.target.dataset.index); const q = localQuestionSet[index]; questionText.value = q.text; questionType.value = q.type; mcqOptions.value = q.options.join(','); correctAnswer.value = q.correctAnswer || ''; if (q.image) { setImage(q.image); } else { removeImageBtn.click(); } localQuestionSet.splice(index, 1); renderQuestionSetList(); }));
            listEl.querySelectorAll('.up-btn').forEach(btn => btn.addEventListener('click', e => { const i = parseInt(e.currentTarget.dataset.index); if (i > 0) { [localQuestionSet[i-1], localQuestionSet[i]] = [localQuestionSet[i], localQuestionSet[i-1]]; renderQuestionSetList(); } }));
            listEl.querySelectorAll('.down-btn').forEach(btn => btn.addEventListener('click', e => { const i = parseInt(e.currentTarget.dataset.index); if (i < localQuestionSet.length - 1) { [localQuestionSet[i+1], localQuestionSet[i]] = [localQuestionSet[i], localQuestionSet[i+1]]; renderQuestionSetList(); } }));
        }

        document.getElementById('publish-quiz-btn').addEventListener('click', () => { if (localQuestionSet.length === 0) return alert("í•˜ë‚˜ ì´ìƒì˜ ë¬¸ì œë¥¼ ì¶”ê°€í•œ í›„ ì‹œí—˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); if (!confirm(`${localQuestionSet.length}ê°œì˜ ë¬¸ì œë¡œ ì‹œí—˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; set(ref(db, QUIZ_SET_PATH), localQuestionSet); set(ref(db, STATUS_PATH), { isPublished: true, isClosed: false }); set(ref(db, RESPONSES_PATH), {}); alert("ì‹œí—˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."); });
        document.getElementById('close-quiz-btn').addEventListener('click', () => { if (!confirm("ì‹œí—˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; update(ref(db, STATUS_PATH), { isClosed: true }); });
        document.getElementById('reset-quiz-btn').addEventListener('click', () => { if (!confirm("ê²½ê³ : í˜„ì¬ ì‹œí—˜ì˜ ëª¨ë“  ê²ƒì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; remove(ref(db, QUIZ_SET_PATH)); remove(ref(db, RESPONSES_PATH)); remove(ref(db, STATUS_PATH)); localQuestionSet = []; allResponses = {}; renderQuestionSetList(); updateDashboardHeader(); updateDashboardBody(); alert("ì‹œí—˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); });

        function setupTeacherListeners() {
            onValue(ref(db, CONFIG_PATH), (snapshot) => { studentPasswordInput.value = snapshot.val()?.studentPassword || ''; });
            onValue(ref(db, QUIZ_SET_PATH), (snapshot) => { localQuestionSet = snapshot.val() || []; renderQuestionSetList(); updateDashboardBody(); });
            onValue(ref(db, RESPONSES_PATH), (snapshot) => { allResponses = snapshot.val() || {}; updateDashboardBody(); });
            onValue(ref(db, STATUS_PATH), (snapshot) => { document.getElementById('submission-status-teacher').style.display = (snapshot.val()?.isClosed) ? 'block' : 'none'; });
        }
        
        // [ìˆ˜ì •] í˜„í™©íŒ ì—…ë°ì´íŠ¸ ë¡œì§ ê°•í™”
        function updateDashboardHeader() { const header = document.getElementById('dashboard-header'); header.innerHTML = '<th>í•™ìƒ ì´ë¦„</th>'; localQuestionSet.forEach((q, index) => { header.innerHTML += `<th>${index + 1}ë²ˆ</th>`; }); }
        
        function updateDashboardBody() {
            updateDashboardHeader(); // í—¤ë”ë¥¼ í•­ìƒ ìµœì‹  ìƒíƒœë¡œ ìœ ì§€
            const body = document.getElementById('dashboard-body'); body.innerHTML = '';
            if (localQuestionSet.length === 0) { body.innerHTML = '<tr><td class="text-gray-500 p-4" colspan="99">ì‹œí—˜ ì‹œì‘ ëŒ€ê¸°ì¤‘...</td></tr>'; return; }
            const studentIds = Object.keys(allResponses);
            if (studentIds.length === 0) { body.innerHTML = `<tr><td class="text-gray-500 p-4" colspan="${localQuestionSet.length + 1}">ë‹µë³€ ì œì¶œ í•™ìƒ ì—†ìŒ</td></tr>`; return; }
            studentIds.forEach(studentId => {
                const studentData = allResponses[studentId]; const studentAnswers = studentData.answers || {}; const studentName = studentData.name || 'ìµëª…';
                let rowHtml = `<td>${studentName}</td>`;
                for (let i = 0; i < localQuestionSet.length; i++) {
                    const question = localQuestionSet[i];
                    const answer = studentAnswers[i] !== undefined ? studentAnswers[i] : '';
                    const isCorrect = isAnswerCorrect(answer, question.correctAnswer);
                    const isOverridden = studentData.manualOverrides && studentData.manualOverrides[i];
                    let cellClass = '';
                    if (answer !== '') { cellClass = (isCorrect || isOverridden) ? 'correct' : 'incorrect'; }
                    rowHtml += `<td class="${cellClass}" data-student-id="${studentId}" data-q-index="${i}">${answer}</td>`;
                }
                body.innerHTML += `<tr>${rowHtml}</tr>`;
            });

            body.querySelectorAll('td.incorrect').forEach(cell => {
                cell.addEventListener('click', () => {
                    const studentId = cell.dataset.studentId; const qIndex = cell.dataset.qIndex;
                    if (confirm(`'${allResponses[studentId].name}' í•™ìƒì˜ ${parseInt(qIndex)+1}ë²ˆ ë¬¸í•­ ë‹µì•ˆì„ ì •ë‹µìœ¼ë¡œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        set(ref(db, `${RESPONSES_PATH}/${studentId}/manualOverrides/${qIndex}`), true);
                    }
                });
            });
        }
        
        const isAnswerCorrect = (answer, correctAnswer) => { if (answer === null || answer === undefined || !correctAnswer) return false; const formattedAnswer = String(answer).split(',').map(s => s.trim()).sort().join(','); const formattedCorrectAnswer = String(correctAnswer).split(',').map(s => s.trim()).sort().join(','); return formattedAnswer.toLowerCase() === formattedCorrectAnswer.toLowerCase(); };
        document.getElementById('analyze-results-btn').addEventListener('click', () => { showResultsModal('overall'); });
        document.getElementById('close-results-modal-btn').addEventListener('click', () => document.getElementById('results-modal').classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', e => showResultsModal(e.target.dataset.tab)));
        function showResultsModal(tab) {
            document.getElementById('results-modal').classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.replace('border-blue-500', 'border-transparent'); });
            document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.replace('border-transparent', 'border-blue-500');
            const content = document.getElementById('results-content');
            const results = calculateResults();
            if (Object.keys(results).length === 0) { content.innerHTML = '<p>ì•„ì§ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œí—˜ì´ ì‹œì‘ë˜ê³  í•™ìƒë“¤ì´ ë‹µë³€ì„ ì œì¶œí–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>'; return; }
            if (tab === 'overall') { content.innerHTML = `<h3 class="text-xl font-bold mb-4">ì „ì²´ ê²°ê³¼ ìš”ì•½</h3><p><strong>ì´ ì°¸ì—¬ ì¸ì›:</strong> ${results.totalStudents}ëª…</p><p><strong>ì „ì²´ í‰ê·  ì ìˆ˜:</strong> ${results.averageScore.toFixed(1)}ì  (ë§Œì : ${localQuestionSet.length}ì )</p><h4 class="text-lg font-bold mt-4">ì ìˆ˜ ë¶„í¬</h4><div class="border p-4 mt-2">${Object.entries(results.scoreDistribution).map(([range, count]) => `<p>${range}ì : ${count}ëª…</p>`).join('')}</div>`; }
            else if (tab === 'by-student') { content.innerHTML = `<h3 class="text-xl font-bold mb-4">í•™ìƒë³„ ê²°ê³¼</h3><table class="w-full text-left"><thead><tr><th class="p-2 border">ì´ë¦„</th><th class="p-2 border">ì ìˆ˜</th><th class="p-2 border">ì •ë‹µë¥ </th></tr></thead><tbody>${results.studentScores.map(s => `<tr><td class="p-2 border">${s.name}</td><td class="p-2 border">${s.score}/${localQuestionSet.length}</td><td class="p-2 border">${s.percentage.toFixed(1)}%</td></tr>`).join('')}</tbody></table>`; }
            else if (tab === 'by-question') { content.innerHTML = `<h3 class="text-xl font-bold mb-4">ë¬¸ì œë³„ ê²°ê³¼</h3><table class="w-full text-left"><thead><tr><th class="p-2 border">ë¬¸ì œ ë²ˆí˜¸</th><th class="p-2 border">ì •ë‹µë¥ </th><th class="p-2 border">ì •ë‹µì ìˆ˜</th></tr></thead><tbody>${results.questionStats.map((q, i) => `<tr><td class="p-2 border">${i+1}ë²ˆ</td><td class="p-2 border">${q.percentage.toFixed(1)}%</td><td class="p-2 border">${q.correctCount}/${results.totalStudents}</td></tr>`).join('')}</tbody></table>`; }
        }
        function calculateResults() {
            if (localQuestionSet.length === 0 || Object.keys(allResponses).length === 0) return {};
            const studentScores = []; const questionStats = Array(localQuestionSet.length).fill(0).map(() => ({ correctCount: 0 })); const studentIds = Object.keys(allResponses);
            studentIds.forEach(studentId => { const data = allResponses[studentId]; let score = 0; for (let i = 0; i < localQuestionSet.length; i++) { const isCorrectAuto = isAnswerCorrect(data.answers?.[i], localQuestionSet[i].correctAnswer); const isCorrectManual = data.manualOverrides?.[i]; if (isCorrectAuto || isCorrectManual) { score++; questionStats[i].correctCount++; } } studentScores.push({ name: data.name, score }); });
            studentScores.sort((a,b) => b.score - a.score); const totalScore = studentScores.reduce((sum, s) => sum + s.score, 0); const scoreDistribution = {"90-100": 0, "80-89": 0, "70-79": 0, "60-69": 0, "0-59": 0 };
            studentScores.forEach(s => { const pct = (s.score / localQuestionSet.length) * 100; s.percentage = pct; if(pct>=90) scoreDistribution["90-100"]++; else if(pct>=80) scoreDistribution["80-89"]++; else if(pct>=70) scoreDistribution["70-79"]++; else if(pct>=60) scoreDistribution["60-69"]++; else scoreDistribution["0-59"]++; });
            return { totalStudents: studentIds.length, averageScore: studentIds.length > 0 ? totalScore / studentIds.length : 0, studentScores, questionStats: questionStats.map(q => ({...q, percentage: studentIds.length > 0 ? (q.correctCount/studentIds.length)*100 : 0})), scoreDistribution };
        }
    }

    // ====================================================
    // í•™ìƒ ë¡œì§ (ì´ì „ê³¼ ë™ì¼, ì˜¤ë¥˜ ì—†ìŒ)
    // ====================================================
    let studentQuizSet = [], currentQuestionIndex = 0, studentId = null, studentName = '';
    if (document.getElementById('student-mode-btn')) {
        document.getElementById('student-login-btn').addEventListener('click', async () => { studentName = document.getElementById('student-name').value.trim(); const password = document.getElementById('student-access-password').value.trim(); if (!studentName) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); const configSnap = await get(ref(db, CONFIG_PATH)); const requiredPassword = configSnap.val()?.studentPassword; if (requiredPassword && password !== requiredPassword) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); studentId = studentName.replace(/[.#$/[\]]/g, "_"); localStorage.setItem('multi_quiz_student_name', studentName); document.getElementById('student-login-area').classList.add('hidden'); document.getElementById('student-waiting-area').classList.remove('hidden'); setupStudentListeners(); setupAntiCheating(); });
        function setupStudentListeners() { onValue(ref(db, STATUS_PATH), (snapshot) => { const status = snapshot.val(); const quizArea = document.getElementById('student-quiz-area'); const waitingArea = document.getElementById('student-waiting-area'); const finishedArea = document.getElementById('student-finished-area'); const statusMsg = document.getElementById('submission-status-student'); if (status?.isPublished) { waitingArea.classList.add('hidden'); finishedArea.classList.add('hidden'); quizArea.classList.remove('hidden'); if (!studentQuizSet || studentQuizSet.length === 0) { get(ref(db, QUIZ_SET_PATH)).then(quizSnapshot => { studentQuizSet = quizSnapshot.val() || []; renderCurrentQuestion(); }); } } else { waitingArea.classList.remove('hidden'); quizArea.classList.add('hidden'); finishedArea.classList.add('hidden'); } const isClosed = status?.isClosed; statusMsg.style.display = isClosed ? 'block' : 'none'; document.querySelectorAll('#student-answer-options input, #student-answer-options textarea').forEach(el => el.disabled = isClosed); }); }
        function renderCurrentQuestion() { const question = studentQuizSet[currentQuestionIndex]; if (!question) return; document.getElementById('student-question-title').textContent = `ë¬¸ì œ ${currentQuestionIndex + 1}`; document.getElementById('student-question-text').textContent = question.text; document.getElementById('question-progress').textContent = `${currentQuestionIndex + 1} / ${studentQuizSet.length}`; const imageContainer = document.getElementById('student-question-image-container'); if (question.image) { document.getElementById('student-question-image').src = question.image; imageContainer.classList.remove('hidden'); } else { imageContainer.classList.add('hidden'); } const optionsContainer = document.getElementById('student-answer-options'); optionsContainer.innerHTML = ''; get(ref(db, `${RESPONSES_PATH}/${studentId}/answers/${currentQuestionIndex}`)).then(snapshot => { const savedAnswer = snapshot.val(); if (question.type === 'OX') { ['O', 'X'].forEach(opt => { const isChecked = savedAnswer === opt; optionsContainer.innerHTML += createRadioInput(opt, opt, isChecked); }); } else if (question.type === 'MCQ') { question.options.forEach(opt => { const isChecked = savedAnswer === opt; optionsContainer.innerHTML += createRadioInput(opt, opt, isChecked); }); } else if (question.type === 'MultipleChoice') { const savedAnswers = savedAnswer ? savedAnswer.split(', ') : []; question.options.forEach(opt => { const isChecked = savedAnswers.includes(opt); optionsContainer.innerHTML += createCheckboxInput(opt, opt, isChecked); }); } else if (question.type === 'ShortAnswer') { optionsContainer.innerHTML = `<textarea id="short-answer-input" rows="4" class="w-full border rounded p-4 text-xl">${savedAnswer || ''}</textarea>`; optionsContainer.querySelector('textarea').addEventListener('blur', saveAnswer); } optionsContainer.querySelectorAll('input').forEach(input => input.addEventListener('change', saveAnswer)); get(ref(db, STATUS_PATH)).then(statusSnap => { if(statusSnap.val()?.isClosed){ document.querySelectorAll('#student-answer-options input, #student-answer-options textarea').forEach(el => el.disabled = true); }}); }); document.getElementById('prev-question-btn').disabled = currentQuestionIndex === 0; const nextBtn = document.getElementById('next-question-btn'); if (currentQuestionIndex === studentQuizSet.length - 1) { nextBtn.textContent = 'ì™„ë£Œ'; nextBtn.classList.replace('bg-blue-500', 'bg-green-500'); nextBtn.classList.replace('hover:bg-blue-600', 'hover:bg-green-600');} else { nextBtn.textContent = 'ë‹¤ìŒ ë¬¸ì œ â†’'; nextBtn.classList.replace('bg-green-500', 'bg-blue-500'); nextBtn.classList.replace('hover:bg-green-600', 'hover:bg-blue-600'); } }
        function saveAnswer() { const question = studentQuizSet[currentQuestionIndex]; let answer; if (question.type === 'MultipleChoice') { const checked = Array.from(document.querySelectorAll('input[name="student-answer"]:checked')).map(el => el.value); answer = checked.join(', '); } else if (question.type === 'ShortAnswer') { answer = document.getElementById('short-answer-input').value; } else { const selected = document.querySelector('input[name="student-answer"]:checked'); answer = selected ? selected.value : null; } const updates = {}; updates[`${RESPONSES_PATH}/${studentId}/name`] = studentName; updates[`${RESPONSES_PATH}/${studentId}/answers/${currentQuestionIndex}`] = answer; update(ref(db), updates); }
        document.getElementById('next-question-btn').addEventListener('click', () => { if (currentQuestionIndex < studentQuizSet.length - 1) { currentQuestionIndex++; renderCurrentQuestion(); } else { saveAnswer(); if (confirm("ì‹œí—˜ì§€ë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) { document.getElementById('student-quiz-area').classList.add('hidden'); document.getElementById('student-finished-area').classList.remove('hidden'); } } });
        document.getElementById('prev-question-btn').addEventListener('click', () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderCurrentQuestion(); } });
        const createRadioInput = (id, val, checked) => `<div class="flex items-center p-3 bg-gray-100 rounded-lg hover:bg-gray-200"><input type="radio" id="${val.replace(/[^a-zA-Z0-9]/g, "")+id}" name="student-answer" value="${val}" class="w-5 h-5" ${checked ? 'checked' : ''}><label for="${val.replace(/[^a-zA-Z0-9]/g, "")+id}" class="ml-3 text-xl text-gray-800 flex-1">${val}</label></div>`;
        const createCheckboxInput = (id, val, checked) => `<div class="flex items-center p-3 bg-gray-100 rounded-lg hover:bg-gray-200"><input type="checkbox" id="${val.replace(/[^a-zA-Z0-9]/g, "")+id}" name="student-answer" value="${val}" class="w-5 h-5" ${checked ? 'checked' : ''}><label for="${val.replace(/[^a-zA-Z0-9]/g, "")+id}" class="ml-3 text-xl text-gray-800 flex-1">${val}</label></div>`;
        function setupAntiCheating() { const preventAction = (e) => { e.preventDefault(); alert("ì‹œí—˜ ì¤‘ì—ëŠ” í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }; document.addEventListener('contextmenu', preventAction); document.addEventListener('copy', preventAction); document.addEventListener('cut', preventAction); document.addEventListener('paste', preventAction); document.addEventListener('visibilitychange', () => { if (document.hidden) { alert("ê²½ê³ : ì‹œí—˜ í™”ë©´ì„ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì´íƒˆí•  ê²½ìš° ë¶ˆì´ìµì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."); } }); }
    }

    // ê³µí†µ ë¡œì§
    document.getElementById('teacher-mode-btn').addEventListener('click', () => { const password = prompt("êµì‚¬ ëª¨ë“œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); if (password === TEACHER_PASSWORD) { modeSelection.classList.add('hidden'); teacherPanel.classList.remove('hidden'); setupTeacherListeners(); } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); } });
    document.getElementById('student-mode-btn').addEventListener('click', () => { modeSelection.classList.add('hidden'); studentPanel.classList.remove('hidden'); const savedName = localStorage.getItem('multi_quiz_student_name'); if(savedName) { document.getElementById('student-name').value = savedName; } });
</script>

</body>
</html>
